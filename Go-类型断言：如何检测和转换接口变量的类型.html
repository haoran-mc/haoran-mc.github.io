<!DOCTYPE html>
<html lang="zh">
<head>
<!-- 2022-02-08 Tue 17:39 -->
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>类型断言：如何检测和转换接口变量的类型</title>
<meta name="generator" content="Org mode">
<meta name="author" content="L.M.haoran">
<meta name="description" content="Copyright © 2022, L.M.haoran, all rights reserved."
>

                <link rel="stylesheet" href="static/css/org.css" type="text/css"  />
                <script type="module" src="static/js/main.js" defer></script>
                <link rel="shortcut icon" href="images/favicon.ico" type="image/x-icon" />
</head>
<body>
<div id="content">
<h1 class="title">类型断言：如何检测和转换接口变量的类型</h1>
<p>
一个接口类型的变量 varI 中可以包含任何类型的值，必须有一种方式来检测它的 动态 类型，即运行时在变量中存储的值的实际类型。在执行过程中动态类型可能会有所不同，但是它总是可以分配给接口变量本身的类型。通常我们可以使用 <b>类型断言</b> 来测试在某个时刻 varI 是否包含类型 T 的值：<br>
</p>

<div class="org-src-container">
<pre class="src src-go"><span style="color: #8787d7;">v</span> := varI.(<span style="color: #df005f; font-weight: bold;">T</span>)       <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">unchecked type assertion</span>
</pre>
</div>

<p>
<b>varI 必须是一个接口变量</b> ，否则编译器会报错：invalid type assertion: varI.(T) (non-interface type (type of varI) on left) 。<br>
</p>

<p>
类型断言可能是无效的，虽然编译器会尽力检查转换是否有效，但是它不可能预见所有的可能性。如果转换在程序运行时失败会导致错误发生。更安全的方式是使用以下形式来进行类型断言：<br>
</p>

<div class="org-src-container">
<pre class="src src-go"><span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #8787d7;">v</span>, <span style="color: #8787d7;">ok</span> := varI.(<span style="color: #df005f; font-weight: bold;">T</span>); ok {  <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">checked type assertion</span>
        <span style="color: #d75fd7; font-weight: bold;">Process</span>(v)
        <span style="color: #268bd2; font-weight: bold;">return</span>
}
<span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">varI is not of type T</span>
</pre>
</div>

<p>
如果转换合法，v 是 varI 转换到类型 T 的值，ok 会是 true；否则 v 是类型 T 的零值，ok 是 false，也没有运行时错误发生。<br>
</p>

<p>
应该总是使用上面的方式来进行类型断言。<br>
</p>

<p>
多数情况下，我们可能只是想在 if 中测试一下 ok 的值，此时使用以下的方法会是最方便的：<br>
</p>

<div class="org-src-container">
<pre class="src src-go"><span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #8787d7;">_</span>, <span style="color: #8787d7;">ok</span> := varI.(<span style="color: #df005f; font-weight: bold;">T</span>); ok {
        <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">...</span>
}
</pre>
</div>

<div class="org-src-container">
<pre class="src src-go"><span style="color: #268bd2; font-weight: bold;">package</span> main

<span style="color: #268bd2; font-weight: bold;">import</span> (
        <span style="color: #2aa198;">"fmt"</span>
        <span style="color: #2aa198;">"math"</span>
)

<span style="color: #268bd2; font-weight: bold;">type</span> <span style="color: #df005f; font-weight: bold;">Square</span> <span style="color: #268bd2; font-weight: bold;">struct</span> {
        side <span style="color: #df005f; font-weight: bold;">float32</span>
}

<span style="color: #268bd2; font-weight: bold;">type</span> <span style="color: #df005f; font-weight: bold;">Circle</span> <span style="color: #268bd2; font-weight: bold;">struct</span> {
        radius <span style="color: #df005f; font-weight: bold;">float32</span>
}

<span style="color: #268bd2; font-weight: bold;">type</span> <span style="color: #df005f; font-weight: bold;">Shaper</span> <span style="color: #268bd2; font-weight: bold;">interface</span> {
        <span style="color: #d75fd7; font-weight: bold;">Area</span>() <span style="color: #df005f; font-weight: bold;">float32</span>
}

<span style="color: #268bd2; font-weight: bold;">func</span> <span style="color: #d75fd7; font-weight: bold;">main</span>() {
        <span style="color: #268bd2; font-weight: bold;">var</span> <span style="color: #8787d7;">areaIntf</span> <span style="color: #df005f; font-weight: bold;">Shaper</span>
        <span style="color: #8787d7;">sq1</span> := <span style="color: #268bd2;">new</span>(<span style="color: #df005f; font-weight: bold;">Square</span>)
        sq1.side = <span style="color: #d75fd7;">5</span>

        areaIntf = sq1
        <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">Is Square the type of areaIntf?</span>
        <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #8787d7;">t</span>, <span style="color: #8787d7;">ok</span> := areaIntf.(*<span style="color: #df005f; font-weight: bold;">Square</span>); ok {
                fmt.<span style="color: #d75fd7; font-weight: bold;">Printf</span>(<span style="color: #2aa198;">"The type of areaIntf is: %T\n"</span>, t)
        }
        <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #8787d7;">u</span>, <span style="color: #8787d7;">ok</span> := areaIntf.(*<span style="color: #df005f; font-weight: bold;">Circle</span>); ok {
                fmt.<span style="color: #d75fd7; font-weight: bold;">Printf</span>(<span style="color: #2aa198;">"The type of areaIntf is: %T\n"</span>, u)
        } <span style="color: #268bd2; font-weight: bold;">else</span> {
                fmt.<span style="color: #d75fd7; font-weight: bold;">Println</span>(<span style="color: #2aa198;">"areaIntf does not contain a variable of type Circle"</span>)
        }
}

<span style="color: #268bd2; font-weight: bold;">func</span> (<span style="color: #8787d7;">sq</span> *<span style="color: #df005f; font-weight: bold;">Square</span>) <span style="color: #d75fd7; font-weight: bold;">Area</span>() <span style="color: #df005f; font-weight: bold;">float32</span> {
        <span style="color: #268bd2; font-weight: bold;">return</span> sq.side * sq.side
}

<span style="color: #268bd2; font-weight: bold;">func</span> (<span style="color: #8787d7;">ci</span> *<span style="color: #df005f; font-weight: bold;">Circle</span>) <span style="color: #d75fd7; font-weight: bold;">Area</span>() <span style="color: #df005f; font-weight: bold;">float32</span> {
        <span style="color: #268bd2; font-weight: bold;">return</span> ci.radius * ci.radius * math.Pi
}
</pre>
</div>

<p>
输出：<br>
</p>

<pre class="example" id="org92051fa">
The type of areaIntf is: *main.Square
areaIntf does not contain a variable of type Circle
</pre>

<p>
程序行中定义了一个新类型 Circle，它也实现了 Shaper 接口。 t, ok := areaIntf.(*Square); ok 测试 areaIntf 里是否一个包含 'Square' 类型的变量，结果是确定的；然后我们测试它是否包含一个 'Circle' 类型的变量，结果是否定的。<br>
</p>

<p>
<b>备注</b><br>
</p>

<p>
如果忽略 areaIntf.(*Square) 中的 * 号，会导致编译错误：impossible type assertion: Square does not implement Shaper (Area method has pointer receiver)。<br>
</p>
</div>
<div id="postamble" class="status">
<p class="date">Date: 2022-02-03 16:02 Thu</p>
<p class="author">Author: L.M.haoran</p>
<p class="date">Created: 2022-02-08 Tue 17:39</p>
<p class="validation"><a href="https://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
