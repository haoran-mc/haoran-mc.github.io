<!DOCTYPE html>
<html lang="zh">
<head>
<!-- 2022-05-09 Mon 16:14 -->
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>什么是三次握手</title>
<meta name="generator" content="Org mode">
<meta name="author" content="L.M.haoran">
<meta name="description" content="Copyright © 2022, L.M.haoran, all rights reserved."
>

                <link rel="stylesheet" href="static/css/org.css" type="text/css"  />
                <script type="module" src="static/js/main.js" defer></script>
                <link rel="shortcut icon" href="images/favicon.ico" type="image/x-icon" />
</head>
<body>
<div id="content">
<h1 class="title">什么是三次握手</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#orgb69a7eb">三次握手的过程</a></li>
<li><a href="#org2ea1c73">TCP 建立连接可以两次握手吗？为什么?</a></li>
<li><a href="#org67e3e00">可以采用四次握手吗？为什么？</a></li>
<li><a href="#orga828c0e">第三次握手中，如果客户端的 ACK 未送达服务器，会怎样？</a></li>
<li><a href="#org0d61cac">如果已经建立了连接，但客户端出现了故障怎么办？</a></li>
<li><a href="#orgb37cb27">初始序列号是什么？</a></li>
</ul>
</div>
</div>
<style>
.underline {
		padding-bottom: 1px;
		border-bottom: 2px solid red;
}
</style>

<div id="outline-container-orgb69a7eb" class="outline-2">
<h2 id="orgb69a7eb">三次握手的过程</h2>
<div class="outline-text-2" id="text-orgb69a7eb">
<img src="./images/三次握手.png" width="650px" />

<ul class="org-ul">
<li>第一次握手：Client 的 TCP 首先向 Server 的 TCP 发送一个特殊的 TCP 报文段，进入 <code>SYN_SENT</code> 状态，该报文段中不包含应用层数据。但是 <span class="underline">在报文段的首部中的一个标志位 SYN 被置为 1</span> ，因此，这个特殊报文段被称为 SYN 报文段。 <span class="underline">另外，Client 会随机地选择一个初始序号 seq，并将此编号放置于该起始的 TCP SYN 报文段的序号字段中。</span><br></li>
<li>第二次握手：Server 收到 Client 的 SYN = 1 之后，知道客户端请求建立连接，将自己的 SYN 置 1，产生一个 acknowledge number = sequence number + 1 = <span class="underline">client_isn + 1</span> ，并随机产生一个自己的初始序列号，发送给客户端；进入 <code>SYN_RCVD</code> 状态；<br></li>
<li>第三次握手：客户端检查 acknowledge number 是否为序列号 + 1，检查正确之后也产生一个 acknowledge number = 服务器发的序列号 + 1 = <span class="underline">server_isn + 1</span> ，发送给服务器，进入 <code>ESTABLISHED</code> 状态；服务器检查 acknowledge number 是否为序列号 + 1 之后，也进入 <code>ESTABLISHED</code> 状态；完成三次握手，连接建立。<br></li>
</ul>
</div>
</div>

<div id="outline-container-org2ea1c73" class="outline-2">
<h2 id="org2ea1c73">TCP 建立连接可以两次握手吗？为什么?</h2>
<div class="outline-text-2" id="text-org2ea1c73">
<p>
不可以，有两个原因：<br>
</p>

<p>
首先，可能会出现 <b>已失效的连接请求报文段又传到了服务器端</b> 。<br>
</p>

<p>
client 发出的第一个连接请求报文段并没有丢失，而是在某个网络结点长时间的滞留了，以致延误到连接释放以后的某个时间才到达 server。本来这是一个早已失效的报文段。但 server 收到此失效的连接请求报文段后，就误认为是 client 再次发出的一个新的连接请求。于是就向 client 发出确认报文段，同意建立连接。假设不采用 “三次握手”，那么只要 server 发出确认，新的连接就建立了。由于现在 client 并没有发出建立连接的请求，因此不会理睬 server 的确认，也不会向 server 发送数据。但 server 却以为新的运输连接已经建立，并一直等待 client 发来数据。这样，server 的很多资源就白白浪费掉了。采用 “三次握手” 的办法可以防止上述现象发生。例如刚才那种情况，client 不会向 server 的确认发出确认。server 由于收不到确认，就知道 client 并没有要求建立连接。<br>
</p>

<p>
其次，两次握手无法保证 Client 正确接收第二次握手的报文（Server 无法确认 Client 是否收到），也无法保证 Client 和 Server 之间成功互换初始序列号。<br>
</p>
</div>
</div>
<div id="outline-container-org67e3e00" class="outline-2">
<h2 id="org67e3e00">可以采用四次握手吗？为什么？</h2>
<div class="outline-text-2" id="text-org67e3e00">
<p>
可以，但是会降低传输的效率。<br>
</p>

<p>
四次握手是指：第二次握手：Server 只发送 acknowledge number；而 Server 的 SYN 和初始序列号在第三次握手时发送；原来协议中的第三次握手变为第四次握手。出于优化目的，四次握手中的二、三可以合并。<br>
</p>
</div>
</div>
<div id="outline-container-orga828c0e" class="outline-2">
<h2 id="orga828c0e">第三次握手中，如果客户端的 ACK 未送达服务器，会怎样？</h2>
<div class="outline-text-2" id="text-orga828c0e">
<p>
Server 端：<br>
</p>

<p>
由于 Server 没有收到 ACK 确认，因此会重发之前的 SYN+ACK（默认重发五次，之后自动关闭连接进入 <code>CLOSED</code> 状态），Client 收到后会重新传 ACK 给 Server。<br>
</p>


<p>
Client 端，两种情况：<br>
</p>

<ol class="org-ol">
<li>在 Server 进行超时重发的过程中，如果 Client 向服务器发送数据，数据头部的 ACK 是为 1 的，所以服务器收到数据之后会读取 ACK number，进入 <code>ESTABLISHED</code> 状态<br></li>
<li>在 Server 进入 <code>CLOSED</code> 状态之后，如果 Client 向服务器发送数据，服务器会以 RST 包应答。<br></li>
</ol>
</div>
</div>
<div id="outline-container-org0d61cac" class="outline-2">
<h2 id="org0d61cac">如果已经建立了连接，但客户端出现了故障怎么办？</h2>
<div class="outline-text-2" id="text-org0d61cac">
<p>
服务器每收到一次客户端的请求后都会重新复位一个计时器，时间通常是设置为 2 小时，若两小时还没有收到客户端的任何数据，服务器就会发送一个探测报文段，以后每隔 75 秒钟发送一次。若一连发送 10 个探测报文仍然没反应，服务器就认为客户端出了故障，接着就关闭连接。<br>
</p>
</div>
</div>
<div id="outline-container-orgb37cb27" class="outline-2">
<h2 id="orgb37cb27">初始序列号是什么？</h2>
<div class="outline-text-2" id="text-orgb37cb27">
<p>
TCP 连接的一方 A，随机选择一个 32 位的序列号（Sequence Number）作为发送数据的初始序列号（Initial Sequence Number，ISN），比如为 1000，以该序列号为原点，对要传送的数据进行编号：1001、1002&#x2026;三次握手时，把这个初始序列号传送给另一方 B，以便在传输数据时，B 可以确认什么样的数据编号是合法的；同时在进行数据传输时，A 还可以确认 B 收到的每一个字节，如果 A 收到了 B 的确认编号（acknowledge number）是 2001，就说明编号为 1001-2000 的数据已经被 B 成功接受。<br>
</p>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="date">Date: 2022-03-03 09:03 Thu</p>
<p class="author">Author: L.M.haoran</p>
<p class="date">Created: 2022-05-09 Mon 16:14</p>
<p class="validation"><a href="http://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
