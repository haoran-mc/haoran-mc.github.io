<!DOCTYPE html>
<html lang="zh">
<head>
<!-- 2022-11-25 -->
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>条件语句SELECT</title>
<meta name="author" content="L.M.haoran" />
<meta name="description" content="Copyright © 2022, L.M.haoran, all rights reserved." />
<meta name="generator" content="Org Mode" />
<link rel="shortcut icon" href="images/favicon.ico" type="image/x-icon" />
           <link rel="stylesheet" href="static/css/org.css" type="text/css"  />
           <script type="module" src="static/js/main.js" defer></script>
</head>
<body>
<div id="content" class="content">
<h1 class="title">条件语句SELECT</h1>
<div id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#org3adf674">select 语句</a></li>
<li><a href="#org4569af7">基本用法：</a></li>
<li><a href="#org8187cc2">执行步骤：</a></li>
<li><a href="#org92792d0">案例分析：</a>
<ul>
<li><a href="#org6da2b12">案例一</a></li>
<li><a href="#org54035be">案例二</a></li>
<li><a href="#org588b645">案例三</a></li>
</ul>
</li>
<li><a href="#orgc4b87f3">select 的典型用法</a>
<ul>
<li><a href="#orge921e31">永久阻塞</a></li>
<li><a href="#orgb00fa71">超时判断</a></li>
<li><a href="#org23e5bd1">退出</a></li>
<li><a href="#orgcfe6cac">判断 channel 是否阻塞</a></li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-org3adf674" class="outline-2">
<h2 id="org3adf674">select 语句</h2>
<div class="outline-text-2" id="text-org3adf674">
<p>
首先看一下官方文档的描述：<br>
</p>

<blockquote>
<p>
A "select" statement chooses which of a set of possible send or receive operations will proceed. It looks similar to a "switch" statement but with the cases all referring to communication operations.<br>
</p>

<p>
一个 select 语句用来选择哪个 case 中的发送或接收操作可以被立即执行。它类似于 switch 语句，但是它的 case 涉及到 channel 有关的 IO 操作。<br>
</p>
</blockquote>

<p>
简单来说， <code>select</code> 就是用来监听和 <code>channel</code> 有关的 IO 操作，当 IO 操作发生时，触发相应的动作。<br>
</p>
</div>
</div>
<div id="outline-container-org4569af7" class="outline-2">
<h2 id="org4569af7">基本用法：</h2>
<div class="outline-text-2" id="text-org4569af7">
<div class="org-src-container">
<pre class="src src-go"><span style="color: #606580;">// </span><span style="color: #606580;">select&#22522;&#26412;&#29992;&#27861;</span>
<span style="color: #ffb86c;">select</span> {
<span style="color: #ffb86c;">case</span> &lt;- chan1:
    <span style="color: #606580;">// </span><span style="color: #606580;">&#22914;&#26524; chan1 &#25104;&#21151;&#35835;&#21040;&#25968;&#25454;&#65292;&#21017;&#36827;&#34892;&#35813; case &#22788;&#29702;&#35821;&#21477;</span>
<span style="color: #ffb86c;">case</span> chan2 &lt;- 1:
    <span style="color: #606580;">// </span><span style="color: #606580;">&#22914;&#26524;&#25104;&#21151;&#21521; chan2 &#20889;&#20837;&#25968;&#25454;&#65292;&#21017;&#36827;&#34892;&#35813; case &#22788;&#29702;&#35821;&#21477;</span>
<span style="color: #ffb86c;">default</span>:
    <span style="color: #606580;">// </span><span style="color: #606580;">&#22914;&#26524;&#22312;&#24403;&#21069;&#26102;&#21051;&#19978;&#38754;&#37117;&#27809;&#26377;&#25104;&#21151;&#65292;&#21017;&#31435;&#21363;&#36827;&#20837; default &#22788;&#29702;&#27969;&#31243;&#65292;&#19981;&#20250;&#31561;&#24453;</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-org8187cc2" class="outline-2">
<h2 id="org8187cc2">执行步骤：</h2>
<div class="outline-text-2" id="text-org8187cc2">
<p>
官方的执行步骤：<br>
</p>

<blockquote>
<p>
Execution of a "select" statement proceeds in several steps:<br>
</p>

<ol class="org-ol">
<li>For all the cases in the statement, the channel operands of receive operations and the channel and right-hand-side expressions of send statements are evaluated exactly once, in source order, upon entering the "select" statement. The result is a set of channels to receive from or send to, and the corresponding values to send. Any side effects in that evaluation will occur irrespective of which (if any) communication operation is selected to proceed. Expressions on the left-hand side of a RecvStmt with a short variable declaration or assignment are not yet evaluated.<br>

<ul class="org-ul">
<li>所有channel表达式都会被求值、所有被发送的表达式都会被求值。求值顺序：自上而下、从左到右.<br></li>

<li>结果是选择一个发送或接收的channel，无论选择哪一个case进行操作，表达式都会被执行。RecvStmt左侧短变量声明或赋值未被评估。<br></li>
</ul></li>

<li>If one or more of the communications can proceed, a single one that can proceed is chosen via a uniform pseudo-random selection. Otherwise, if there is a default case, that case is chosen. If there is no default case, the "select" statement blocks until at least one of the communications can proceed.<br>

<ul class="org-ul">
<li>如果有一个或多个IO操作可以完成，则Go运行时系统会随机的选择一个执行，否则的话，如果有default分支，则执行default分支语句，如果连default都没有，则select语句会一直阻塞，直到至少有一个IO操作可以进行.<br></li>
</ul></li>

<li>Unless the selected case is the default case, the respective communication operation is executed.<br>

<ul class="org-ul">
<li>除非所选择的情况是默认情况，否则执行相应的通信操作。<br></li>
</ul></li>

<li>If the selected case is a RecvStmt with a short variable declaration or an assignment, the left-hand side expressions are evaluated and the received value (or values) are assigned.<br>

<ul class="org-ul">
<li>如果所选case是具有短变量声明或赋值的RecvStmt，则评估左侧表达式并分配接收值（或多个值）。<br></li>
</ul></li>

<li>The statement list of the selected case is executed.<br>

<ul class="org-ul">
<li>执行所选case中的语句。<br></li>
</ul></li>
</ol>
</blockquote>
</div>
</div>
<div id="outline-container-org92792d0" class="outline-2">
<h2 id="org92792d0">案例分析：</h2>
<div class="outline-text-2" id="text-org92792d0">
</div>
<div id="outline-container-org6da2b12" class="outline-3">
<h3 id="org6da2b12">案例一</h3>
<div class="outline-text-3" id="text-org6da2b12">
<p>
如果有一个或多个 IO 操作可以完成，则 Go 运行时系统会随机的选择一个执行，否则的话，如果有 <code>default</code> 分支，则执行 <code>default</code> 分支语句，如果连 <code>default</code> 都没有，则 <code>select</code> 语句会一直阻塞，直到至少有一个 IO 操作可以进行。<br>
</p>

<div class="org-src-container">
<pre class="src src-go"><span style="color: #ffb86c;">package</span> main

<span style="color: #ffb86c;">import</span> (
    <span style="color: #f3f99d;">"fmt"</span>
    <span style="color: #f3f99d;">"time"</span>
)

<span style="color: #ffb86c;">func</span> <span style="color: #57c7ff;">main</span>() {
    <span style="color: #ff5c57;">start</span> := time.<span style="color: #57c7ff;">Now</span>()
    <span style="color: #ff5c57;">ch0</span> := <span style="color: #ff6ac1;">make</span>(<span style="color: #ffb86c;">chan</span> <span style="color: #ffb86c;">interface</span>{})
    <span style="color: #ff5c57;">ch1</span> := <span style="color: #ff6ac1;">make</span>(<span style="color: #ffb86c;">chan</span> <span style="color: #9aedfe;">int</span>)
    <span style="color: #ff5c57;">ch2</span> := <span style="color: #ff6ac1;">make</span>(<span style="color: #ffb86c;">chan</span> <span style="color: #9aedfe;">int</span>)

    <span style="color: #ffb86c;">go</span> <span style="color: #ffb86c;">func</span>() {
        time.<span style="color: #57c7ff;">Sleep</span>(4 * time.Second)
        <span style="color: #ff6ac1;">close</span>(ch0)
    }()

    <span style="color: #ffb86c;">go</span> <span style="color: #ffb86c;">func</span>() {
        time.<span style="color: #57c7ff;">Sleep</span>(3 * time.Second)
        ch1 &lt;- 3
    }()

    <span style="color: #ffb86c;">go</span> <span style="color: #ffb86c;">func</span>() {
        time.<span style="color: #57c7ff;">Sleep</span>(3 * time.Second)
        ch2 &lt;- 5
    }()

    fmt.<span style="color: #57c7ff;">Println</span>(<span style="color: #f3f99d;">"Blocking on read..."</span>)
    <span style="color: #ffb86c;">select</span> {
    <span style="color: #ffb86c;">case</span> &lt;- ch0:
        fmt.<span style="color: #57c7ff;">Printf</span>(<span style="color: #f3f99d;">"Unblocked %v later.\n"</span>, time.<span style="color: #57c7ff;">Since</span>(start))
    <span style="color: #ffb86c;">case</span> &lt;- ch1:
        fmt.<span style="color: #57c7ff;">Printf</span>(<span style="color: #f3f99d;">"ch1 case..."</span>)
    <span style="color: #ffb86c;">case</span> &lt;- ch2:
        fmt.<span style="color: #57c7ff;">Printf</span>(<span style="color: #f3f99d;">"ch2 case..."</span>)
    <span style="color: #ffb86c;">default</span>:
        fmt.<span style="color: #57c7ff;">Printf</span>(<span style="color: #f3f99d;">"default go..."</span>)
    }
}
</pre>
</div>

<p>
运行上述代码，由于程序从运行到结束未到 3s，所以程序会走 <code>default</code> 。<br>
</p>

<pre class="example" id="org557be37">
Blocking on read...
default go...
</pre>

<p>
修改代码，将 <code>default</code> 注释：<br>
</p>

<div class="org-src-container">
<pre class="src src-go"><span style="color: #ffb86c;">package</span> main

<span style="color: #ffb86c;">import</span> (
    <span style="color: #f3f99d;">"fmt"</span>
    <span style="color: #f3f99d;">"time"</span>
)

<span style="color: #ffb86c;">func</span> <span style="color: #57c7ff;">main</span>() {
    <span style="color: #ff5c57;">start</span> := time.<span style="color: #57c7ff;">Now</span>()
    <span style="color: #ff5c57;">ch0</span> := <span style="color: #ff6ac1;">make</span>(<span style="color: #ffb86c;">chan</span> <span style="color: #ffb86c;">interface</span>{})
    <span style="color: #ff5c57;">ch1</span> := <span style="color: #ff6ac1;">make</span>(<span style="color: #ffb86c;">chan</span> <span style="color: #9aedfe;">int</span>)
    <span style="color: #ff5c57;">ch2</span> := <span style="color: #ff6ac1;">make</span>(<span style="color: #ffb86c;">chan</span> <span style="color: #9aedfe;">int</span>)

    <span style="color: #ffb86c;">go</span> <span style="color: #ffb86c;">func</span>() {
        time.<span style="color: #57c7ff;">Sleep</span>(4 * time.Second)
        <span style="color: #ff6ac1;">close</span>(ch0)
    }()

    <span style="color: #ffb86c;">go</span> <span style="color: #ffb86c;">func</span>() {
        time.<span style="color: #57c7ff;">Sleep</span>(3 * time.Second)
        ch1 &lt;- 3
    }()

    <span style="color: #ffb86c;">go</span> <span style="color: #ffb86c;">func</span>() {
        time.<span style="color: #57c7ff;">Sleep</span>(3 * time.Second)
        ch2 &lt;- 5
    }()

    fmt.<span style="color: #57c7ff;">Println</span>(<span style="color: #f3f99d;">"Blocking on read..."</span>)
    <span style="color: #ffb86c;">select</span> {
    <span style="color: #ffb86c;">case</span> &lt;- ch0:
        fmt.<span style="color: #57c7ff;">Printf</span>(<span style="color: #f3f99d;">"Unblocked %v later.\n"</span>, time.<span style="color: #57c7ff;">Since</span>(start))
    <span style="color: #ffb86c;">case</span> &lt;- ch1:
        fmt.<span style="color: #57c7ff;">Printf</span>(<span style="color: #f3f99d;">"ch1 case..."</span>)
    <span style="color: #ffb86c;">case</span> &lt;- ch2:
        fmt.<span style="color: #57c7ff;">Printf</span>(<span style="color: #f3f99d;">"ch2 case..."</span>)
    }
}
</pre>
</div>

<p>
这时， <code>select</code> 语句会阻塞，直到检测到一个可以执行的 IO 操作为止。这里会先等待睡眠中的 <code>goroutine</code> ，此时两个 <code>channel</code> 都满足条件，系统会随机选择一个 <code>case</code> 继续操作。<br>
</p>

<pre class="example" id="orgd4bd564">
Blocking on read...
ch2 case...
</pre>

<p>
接着，继续修改代码，将 <code>ch</code> 的 <code>goroutine</code> 休眠时间改为 5s：<br>
</p>

<div class="org-src-container">
<pre class="src src-go"><span style="color: #ffb86c;">package</span> main

<span style="color: #ffb86c;">import</span> (
    <span style="color: #f3f99d;">"fmt"</span>
    <span style="color: #f3f99d;">"time"</span>
)

<span style="color: #ffb86c;">func</span> <span style="color: #57c7ff;">main</span>() {
    <span style="color: #ff5c57;">start</span> := time.<span style="color: #57c7ff;">Now</span>()
    <span style="color: #ff5c57;">ch0</span> := <span style="color: #ff6ac1;">make</span>(<span style="color: #ffb86c;">chan</span> <span style="color: #ffb86c;">interface</span>{})
    <span style="color: #ff5c57;">ch1</span> := <span style="color: #ff6ac1;">make</span>(<span style="color: #ffb86c;">chan</span> <span style="color: #9aedfe;">int</span>)
    <span style="color: #ff5c57;">ch2</span> := <span style="color: #ff6ac1;">make</span>(<span style="color: #ffb86c;">chan</span> <span style="color: #9aedfe;">int</span>)

    <span style="color: #ffb86c;">go</span> <span style="color: #ffb86c;">func</span>() {
        time.<span style="color: #57c7ff;">Sleep</span>(4 * time.Second)
        <span style="color: #ff6ac1;">close</span>(ch0)
    }()

    <span style="color: #ffb86c;">go</span> <span style="color: #ffb86c;">func</span>() {
        time.<span style="color: #57c7ff;">Sleep</span>(5 * time.Second)
        ch1 &lt;- 3
    }()

    <span style="color: #ffb86c;">go</span> <span style="color: #ffb86c;">func</span>() {
        time.<span style="color: #57c7ff;">Sleep</span>(5 * time.Second)
        ch2 &lt;- 5
    }()

    fmt.<span style="color: #57c7ff;">Println</span>(<span style="color: #f3f99d;">"Blocking on read..."</span>)
    <span style="color: #ffb86c;">select</span> {
    <span style="color: #ffb86c;">case</span> &lt;- ch0:
        fmt.<span style="color: #57c7ff;">Printf</span>(<span style="color: #f3f99d;">"Unblocked %v later.\n"</span>, time.<span style="color: #57c7ff;">Since</span>(start))
    <span style="color: #ffb86c;">case</span> &lt;- ch1:
        fmt.<span style="color: #57c7ff;">Printf</span>(<span style="color: #f3f99d;">"ch1 case..."</span>)
    <span style="color: #ffb86c;">case</span> &lt;- ch2:
        fmt.<span style="color: #57c7ff;">Printf</span>(<span style="color: #f3f99d;">"ch2 case..."</span>)
    }
}
</pre>
</div>

<p>
此时会先执行到上面的 <code>goroutine</code> ， <code>select</code> 执行的就是 <code>ch0</code> 的 <code>case</code> 。<br>
</p>

<pre class="example" id="org70c3fdc">
Blocking on read...
Unblocked 4.002915493s later.
</pre>
</div>
</div>
<div id="outline-container-org54035be" class="outline-3">
<h3 id="org54035be">案例二</h3>
<div class="outline-text-3" id="text-org54035be">
<p>
所有 <code>channel</code> 表达式都会被求值，所有被发送的表达式都会被求值，求值顺序：自上而下、自左而右。<br>
</p>

<div class="org-src-container">
<pre class="src src-go"><span style="color: #ffb86c;">package</span> main

<span style="color: #ffb86c;">import</span> <span style="color: #f3f99d;">"fmt"</span>

<span style="color: #ffb86c;">var</span> <span style="color: #ff5c57;">ch1</span> <span style="color: #ffb86c;">chan</span> <span style="color: #ff5c57;">int</span>
<span style="color: #ffb86c;">var</span> <span style="color: #ff5c57;">ch2</span> <span style="color: #ffb86c;">chan</span> <span style="color: #ff5c57;">int</span>
<span style="color: #ffb86c;">var</span> <span style="color: #ff5c57;">chs</span> = []<span style="color: #ffb86c;">chan</span> <span style="color: #9aedfe;">int</span>{ch1, ch2}
<span style="color: #ffb86c;">var</span> <span style="color: #ff5c57;">numbers</span> = []<span style="color: #9aedfe;">int</span>{1, 2, 3, 4, 5}

<span style="color: #ffb86c;">func</span> <span style="color: #57c7ff;">main</span>() {
    <span style="color: #ffb86c;">select</span> {
    <span style="color: #ffb86c;">case</span> <span style="color: #57c7ff;">getChan</span>(0) &lt;- <span style="color: #57c7ff;">getNumber</span>(2):
        fmt.<span style="color: #57c7ff;">Println</span>(<span style="color: #f3f99d;">"1th case is selected."</span>)
    <span style="color: #ffb86c;">case</span> <span style="color: #57c7ff;">getChan</span>(1) &lt;- <span style="color: #57c7ff;">getNumber</span>(3):
        fmt.<span style="color: #57c7ff;">Println</span>(<span style="color: #f3f99d;">"2th case is selected."</span>)
    <span style="color: #ffb86c;">default</span>:
        fmt.<span style="color: #57c7ff;">Println</span>(<span style="color: #f3f99d;">"default!."</span>)
    }
}

<span style="color: #ffb86c;">func</span> <span style="color: #57c7ff;">getNumber</span>(<span style="color: #ff5c57;">i</span> <span style="color: #9aedfe;">int</span>) <span style="color: #9aedfe;">int</span> {
    fmt.<span style="color: #57c7ff;">Printf</span>(<span style="color: #f3f99d;">"numbers[%d]\n"</span>, i)
    <span style="color: #ffb86c;">return</span> numbers[i]
}
<span style="color: #ffb86c;">func</span> <span style="color: #57c7ff;">getChan</span>(<span style="color: #ff5c57;">i</span> <span style="color: #9aedfe;">int</span>) <span style="color: #ffb86c;">chan</span> <span style="color: #9aedfe;">int</span> {
    fmt.<span style="color: #57c7ff;">Printf</span>(<span style="color: #f3f99d;">"chs[%d]\n"</span>, i)
    <span style="color: #ffb86c;">return</span> chs[i]
}
</pre>
</div>

<p>
此时， <code>select</code> 语句走的是 <code>default</code> 操作。但是这时每个 <code>case</code> 的表达式都会被执行。以 <code>case1</code> 为例：<br>
</p>

<div class="org-src-container">
<pre class="src src-go"><span style="color: #ffb86c;">case</span> <span style="color: #57c7ff;">getChan</span>(0) &lt;- <span style="color: #57c7ff;">getNumber</span>(2):
</pre>
</div>

<p>
系统会从左到右先执行 <code>getChan</code> 函数打印 <code>chs[0]</code> ，然后执行 <code>getNumber</code> 函数打印 <code>numbers[2]</code> 。同样，从上到下分别执行所有 <code>case</code> 的语句。所以，程序执行的结果为：<br>
</p>

<pre class="example" id="org2e1c157">
chs[0]
numbers[2]
chs[1]
numbers[3]
default!.
</pre>
</div>
</div>
<div id="outline-container-org588b645" class="outline-3">
<h3 id="org588b645">案例三</h3>
<div class="outline-text-3" id="text-org588b645">
<p>
使用 <code>break</code> 关键字结束 <code>select</code> 。<br>
</p>

<div class="org-src-container">
<pre class="src src-go"><span style="color: #ffb86c;">package</span> main

<span style="color: #ffb86c;">import</span> <span style="color: #f3f99d;">"fmt"</span>

<span style="color: #ffb86c;">func</span> <span style="color: #57c7ff;">main</span>() {
    <span style="color: #ff5c57;">ch1</span> := <span style="color: #ff6ac1;">make</span>(<span style="color: #ffb86c;">chan</span> <span style="color: #9aedfe;">int</span>, 1)
    <span style="color: #ff5c57;">ch2</span> := <span style="color: #ff6ac1;">make</span>(<span style="color: #ffb86c;">chan</span> <span style="color: #9aedfe;">int</span>, 1)

    ch1 &lt;- 3
    ch2 &lt;- 5

    <span style="color: #ffb86c;">select</span> {
    <span style="color: #ffb86c;">case</span> &lt;-ch1:
        fmt.<span style="color: #57c7ff;">Println</span>(<span style="color: #f3f99d;">"ch1 selected."</span>)
        <span style="color: #ffb86c;">break</span>
        fmt.<span style="color: #57c7ff;">Println</span>(<span style="color: #f3f99d;">"ch1 selected after break"</span>)
    <span style="color: #ffb86c;">case</span> &lt;-ch2:
        fmt.<span style="color: #57c7ff;">Println</span>(<span style="color: #f3f99d;">"ch2 selected."</span>)
        fmt.<span style="color: #57c7ff;">Println</span>(<span style="color: #f3f99d;">"ch2 selected without break"</span>)
    }
}
</pre>
</div>

<p>
很明显， <code>ch1</code> 和 <code>ch2</code> 两个通道都可以读取到值，所以系统会随机选择一个 <code>case</code> 执行。我们发现选择执行 <code>ch1</code> 的 <code>case</code> 时，由于有 <code>break</code> 关键字只执行了一句：<br>
</p>

<pre class="example" id="org8937eac">
ch1 selected.
</pre>

<p>
但是，当系统选择 <code>ch2</code> 的 <code>case</code> 时，打印结果为：<br>
</p>

<pre class="example" id="org729de0a">
ch2 selected.
ch2 selected without break
</pre>

<p>
如此就显而易见， <code>break</code> 关键字在 <code>select</code> 中的作用。<br>
</p>
</div>
</div>
</div>
<div id="outline-container-orgc4b87f3" class="outline-2">
<h2 id="orgc4b87f3">select 的典型用法</h2>
<div class="outline-text-2" id="text-orgc4b87f3">
</div>
<div id="outline-container-orge921e31" class="outline-3">
<h3 id="orge921e31">永久阻塞</h3>
<div class="outline-text-3" id="text-orge921e31">
<div class="org-src-container">
<pre class="src src-go"><span style="color: #ffb86c;">go</span> <span style="color: #ffb86c;">func</span>() {
    <span style="color: #ffb86c;">select</span>{}
}
</pre>
</div>

<p>
这样，当前 goroutine 将不会结束。<br>
</p>
</div>
</div>
<div id="outline-container-orgb00fa71" class="outline-3">
<h3 id="orgb00fa71">超时判断</h3>
<div class="outline-text-3" id="text-orgb00fa71">
<div class="org-src-container">
<pre class="src src-go"><span style="color: #606580;">// </span><span style="color: #606580;">&#27604;&#22914;&#22312;&#19979;&#38754;&#30340;&#22330;&#26223;&#20013;&#65292;&#20351;&#29992;&#20840;&#23616; resChan &#26469;&#25509;&#21463; response</span>
<span style="color: #606580;">// </span><span style="color: #606580;">&#22914;&#26524;&#26102;&#38388;&#36229;&#36807;3S&#65292;resChan&#20013;&#36824;&#27809;&#26377;&#25968;&#25454;&#36820;&#22238;&#65292;&#21017;&#31532;&#20108;&#26465;case&#23558;&#25191;&#34892;</span>
<span style="color: #ffb86c;">var</span> <span style="color: #ff5c57;">resChan</span> = <span style="color: #ff6ac1;">make</span>(<span style="color: #ffb86c;">chan</span> <span style="color: #9aedfe;">int</span>)

<span style="color: #ffb86c;">func</span> <span style="color: #57c7ff;">test</span>() {
    <span style="color: #ffb86c;">select</span> {
    <span style="color: #ffb86c;">case</span> <span style="color: #ff5c57;">data</span> := &lt;- resChan:
        fmt.<span style="color: #57c7ff;">Println</span>(data)
    <span style="color: #ffb86c;">case</span> &lt;- time.<span style="color: #57c7ff;">After</span>(time.Second * 3):
        fmt.<span style="color: #57c7ff;">Println</span>(<span style="color: #f3f99d;">"request time out"</span>)
    }
}
</pre>
</div>
</div>
</div>
<div id="outline-container-org23e5bd1" class="outline-3">
<h3 id="org23e5bd1">退出</h3>
<div class="outline-text-3" id="text-org23e5bd1">
<p>
在 <code>fibonacci</code> 函数中，一个死循环中包含一个 <code>select</code> ，也就是意味着，每次当 <code>c</code> 通道的事件被接收一次，此时通道就允许发送一个新事件，对应的 <code>case</code> 代码块就运行一次，直到 <code>quit</code> 有了新的事件，此时退出死循环。<br>
</p>

<p>
在 <code>main</code> 函数中启动了一个独立的 goroutine 来运行匿名函数，这个匿名函数接收 10 次 <code>c</code> 通道的事件，导致 <code>fibonacci</code> 函数的第一个 <code>case</code> 条件触发了 10 次，然后，匿名函数向 <code>quit</code> 通道发送了一个事件，从而结束掉 <code>fibonacci</code> 的死循环，此时 <code>main</code> 函数也结束了。<br>
</p>

<div class="org-src-container">
<pre class="src src-go"><span style="color: #ffb86c;">func</span> <span style="color: #57c7ff;">fibonacci</span>(<span style="color: #ff5c57;">c</span>, <span style="color: #ff5c57;">quit</span> <span style="color: #ffb86c;">chan</span> <span style="color: #9aedfe;">int</span>) {
    <span style="color: #ff5c57;">x</span>, <span style="color: #ff5c57;">y</span> := 0, 1
    <span style="color: #ffb86c;">for</span> {
        <span style="color: #ffb86c;">select</span> {
        <span style="color: #ffb86c;">case</span> c &lt;- x:
            x, y = y, x+y
        <span style="color: #ffb86c;">case</span> &lt;-quit:
            fmt.<span style="color: #57c7ff;">Println</span>(<span style="color: #f3f99d;">"quit"</span>)
            <span style="color: #ffb86c;">return</span>
        }
    }
}

<span style="color: #ffb86c;">func</span> <span style="color: #57c7ff;">main</span>() {
    <span style="color: #ff5c57;">c</span> := <span style="color: #ff6ac1;">make</span>(<span style="color: #ffb86c;">chan</span> <span style="color: #9aedfe;">int</span>)
    <span style="color: #ff5c57;">quit</span> := <span style="color: #ff6ac1;">make</span>(<span style="color: #ffb86c;">chan</span> <span style="color: #9aedfe;">int</span>)
    <span style="color: #ffb86c;">go</span> <span style="color: #ffb86c;">func</span>() {
        <span style="color: #ffb86c;">for</span> <span style="color: #ff5c57;">i</span> := 0; i &lt; 10; i++ {
            fmt.<span style="color: #57c7ff;">Println</span>(&lt;-c)
        }
        quit &lt;- 0
    }()
    <span style="color: #57c7ff;">fibonacci</span>(c, quit)
}
</pre>
</div>
</div>
</div>
<div id="outline-container-orgcfe6cac" class="outline-3">
<h3 id="orgcfe6cac">判断 channel 是否阻塞</h3>
<div class="outline-text-3" id="text-orgcfe6cac">
<div class="org-src-container">
<pre class="src src-go"><span style="color: #606580;">// </span><span style="color: #606580;">&#22312;&#26576;&#20123;&#24773;&#20917;&#19979;&#26159;&#23384;&#22312;&#19981;&#24076;&#26395; channel &#32531;&#23384;&#28385;&#20102;&#30340;&#38656;&#27714;&#30340;&#65292;&#21487;&#20197;&#29992;&#22914;&#19979;&#26041;&#27861;&#21028;&#26029;</span>
<span style="color: #ff5c57;">ch</span> := <span style="color: #ff6ac1;">make</span>(<span style="color: #ffb86c;">chan</span> <span style="color: #9aedfe;">int</span>, 5)
<span style="color: #ff5c57;">data</span> := 0
<span style="color: #ffb86c;">select</span> {
<span style="color: #ffb86c;">case</span> ch &lt;- data:
<span style="color: #ffb86c;">default</span>:
    <span style="color: #606580;">// </span><span style="color: #606580;">&#20570;&#30456;&#24212;&#25805;&#20316;&#65292;&#27604;&#22914;&#20002;&#24323; data&#12290;&#35270;&#38656;&#27714;&#32780;&#23450;</span>
}
</pre>
</div>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="date">Date: 2022-02-07 23:02 Mon</p>
<p class="author">Author: L.M.haoran</p>
<p class="date">Created: 2022-11-25</p>
<p class="validation"><a href="https://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
