<!DOCTYPE html>
<html lang="zh">
<head>
<!-- 2021-12-08 Wed 20:03 -->
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>DOCKER COMPOSE</title>
<meta name="generator" content="Org mode">
<meta name="author" content="L.M.haoran">
<meta name="description" content="Copyright © 2021, L.M.haoran, all rights reserved."
>

                <link rel="stylesheet" href="static/css/org.css" type="text/css"  />
                <script type="module" src="static/js/main.js" defer></script>
                <link rel="shortcut icon" href="images/favicon.ico" type="image/x-icon" />
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        displayAlign: "center",
        displayIndent: "0em",

        "HTML-CSS": { scale: 100,
                        linebreaks: { automatic: "false" },
                        webFont: "TeX"
                       },
        SVG: {scale: 100,
              linebreaks: { automatic: "false" },
              font: "TeX"},
        NativeMML: {scale: 100},
        TeX: { equationNumbers: {autoNumber: "AMS"},
               MultLineWidth: "85%",
               TagSide: "right",
               TagIndent: ".8em"
             }
});
</script>
<script type="text/javascript"
        src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS_HTML"></script>
</head>
<body>
<div id="content">
<h1 class="title">DOCKER COMPOSE</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org1fc82e8">什么是 Docker Compose</a></li>
<li><a href="#orgb9374d6">安装 Docker Compose</a></li>
<li><a href="#orga8616fa">Getting started</a>
<ul>
<li><a href="#org0180ba8">Step 1: Set up</a></li>
<li><a href="#org4953732">Step 2: Create a Dockerfile</a></li>
<li><a href="#orgabff090">Step 3: Define services in a Compose file</a></li>
<li><a href="#org310cf85">Step 4: Build and run your app with Compose</a></li>
<li><a href="#orge16c0a8">Step 5: Edit the Compose file to add a bind mount</a></li>
<li><a href="#org96af16b">Step 6: Re-build and run the app with Compose</a></li>
<li><a href="#orgc17725d">Step 7: Update the application</a></li>
<li><a href="#org258a4f2">Step 8: Experiment with some other commands</a></li>
</ul>
</li>
<li><a href="#org27506d8">yaml 规则</a>
<ul>
<li><a href="#org6187e29">有关 docker compose 的 yaml 规则：</a></li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-org1fc82e8" class="outline-2">
<h2 id="org1fc82e8">什么是 Docker Compose</h2>
<div class="outline-text-2" id="text-org1fc82e8">
<p>
Compose 是用于定义和运行多容器 Docker 应用程序的工具。通过 Compose，您可以使用 <a href="YAML.html">YML</a> 文件来配置应用程序需要的所有服务。然后，使用一个命令，就可以从 YML 文件配置中创建并启动所有服务。<br>
</p>
</div>
</div>
<div id="outline-container-orgb9374d6" class="outline-2">
<h2 id="orgb9374d6">安装 Docker Compose</h2>
<div class="outline-text-2" id="text-orgb9374d6">
<dl class="org-dl">
<dt>官网有安装步骤</dt><dd><a href="https://docs.docker.com/compose/install/">https://docs.docker.com/compose/install/</a><br></dd>
</dl>

<p>
对于 Linux 来说就两条命令：<br>
</p>

<dl class="org-dl">
<dt>sudo curl -L "<a href="https://github.com/docker/compose/releases/download/1.29.2/docker-compose">https://github.com/docker/compose/releases/download/1.29.2/docker-compose</a>-\((uname -s)-\)(uname -m)" -o /usr/local/bin/docker-compose</dt><dd>下载 docker-compose 到 /usr/local/bin/docker-compose<br></dd>
<dt>sudo chmod +x /usr/local/bin/docker-compose</dt><dd>赋予运行权限<br></dd>
<dt>docker-compose &#x2013;version</dt><dd>查看是否安装成功<br></dd>
</dl>
</div>
</div>
<div id="outline-container-orga8616fa" class="outline-2">
<h2 id="orga8616fa">Getting started</h2>
<div class="outline-text-2" id="text-orga8616fa">
<dl class="org-dl">
<dt>官网</dt><dd><a href="https://docs.docker.com/compose/gettingstarted/">https://docs.docker.com/compose/gettingstarted/</a><br></dd>
</dl>

<p>
官网有一个关于 python web 的应用程序。这个应用程序使用 Flask 框架并在 Redis 中维护一个命中计数器，这里不要求配置 python 与 Redis 环境，你也不需要懂得 python 与 redis。<br>
</p>
</div>
<div id="outline-container-org0180ba8" class="outline-3">
<h3 id="org0180ba8">Step 1: Set up</h3>
<div class="outline-text-3" id="text-org0180ba8">
<ol class="org-ol">
<li><p>
创建一个项目目录<br>
</p>

<div class="org-src-container">
<pre class="src src-shell">$ mkdir composetest
$ cd composetest
</pre>
</div></li>
<li><p>
创建一个名为 <code>app.py</code> 的文件，文件内容如下：<br>
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #BD93F9;">import</span> time

<span style="color: #BD93F9;">import</span> redis
<span style="color: #BD93F9;">from</span> flask <span style="color: #BD93F9;">import</span> Flask

<span style="color: #AFAFAF;">app</span> = Flask(<span style="color: #AFAFAF;">__name__</span>)
<span style="color: #AFAFAF;">cache</span> = redis.Redis(host=<span style="color: #FC9F4E;">'redis'</span>, port=<span style="color: #009F9F;">6379</span>)

<span style="color: #BD93F9;">def</span> <span style="color: #AFAFAF;">get_hit_count</span>():
        <span style="color: #AFAFAF;">retries</span> = <span style="color: #009F9F;">5</span>
        <span style="color: #BD93F9;">while</span> <span style="color: #009F9F;">True</span>:
                <span style="color: #BD93F9;">try</span>:
                        <span style="color: #BD93F9;">return</span> cache.incr(<span style="color: #FC9F4E;">'hits'</span>)
                <span style="color: #BD93F9;">except</span> redis.exceptions.<span style="color: #AFAFAF;">ConnectionError</span> <span style="color: #BD93F9;">as</span> exc:
                        <span style="color: #BD93F9;">if</span> retries == <span style="color: #009F9F;">0</span>:
                                <span style="color: #BD93F9;">raise</span> exc
                        <span style="color: #AFAFAF;">retries</span> -= <span style="color: #009F9F;">1</span>
                        time.sleep(<span style="color: #009F9F;">0</span>.<span style="color: #009F9F;">5</span>)

<span style="color: #AFAFAF;">@app.route</span>(<span style="color: #FC9F4E;">'/'</span>)
<span style="color: #BD93F9;">def</span> <span style="color: #AFAFAF;">hello</span>():
        <span style="color: #AFAFAF;">count</span> = get_hit_count()
        <span style="color: #BD93F9;">return</span> <span style="color: #FC9F4E;">'Hello World! I have been seen {} times.\n'</span>.<span style="color: #AFAFAF;">format</span>(count)
</pre>
</div></li>
<li><p>
创建一个名为 <code>requirements.txt</code> 文件，文件内容如下：<br>
</p>
<div class="org-src-container">
<pre class="src src-txt">flask
redis
</pre>
</div></li>
</ol>
</div>
</div>
<div id="outline-container-org4953732" class="outline-3">
<h3 id="org4953732">Step 2: Create a Dockerfile</h3>
<div class="outline-text-3" id="text-org4953732">
<p>
在这一步，我们创建一个 Dockerfile 文件，利用这个 Dockerfile 文件来创建镜像：<br>
</p>

<pre class="example" id="org6aa836c">
# syntax=docker/dockerfile:1
FROM python:3.7-alpine         # 以 python3.7 开始创建这个镜像
WORKDIR /code                  # 规定 /code 是工作目录
ENV FLASK_APP=app.py           # 使用 flask 命令来建立环境
ENV FLASK_RUN_HOST=0.0.0.0
RUN apk add --no-cache gcc musl-dev linux-headers   # 下载 gcc 以及其他依赖
COPY requirements.txt requirements.txt              # 复制宿主机中的 requirements.txt 文件到 docker 容器中
RUN pip install -r requirements.txt                 # 通过下载 requirements.txt 中的 python 依赖
EXPOSE 5000                    # 暴露端口
COPY . .                       # 复制宿主机当前目录下的项目到容器中
CMD ["flask", "run"]           # 在容器中运行 "flask run" 这条命令
</pre>
</div>
</div>
<div id="outline-container-orgabff090" class="outline-3">
<h3 id="orgabff090">Step 3: Define services in a Compose file</h3>
<div class="outline-text-3" id="text-orgabff090">
<p>
创建一个 <code>docker-compose.yml</code> 文件，文件内容如下：<br>
</p>

<pre class="example" id="org7fd6159">
version: "3.9"
services:
	web:
		build: .
		ports:
			- "5000:5000"
	redis:
		image: "redis:alpine"
</pre>

<p>
在这个 compose 文件中，我们定义了两个服务：<br>
</p>

<ol class="org-ol">
<li>Web service<br>
web 服务使用的是我们自己通过 Dockerfile 构建的镜像，暴露的端口也是 Flask 的默认端口：5000。<br></li>

<li>Redis service<br>
redis 服务使用的是从仓库中拉取的官方镜像。<br></li>
</ol>
</div>
</div>
<div id="outline-container-org310cf85" class="outline-3">
<h3 id="org310cf85">Step 4: Build and run your app with Compose</h3>
<div class="outline-text-3" id="text-org310cf85">
<ol class="org-ol">
<li><p>
运行命令： <code>docker-compose up</code><br>
</p>

<div class="org-src-container">
<pre class="src src-shell">docker-compose up
</pre>
</div></li>

<li><p>
查看 <code>http://localhost:5000</code><br>
</p>

<img src="./images/docker-compose-01.png" /></li>

<li><p>
刷新页面，数字会增加1。<br>
</p>

<img src="./images/docker-compose-02.png" /></li>

<li><p>
docker images：查看镜像数量<br>
</p>

<img src="./images/docker-compose-03.png" /></li>
</ol>
</div>
</div>
<div id="outline-container-orge16c0a8" class="outline-3">
<h3 id="orge16c0a8">Step 5: Edit the Compose file to add a bind mount</h3>
<div class="outline-text-3" id="text-orge16c0a8">
<p>
重新编写 Compose 文件，添加数据卷，允许在宿主机中工作。<br>
</p>

<pre class="example" id="orgb12eb48">
version: "3.9"
services:
	web:
		build: .
		ports:
			- "5000:5000"
		volumes:
			- .:/code
		environment:
			FLASK_ENV: development
	redis:
		image: "redis:alpine"
</pre>
</div>
</div>
<div id="outline-container-org96af16b" class="outline-3">
<h3 id="org96af16b">Step 6: Re-build and run the app with Compose</h3>
<div class="outline-text-3" id="text-org96af16b">
<p>
<code>docker-compose up</code> ，重新运行。<br>
</p>
</div>
</div>
<div id="outline-container-orgc17725d" class="outline-3">
<h3 id="orgc17725d">Step 7: Update the application</h3>
<div class="outline-text-3" id="text-orgc17725d">
<p>
由于现在使用卷将应用程序代码挂载到容器中，因此您可以对其代码进行更改并立即看到更改，而无需重新构建映像。<br>
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #BD93F9;">import</span> time

<span style="color: #BD93F9;">import</span> redis
<span style="color: #BD93F9;">from</span> flask <span style="color: #BD93F9;">import</span> Flask

<span style="color: #AFAFAF;">app</span> = Flask(<span style="color: #AFAFAF;">__name__</span>)
<span style="color: #AFAFAF;">cache</span> = redis.Redis(host=<span style="color: #FC9F4E;">'redis'</span>, port=<span style="color: #009F9F;">6379</span>)

<span style="color: #BD93F9;">def</span> <span style="color: #AFAFAF;">get_hit_count</span>():
        <span style="color: #AFAFAF;">retries</span> = <span style="color: #009F9F;">5</span>
        <span style="color: #BD93F9;">while</span> <span style="color: #009F9F;">True</span>:
                <span style="color: #BD93F9;">try</span>:
                        <span style="color: #BD93F9;">return</span> cache.incr(<span style="color: #FC9F4E;">'hits'</span>)
                <span style="color: #BD93F9;">except</span> redis.exceptions.<span style="color: #AFAFAF;">ConnectionError</span> <span style="color: #BD93F9;">as</span> exc:
                        <span style="color: #BD93F9;">if</span> retries == <span style="color: #009F9F;">0</span>:
                                <span style="color: #BD93F9;">raise</span> exc
                        <span style="color: #AFAFAF;">retries</span> -= <span style="color: #009F9F;">1</span>
                        time.sleep(<span style="color: #009F9F;">0</span>.<span style="color: #009F9F;">5</span>)

<span style="color: #AFAFAF;">@app.route</span>(<span style="color: #FC9F4E;">'/'</span>)
<span style="color: #BD93F9;">def</span> <span style="color: #AFAFAF;">hello</span>():
        <span style="color: #AFAFAF;">count</span> = get_hit_count()
        <span style="color: #7c7c7c; font-style: italic;">#  </span><span style="color: #7c7c7c; font-style: italic;">return 'Hello World! I have been seen {} times.\n'.format(count)</span>
        <span style="color: #BD93F9;">return</span> <span style="color: #FC9F4E;">'Hello from Docker! I have been seen {} times.\n'</span>.<span style="color: #AFAFAF;">format</span>(count)
</pre>
</div>

<img src="./images/docker-compose-04.png" />
</div>
</div>
<div id="outline-container-org258a4f2" class="outline-3">
<h3 id="org258a4f2">Step 8: Experiment with some other commands</h3>
<div class="outline-text-3" id="text-org258a4f2">
<dl class="org-dl">
<dt>docker-compose up -d</dt><dd>在后台运行<br></dd>
<dt>docker-compose ps</dt><dd>查看运行中的 docker compose<br></dd>
<dt>docker-compose stop</dt><dd>停止 docker compose<br></dd>
<dt>docker-compose down &#x2013;volumes</dt><dd>使用 down 命令删除所有内容，完全删除容器。——volumes 可以删除容器使用的数据卷<br></dd>
</dl>
</div>
</div>
</div>

<div id="outline-container-org27506d8" class="outline-2">
<h2 id="org27506d8">yaml 规则</h2>
<div class="outline-text-2" id="text-org27506d8">
<ul class="org-ul">
<li><a href="YAML.html">YAML</a><br></li>
</ul>
</div>
<div id="outline-container-org6187e29" class="outline-3">
<h3 id="org6187e29">有关 docker compose 的 yaml 规则：</h3>
<div class="outline-text-3" id="text-org6187e29">
<ul class="org-ul">
<li>docker compose 的 yaml 有且只有 3 层<br>
<ol class="org-ol">
<li>version：版本<br></li>
<li>services：服务<br></li>
<li>其他：<br>
<ul class="org-ul">
<li>volumes<br></li>
<li>networks<br></li>
<li>configs<br></li>
</ul></li>
</ol></li>
</ul>

<p>
更多的配置参考看这里：<a href="https://docs.docker.com/compose/compose-file/compose-file-v3/#service-configuration-reference">https://docs.docker.com/compose/compose-file/compose-file-v3/#service-configuration-reference</a><br>
</p>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="date">Date: 2021-12-08 14:12 Wed</p>
<p class="author">Author: L.M.haoran</p>
<p class="date">Created: 2021-12-08 Wed 20:03</p>
<p class="validation"><a href="https://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
