<!DOCTYPE html>
<html lang="zh">
<head>
<!-- 2022-06-24 Fri 21:19 -->
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>socket编程系列</title>
<meta name="generator" content="Org mode">
<meta name="author" content="L.M.haoran">
<meta name="description" content="Copyright © 2022, L.M.haoran, all rights reserved."
>

                <link rel="stylesheet" href="static/css/org.css" type="text/css"  />
                <script type="module" src="static/js/main.js" defer></script>
                <link rel="shortcut icon" href="images/favicon.ico" type="image/x-icon" />
</head>
<body>
<div id="content">
<h1 class="title">socket编程系列</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org8746b24">常用方法介绍</a>
<ul>
<li><a href="#orgf19a641">type TCPAddr</a>
<ul>
<li><a href="#orgaee92d9">func ResolveTCPAddr</a></li>
</ul>
</li>
<li><a href="#org5c70d57">type TCPListener</a>
<ul>
<li><a href="#orgd2517cd">func ListenTCP</a></li>
<li><a href="#orgaabe021">func (*TCPListener) Addr</a></li>
<li><a href="#org6a9ed55">func (*TCPListener) SetDeadline</a></li>
<li><a href="#org1ac6072">func (*TCPListener) Accept</a></li>
<li><a href="#org55b5315">func (*TCPListener) AcceptTCP</a></li>
<li><a href="#org9dda406">func (*TCPListener) Close</a></li>
<li><a href="#org8560269">func (*TCPListener) File</a></li>
</ul>
</li>
<li><a href="#orgba5241a">type TCPConn</a>
<ul>
<li><a href="#orgb10cdab">func DialTCP</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-org8746b24" class="outline-2">
<h2 id="org8746b24">常用方法介绍</h2>
<div class="outline-text-2" id="text-org8746b24">
</div>
<div id="outline-container-orgf19a641" class="outline-3">
<h3 id="orgf19a641">type TCPAddr</h3>
<div class="outline-text-3" id="text-orgf19a641">
<p>
TCPAddr 是一个包含 IP 和 port 的 <code>struct</code> ，其定义在 tcpsock.go 文件中。<br>
</p>

<div class="org-src-container">
<pre class="src src-go"><span style="color: #268bd2; font-weight: bold;">type</span> <span style="color: #df005f; font-weight: bold;">TCPAddr</span> <span style="color: #268bd2; font-weight: bold;">struct</span> {
    IP   <span style="color: #df005f; font-weight: bold;">IP</span>
    Port <span style="color: #df005f; font-weight: bold;">int</span>
    Zone <span style="color: #df005f; font-weight: bold;">string</span> <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">IPv6&#33539;&#22260;&#23547;&#22336;&#22495;</span>
}
</pre>
</div>

<p>
常用的方法有：<br>
</p>
</div>
<div id="outline-container-orgaee92d9" class="outline-4">
<h4 id="orgaee92d9">func ResolveTCPAddr</h4>
<div class="outline-text-4" id="text-orgaee92d9">
<div class="org-src-container">
<pre class="src src-go"><span style="color: #268bd2; font-weight: bold;">func</span> <span style="color: #d75fd7; font-weight: bold;">ResolveTCPAddr</span>(<span style="color: #8787d7;">net</span>, <span style="color: #8787d7;">addr</span> <span style="color: #df005f; font-weight: bold;">string</span>) (*<span style="color: #df005f; font-weight: bold;">TCPAddr</span>, <span style="color: #df005f; font-weight: bold;">error</span>)
</pre>
</div>

<p>
通过输入 net 和 addr 来创建一个 TCPAddr。<br>
</p>

<ul class="org-ul">
<li><code>net</code> 为 <code>tcp</code> 、 <code>tcp4</code> 、 <code>tcp6</code> 的一种，默认是 <code>tcp</code> ；<br></li>
<li><code>addr</code> 是类似 "google.com:80" 或者 "127.0.0.1:80" 的字符串；<br></li>
</ul>

<p>
如何使用 <code>ResolveTCPAddr</code> ：<br>
</p>

<div class="org-src-container">
<pre class="src src-go"><span style="color: #268bd2; font-weight: bold;">package</span> main

<span style="color: #268bd2; font-weight: bold;">import</span> (
    <span style="color: #2aa198;">"fmt"</span>
    <span style="color: #2aa198;">"net"</span>
)

<span style="color: #268bd2; font-weight: bold;">func</span> <span style="color: #d75fd7; font-weight: bold;">main</span>() {
    <span style="color: #8787d7;">addr</span> := <span style="color: #2aa198;">"www.baidu.com:80"</span>
    <span style="color: #8787d7;">tcpaddr</span>, <span style="color: #8787d7;">_</span> := net.<span style="color: #d75fd7; font-weight: bold;">ResolveTCPAddr</span>(<span style="color: #2aa198;">"tcp"</span>, addr) <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">&#19982;&#30334;&#24230;&#24314;&#31435; TCP &#36830;&#25509;</span>

    fmt.<span style="color: #d75fd7; font-weight: bold;">Println</span>(<span style="color: #2aa198;">"tcpaddr: "</span>, tcpaddr) <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">&#36825;&#20010;&#24314;&#31435;&#30340;&#36830;&#25509;&#26159;&#20160;&#20040;&#65311;</span>

    <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">&#21487;&#20197;&#36890;&#36807; tcpaddr &#25343;&#21040; ip:port</span>
    fmt.<span style="color: #d75fd7; font-weight: bold;">Println</span>(<span style="color: #2aa198;">"IP: "</span>, tcpaddr.IP.<span style="color: #d75fd7; font-weight: bold;">String</span>())
    fmt.<span style="color: #d75fd7; font-weight: bold;">Println</span>(<span style="color: #2aa198;">"Port: "</span>, tcpaddr.Port)

    <span style="color: #008787; background-color: #262626;">/*</span>
<span style="color: #008787; background-color: #262626;">        fmt.Printf("typeof(addr): %T\n", addr)</span>
<span style="color: #008787; background-color: #262626;">        fmt.Printf("typeof(tcpaddr): %T\n", tcpaddr)</span>
<span style="color: #008787; background-color: #262626;">        fmt.Println("sizeof(addr): ", unsafe.Sizeof(addr))</span>
<span style="color: #008787; background-color: #262626;">        fmt.Println("sizeof(tcpaddr): ", unsafe.Sizeof(tcpaddr))</span>
<span style="color: #008787; background-color: #262626;">        fmt.Println("len(addr): ", len(addr))</span>
<span style="color: #008787; background-color: #262626;">        fmt.Println("len(tcpaddr): ", len(tcpaddr.String()))</span>
<span style="color: #008787; background-color: #262626;">    */</span>
}
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org5c70d57" class="outline-3">
<h3 id="org5c70d57">type TCPListener</h3>
<div class="outline-text-3" id="text-org5c70d57">
<div class="org-src-container">
<pre class="src src-go"><span style="color: #268bd2; font-weight: bold;">type</span> <span style="color: #df005f; font-weight: bold;">TCPListener</span> <span style="color: #268bd2; font-weight: bold;">struct</span> {
    <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">&#20869;&#21547;&#38544;&#34255;&#25110;&#38750;&#23548;&#20986;&#23383;&#27573;</span>
}
</pre>
</div>

<p>
TCPListener 代表一个 TCP 网络的监听者。使用者应尽量使用 Listener 接口而不是假设（网络连接为）TCP。<br>
</p>

<p>
TCPListener 通常在服务端监听客户端发来的请求。其类型定义在 tcpsock.go 文件中。其本质是个网络文件描述符，与 TCPConn 类型一样。<br>
</p>
</div>
<div id="outline-container-orgd2517cd" class="outline-4">
<h4 id="orgd2517cd">func ListenTCP</h4>
<div class="outline-text-4" id="text-orgd2517cd">
<div class="org-src-container">
<pre class="src src-go"><span style="color: #268bd2; font-weight: bold;">func</span> <span style="color: #d75fd7; font-weight: bold;">ListenTCP</span>(<span style="color: #8787d7;">net</span> <span style="color: #df005f; font-weight: bold;">string</span>, <span style="color: #8787d7;">laddr</span> *<span style="color: #df005f; font-weight: bold;">TCPAddr</span>) (*<span style="color: #df005f; font-weight: bold;">TCPListener</span>, <span style="color: #df005f; font-weight: bold;">error</span>)
</pre>
</div>

<ul class="org-ul">
<li><code>net</code> 为 <code>tcp</code> 、 <code>tcp4</code> 、 <code>tcp6</code> 的一种；<br></li>
<li><code>laddr</code> 为本机需要监听的 ip 和 port，如果为 nil 或者未指定 ip，则监听广播；<br></li>
</ul>

<p>
<code>net.ListenTCP</code> 函数经常与 <code>Accept</code> 方法共同使用来实现服务端的监听功能。<br>
</p>

<div class="org-src-container">
<pre class="src src-go"><span style="color: #268bd2; font-weight: bold;">package</span> main

<span style="color: #268bd2; font-weight: bold;">import</span> (
    <span style="color: #2aa198;">"fmt"</span>
    <span style="color: #2aa198;">"net"</span>
    <span style="color: #2aa198;">"time"</span>
)

<span style="color: #268bd2; font-weight: bold;">func</span> <span style="color: #d75fd7; font-weight: bold;">main</span>() {
    <span style="color: #8787d7;">service</span> := <span style="color: #2aa198;">":2000"</span>                               <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">&#35774;&#32622;&#26381;&#21153;&#22120;&#30417;&#21548;&#30340;&#31471;&#21475;</span>
    <span style="color: #8787d7;">tcpAddr</span>, <span style="color: #8787d7;">_</span> := net.<span style="color: #d75fd7; font-weight: bold;">ResolveTCPAddr</span>(<span style="color: #2aa198;">"tcp"</span>, service) <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">&#21019;&#24314; tcpAddr&#25968;&#25454;</span>
    <span style="color: #8787d7;">listener</span>, <span style="color: #8787d7;">_</span> := net.<span style="color: #d75fd7; font-weight: bold;">ListenTCP</span>(<span style="color: #2aa198;">"tcp"</span>, tcpAddr)     <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">&#30417;&#21548; tcpAddr</span>

    <span style="color: #268bd2; font-weight: bold;">for</span> <span style="color: #8787d7;">i</span> := 0; ; i++ {
        <span style="color: #8787d7;">conn</span>, <span style="color: #8787d7;">_</span> := listener.<span style="color: #d75fd7; font-weight: bold;">Accept</span>()
        <span style="color: #8787d7;">nowTime</span> := time.<span style="color: #d75fd7; font-weight: bold;">Now</span>().<span style="color: #d75fd7; font-weight: bold;">String</span>()
        fmt.<span style="color: #d75fd7; font-weight: bold;">Println</span>(<span style="color: #2aa198;">"new request "</span>, i, <span style="color: #2aa198;">" return time: "</span>, nowTime)
        conn.<span style="color: #d75fd7; font-weight: bold;">Write</span>([]<span style="color: #d75fd7; font-weight: bold;">byte</span>(nowTime))
        conn.<span style="color: #d75fd7; font-weight: bold;">Close</span>()
    }
}
</pre>
</div>
</div>
</div>
<div id="outline-container-orgaabe021" class="outline-4">
<h4 id="orgaabe021">func (*TCPListener) Addr</h4>
<div class="outline-text-4" id="text-orgaabe021">
<div class="org-src-container">
<pre class="src src-go"><span style="color: #268bd2; font-weight: bold;">func</span> (<span style="color: #8787d7;">l</span> *<span style="color: #df005f; font-weight: bold;">TCPListener</span>) <span style="color: #d75fd7; font-weight: bold;">Addr</span>() <span style="color: #df005f; font-weight: bold;">Addr</span>
</pre>
</div>

<p>
<code>Addr</code> 返回 l 监听的的网络地址，一个 <code>*TCPAddr</code> 。<br>
</p>
</div>
</div>
<div id="outline-container-org6a9ed55" class="outline-4">
<h4 id="org6a9ed55">func (*TCPListener) SetDeadline</h4>
<div class="outline-text-4" id="text-org6a9ed55">
<div class="org-src-container">
<pre class="src src-go"><span style="color: #268bd2; font-weight: bold;">func</span> (<span style="color: #8787d7;">l</span> *<span style="color: #df005f; font-weight: bold;">TCPListener</span>) <span style="color: #d75fd7; font-weight: bold;">SetDeadline</span>(<span style="color: #8787d7;">t</span> <span style="color: #df005f; font-weight: bold;">time.Time</span>) <span style="color: #df005f; font-weight: bold;">error</span>
</pre>
</div>

<p>
设置监听器执行的期限，t 为 Time 零值则会关闭期限限制。<br>
</p>
</div>
</div>
<div id="outline-container-org1ac6072" class="outline-4">
<h4 id="org1ac6072">func (*TCPListener) Accept</h4>
<div class="outline-text-4" id="text-org1ac6072">
<div class="org-src-container">
<pre class="src src-go"><span style="color: #268bd2; font-weight: bold;">func</span> (<span style="color: #8787d7;">l</span> *<span style="color: #df005f; font-weight: bold;">TCPListener</span>) <span style="color: #d75fd7; font-weight: bold;">Accept</span>() (<span style="color: #df005f; font-weight: bold;">Conn</span>, <span style="color: #df005f; font-weight: bold;">error</span>)
</pre>
</div>

<p>
<code>Accept</code> 用于实现 <code>Listener</code> 接口的 <code>Accept</code> 方法；他会等待下一个呼叫，并返回一个该呼叫的 <code>Conn</code> 接口。<br>
</p>
</div>
</div>
<div id="outline-container-org55b5315" class="outline-4">
<h4 id="org55b5315">func (*TCPListener) AcceptTCP</h4>
<div class="outline-text-4" id="text-org55b5315">
<div class="org-src-container">
<pre class="src src-go"><span style="color: #268bd2; font-weight: bold;">func</span> (<span style="color: #8787d7;">l</span> *<span style="color: #df005f; font-weight: bold;">TCPListener</span>) <span style="color: #d75fd7; font-weight: bold;">AcceptTCP</span>() (*<span style="color: #df005f; font-weight: bold;">TCPConn</span>, <span style="color: #df005f; font-weight: bold;">error</span>)
</pre>
</div>

<p>
<code>AcceptTCP</code> 接收下一个呼叫，并返回一个新的 <code>*TCPConn</code> 。<br>
</p>
</div>
</div>
<div id="outline-container-org9dda406" class="outline-4">
<h4 id="org9dda406">func (*TCPListener) Close</h4>
<div class="outline-text-4" id="text-org9dda406">
<div class="org-src-container">
<pre class="src src-go"><span style="color: #268bd2; font-weight: bold;">func</span> (<span style="color: #8787d7;">l</span> *<span style="color: #df005f; font-weight: bold;">TCPListener</span>) <span style="color: #d75fd7; font-weight: bold;">Close</span>() <span style="color: #df005f; font-weight: bold;">error</span>
</pre>
</div>

<p>
<code>Close</code> 停止监听 <code>TCP</code> 地址，已经接收的连接不受影响。<br>
</p>
</div>
</div>
<div id="outline-container-org8560269" class="outline-4">
<h4 id="org8560269">func (*TCPListener) File</h4>
<div class="outline-text-4" id="text-org8560269">
<div class="org-src-container">
<pre class="src src-go"><span style="color: #268bd2; font-weight: bold;">func</span> (<span style="color: #8787d7;">l</span> *<span style="color: #df005f; font-weight: bold;">TCPListener</span>) <span style="color: #d75fd7; font-weight: bold;">File</span>() (<span style="color: #8787d7;">f</span> *<span style="color: #df005f; font-weight: bold;">os.File</span>, <span style="color: #8787d7;">err</span> <span style="color: #df005f; font-weight: bold;">error</span>)
</pre>
</div>

<p>
<code>File</code> 方法返回下层的 <code>os.File</code> 的副本，并将该副本设置为阻塞模式。<br>
</p>

<p>
使用者有责任在用完后关闭f。关闭 <code>c</code> 不影响 <code>f</code> ，关闭 <code>f</code> 也不影响 <code>c</code> 。返回的 <code>os.File</code> 类型文件描述符和原本的网络连接是不同的。试图使用该副本修改本体的属性可能会（也可能不会）得到期望的效果。<br>
</p>
</div>
</div>
</div>
<div id="outline-container-orgba5241a" class="outline-3">
<h3 id="orgba5241a">type TCPConn</h3>
<div class="outline-text-3" id="text-orgba5241a">
<div class="org-src-container">
<pre class="src src-go"><span style="color: #268bd2; font-weight: bold;">type</span> <span style="color: #df005f; font-weight: bold;">TCPConn</span> <span style="color: #268bd2; font-weight: bold;">struct</span> {
    <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">&#20869;&#21547;&#38544;&#34255;&#25110;&#38750;&#23548;&#20986;&#23383;&#27573;</span>
}
</pre>
</div>

<p>
TCPConn 代表一个 TCP 网络连接，实现了 Conn 接口。<br>
</p>
</div>
<div id="outline-container-orgb10cdab" class="outline-4">
<h4 id="orgb10cdab">func DialTCP</h4>
<div class="outline-text-4" id="text-orgb10cdab">
<div class="org-src-container">
<pre class="src src-go"><span style="color: #268bd2; font-weight: bold;">func</span> <span style="color: #d75fd7; font-weight: bold;">DialTCP</span>(<span style="color: #8787d7;">net</span> <span style="color: #df005f; font-weight: bold;">string</span>, <span style="color: #8787d7;">laddr</span>, <span style="color: #8787d7;">raddr</span> *<span style="color: #df005f; font-weight: bold;">TCPAddr</span>) (*<span style="color: #df005f; font-weight: bold;">TCPConn</span>, <span style="color: #df005f; font-weight: bold;">error</span>)
</pre>
</div>

<p>
<code>DialTCP</code> 在网络协议 <code>net</code> 上连接本地地址 <code>laddr</code> 和远端地址 <code>raddr</code> 。 <code>net</code> 必须是 <code>tcp</code> 、 <code>tcp4</code> 、 <code>tcp6</code> ；如果 <code>laddr</code> 不是 <code>nil</code> ，将使用它作为本地地址，否则自动选择一个本地地址。<br>
</p>
</div>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Author: L.M.haoran</p>
<p class="date">Created: 2022-06-24 Fri 21:19</p>
<p class="validation"><a href="http://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
