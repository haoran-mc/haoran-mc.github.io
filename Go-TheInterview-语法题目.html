<!DOCTYPE html>
<html lang="zh">
<head>
<!-- 2022-02-11 Fri 23:21 -->
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>语法题目</title>
<meta name="generator" content="Org mode">
<meta name="author" content="L.M.haoran">
<meta name="description" content="Copyright © 2022, L.M.haoran, all rights reserved."
>

                <link rel="stylesheet" href="static/css/org.css" type="text/css"  />
                <script type="module" src="static/js/main.js" defer></script>
                <link rel="shortcut icon" href="images/favicon.ico" type="image/x-icon" />
</head>
<body>
<div id="content">
<h1 class="title">语法题目</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org3669d86">下面代码能运行吗？为什么。</a></li>
<li><a href="#orga40d445">请说出下面代码存在什么问题。</a></li>
<li><a href="#orgeb084d1">写出打印的结果。</a></li>
<li><a href="#orgb73a001">下面的代码是有问题的，请说明原因。</a></li>
<li><a href="#org2370e4f">请找出下面代码的问题所在。</a></li>
<li><a href="#orge7931f0">请说明下面代码书写是否正确。</a></li>
<li><a href="#org6b5f5c5">下面的程序运行后为什么会爆异常。</a></li>
<li><a href="#org43bf03b">请说出下面代码哪里写错了</a></li>
<li><a href="#orga77360f">请说出下面代码，执行时为什么会报错</a></li>
<li><a href="#orgcaf5036">请说出下面的代码存在什么问题？</a></li>
<li><a href="#org6ed207f">下面这段代码为什么会卡死？</a></li>
<li><a href="#orgde6b5e8">写出下面代码输出内容。</a></li>
<li><a href="#orga2683b8">以下代码有什么问题，说明原因</a></li>
<li><a href="#org7a15083">下面的代码会输出什么，并说明原因</a></li>
<li><a href="#orgab02cd1">下面代码会输出什么？</a></li>
</ul>
</div>
</div>

<div id="outline-container-org3669d86" class="outline-2">
<h2 id="org3669d86">下面代码能运行吗？为什么。</h2>
<div class="outline-text-2" id="text-org3669d86">
<div class="org-src-container">
<pre class="src src-go"><span style="color: #268bd2; font-weight: bold;">type</span> <span style="color: #df005f; font-weight: bold;">Param</span> <span style="color: #268bd2; font-weight: bold;">map</span>[<span style="color: #df005f; font-weight: bold;">string</span>]<span style="color: #268bd2; font-weight: bold;">interface</span>{}

<span style="color: #268bd2; font-weight: bold;">type</span> <span style="color: #df005f; font-weight: bold;">Show</span> <span style="color: #268bd2; font-weight: bold;">struct</span> {
    Param
}

<span style="color: #268bd2; font-weight: bold;">func</span> <span style="color: #d75fd7; font-weight: bold;">main1</span>() {
    <span style="color: #8787d7;">s</span> := <span style="color: #268bd2;">new</span>(<span style="color: #df005f; font-weight: bold;">Show</span>)
    s.Param[<span style="color: #2aa198;">"RMB"</span>] = <span style="color: #d75fd7;">10000</span>
}
</pre>
</div>

<p>
共发现两个问题：<br>
</p>

<ol class="org-ol">
<li><code>main</code> 函数不能加数字。<br></li>
<li><code>new</code> 关键字无法初始化 <code>Show</code> 结构体中的 Param 属性，所以直接对 s.Param 操作会出错。<br></li>
</ol>
</div>
</div>
<div id="outline-container-orga40d445" class="outline-2">
<h2 id="orga40d445">请说出下面代码存在什么问题。</h2>
<div class="outline-text-2" id="text-orga40d445">
<div class="org-src-container">
<pre class="src src-go"><span style="color: #268bd2; font-weight: bold;">type</span> <span style="color: #df005f; font-weight: bold;">student</span> <span style="color: #268bd2; font-weight: bold;">struct</span> {
    name <span style="color: #df005f; font-weight: bold;">string</span>
}

<span style="color: #268bd2; font-weight: bold;">func</span> <span style="color: #d75fd7; font-weight: bold;">test</span>(<span style="color: #8787d7;">v</span> <span style="color: #268bd2; font-weight: bold;">interface</span>{}) {
    <span style="color: #268bd2; font-weight: bold;">switch</span> <span style="color: #8787d7;">msg</span> := v.(<span style="color: #268bd2; font-weight: bold;">type</span>) {
    <span style="color: #268bd2; font-weight: bold;">case</span> *<span style="color: #df005f; font-weight: bold;">student</span>, <span style="color: #df005f; font-weight: bold;">student</span>:
        fmt.<span style="color: #d75fd7; font-weight: bold;">Println</span>(msg.name)
    }
}
</pre>
</div>

<p>
golang 中有规定， <code>switch type</code> 的 <code>case T1</code> ，类型列表只有一个，那么 <code>v := m.(type)</code> 中的 <code>v</code> 的类型就是 T1 类型。<br>
</p>

<p>
如果是 <code>case T1, T2</code> ，类型列表中有多个，那 <code>v</code> 的类型还是多对应接口的类型，也就是 <code>m</code> 的类型。<br>
</p>

<p>
所以这里 <code>msg</code> 的类型还是 <code>interface{}</code> ，所以他没有 <code>Name</code> 这个字段，编译阶段就会报错。具体解释见： <a href="https://golang.org/ref/spec#Type_switches">https://golang.org/ref/spec#Type_switches</a><br>
</p>

<p>
下面是正确代码：<br>
</p>

<div class="org-src-container">
<pre class="src src-go"><span style="color: #268bd2; font-weight: bold;">type</span> <span style="color: #df005f; font-weight: bold;">student</span> <span style="color: #268bd2; font-weight: bold;">struct</span> {
    name <span style="color: #df005f; font-weight: bold;">string</span>
}

<span style="color: #268bd2; font-weight: bold;">func</span> <span style="color: #d75fd7; font-weight: bold;">test</span>(<span style="color: #8787d7;">v</span> <span style="color: #268bd2; font-weight: bold;">interface</span>{}) {
    <span style="color: #268bd2; font-weight: bold;">switch</span> <span style="color: #8787d7;">msg</span> := v.(<span style="color: #268bd2; font-weight: bold;">type</span>) {
    <span style="color: #268bd2; font-weight: bold;">case</span> *<span style="color: #df005f; font-weight: bold;">student</span>:
        fmt.<span style="color: #d75fd7; font-weight: bold;">Println</span>(msg.name)
    <span style="color: #268bd2; font-weight: bold;">case</span> <span style="color: #df005f; font-weight: bold;">student</span>:
        fmt.<span style="color: #d75fd7; font-weight: bold;">Println</span>(msg.name)
    }
}
</pre>
</div>
</div>
</div>
<div id="outline-container-orgeb084d1" class="outline-2">
<h2 id="orgeb084d1">写出打印的结果。</h2>
<div class="outline-text-2" id="text-orgeb084d1">
<div class="org-src-container">
<pre class="src src-go"><span style="color: #268bd2; font-weight: bold;">type</span> <span style="color: #df005f; font-weight: bold;">People</span> <span style="color: #268bd2; font-weight: bold;">struct</span> {
    name <span style="color: #df005f; font-weight: bold;">string</span> <span style="color: #2aa198;">`json:"name"`</span>
}

<span style="color: #268bd2; font-weight: bold;">func</span> <span style="color: #d75fd7; font-weight: bold;">main</span>() {
    <span style="color: #8787d7;">js</span> := <span style="color: #2aa198;">`{</span>
<span style="color: #2aa198;">        "name":"11"</span>
<span style="color: #2aa198;">    }`</span>
    <span style="color: #268bd2; font-weight: bold;">var</span> <span style="color: #8787d7;">p</span> <span style="color: #df005f; font-weight: bold;">People</span>
    <span style="color: #8787d7;">err</span> := json.<span style="color: #d75fd7; font-weight: bold;">Unmarshal</span>([]<span style="color: #d75fd7; font-weight: bold;">byte</span>(js), &amp;p)
    <span style="color: #268bd2; font-weight: bold;">if</span> err != <span style="color: #d75fd7;">nil</span> {
        fmt.<span style="color: #d75fd7; font-weight: bold;">Println</span>(<span style="color: #2aa198;">"err: "</span>, err)
        <span style="color: #268bd2; font-weight: bold;">return</span>
    }
    fmt.<span style="color: #d75fd7; font-weight: bold;">Println</span>(<span style="color: #2aa198;">"people: "</span>, p)
}
</pre>
</div>

<p>
按照 golang 的语法，小写开头的方法、属性或 <code>struct</code> 是私有的，同样，在 <code>json</code> 解码或转码的时候也无法上线私有属性的转换。<br>
</p>

<p>
题目中是无法正常得到 <code>People</code> 的 <code>name</code> 值的。而且，私有属性 <code>name</code> 也不应该加 <code>json</code> 的标签。<br>
</p>
</div>
</div>
<div id="outline-container-orgb73a001" class="outline-2">
<h2 id="orgb73a001">下面的代码是有问题的，请说明原因。</h2>
<div class="outline-text-2" id="text-orgb73a001">
<div class="org-src-container">
<pre class="src src-go"><span style="color: #268bd2; font-weight: bold;">type</span> <span style="color: #df005f; font-weight: bold;">People</span> <span style="color: #268bd2; font-weight: bold;">struct</span> {
    Name <span style="color: #df005f; font-weight: bold;">string</span>
}

<span style="color: #268bd2; font-weight: bold;">func</span> (<span style="color: #8787d7;">p</span> *<span style="color: #df005f; font-weight: bold;">People</span>) <span style="color: #d75fd7; font-weight: bold;">String</span>() <span style="color: #df005f; font-weight: bold;">string</span> {
    <span style="color: #268bd2; font-weight: bold;">return</span> fmt.<span style="color: #d75fd7; font-weight: bold;">Sprintf</span>(<span style="color: #2aa198;">"print: %v"</span>, p)
}

<span style="color: #268bd2; font-weight: bold;">func</span> <span style="color: #d75fd7; font-weight: bold;">main</span>() {
    <span style="color: #8787d7;">p</span> := &amp;<span style="color: #df005f; font-weight: bold;">People</span>{}
    p.<span style="color: #d75fd7; font-weight: bold;">String</span>()
}
</pre>
</div>

<p>
在golang中 <code>String() string</code> 方法实际上是实现了 <code>String</code> 的接口的，该接口定义在 <code>fmt/print.go</code>  中：<br>
</p>

<div class="org-src-container">
<pre class="src src-go"><span style="color: #268bd2; font-weight: bold;">type</span> <span style="color: #df005f; font-weight: bold;">Stringer</span> <span style="color: #268bd2; font-weight: bold;">interface</span> {
    <span style="color: #d75fd7; font-weight: bold;">String</span>() <span style="color: #df005f; font-weight: bold;">string</span>
}
</pre>
</div>

<p>
在使用 <code>fmt</code> 包中的打印方法时，如果类型实现了这个接口，会直接调用。而题目中打印 <code>p</code> 的时候会直接调用 <code>p</code> 实现的 <code>String()</code> 方法，然后就产生了循环调用。<br>
</p>

<p>
正确写法：<br>
</p>

<div class="org-src-container">
<pre class="src src-go"><span style="color: #268bd2; font-weight: bold;">package</span> main

<span style="color: #268bd2; font-weight: bold;">import</span> <span style="color: #2aa198;">"fmt"</span>

<span style="color: #268bd2; font-weight: bold;">type</span> <span style="color: #df005f; font-weight: bold;">People</span> <span style="color: #268bd2; font-weight: bold;">struct</span> {
    Name <span style="color: #df005f; font-weight: bold;">string</span>
}

<span style="color: #268bd2; font-weight: bold;">func</span> (<span style="color: #8787d7;">p</span> *<span style="color: #df005f; font-weight: bold;">People</span>) <span style="color: #d75fd7; font-weight: bold;">String</span>() <span style="color: #df005f; font-weight: bold;">string</span> {
    <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #2aa198;">"print: &amp;{"</span> + p.Name + <span style="color: #2aa198;">"}"</span>
}

<span style="color: #268bd2; font-weight: bold;">func</span> <span style="color: #d75fd7; font-weight: bold;">main</span>() {
    <span style="color: #8787d7;">p</span> := &amp;<span style="color: #df005f; font-weight: bold;">People</span>{<span style="color: #2aa198;">"haoran"</span>}
    p.<span style="color: #d75fd7; font-weight: bold;">String</span>()
    fmt.<span style="color: #d75fd7; font-weight: bold;">Println</span>(p)
}
</pre>
</div>
</div>
</div>
<div id="outline-container-org2370e4f" class="outline-2">
<h2 id="org2370e4f">请找出下面代码的问题所在。</h2>
<div class="outline-text-2" id="text-org2370e4f">
<div class="org-src-container">
<pre class="src src-go"><span style="color: #268bd2; font-weight: bold;">func</span> <span style="color: #d75fd7; font-weight: bold;">main</span>() {
    <span style="color: #8787d7;">ch</span> := <span style="color: #268bd2;">make</span>(<span style="color: #268bd2; font-weight: bold;">chan</span> <span style="color: #df005f; font-weight: bold;">int</span>, <span style="color: #d75fd7;">1000</span>)
    <span style="color: #268bd2; font-weight: bold;">go</span> <span style="color: #268bd2; font-weight: bold;">func</span>() {
        <span style="color: #268bd2; font-weight: bold;">for</span> <span style="color: #8787d7;">i</span> := <span style="color: #d75fd7;">0</span>; i &lt; <span style="color: #d75fd7;">10</span>; i++ {
            ch &lt;- i
        }
    }()
    <span style="color: #268bd2; font-weight: bold;">go</span> <span style="color: #268bd2; font-weight: bold;">func</span>() {
        <span style="color: #268bd2; font-weight: bold;">for</span> {
            <span style="color: #8787d7;">a</span>, <span style="color: #8787d7;">ok</span> := &lt;-ch
            <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">!</span>ok {
                fmt.<span style="color: #d75fd7; font-weight: bold;">Println</span>(<span style="color: #2aa198;">"close"</span>)
                <span style="color: #268bd2; font-weight: bold;">return</span>
            }
            fmt.<span style="color: #d75fd7; font-weight: bold;">Println</span>(<span style="color: #2aa198;">"a: "</span>, a)
        }
    }()
    <span style="color: #268bd2;">close</span>(ch)
    fmt.<span style="color: #d75fd7; font-weight: bold;">Println</span>(<span style="color: #2aa198;">"ok"</span>)
    time.<span style="color: #d75fd7; font-weight: bold;">Sleep</span>(time.Second * <span style="color: #d75fd7;">3</span>)
}
</pre>
</div>

<p>
在 golang 中 <code>goroutine</code> 的调度时间是不确定的，在题目中，第一个写 <code>channel</code> 的 <code>goroutine</code> 可能还未调用，或已调用但没有写完时直接 <code>close</code> 管道，可能导致写失败，出现 <code>panic</code> 错误。<br>
</p>

<div class="org-src-container">
<pre class="src src-go"><span style="color: #268bd2; font-weight: bold;">func</span> <span style="color: #d75fd7; font-weight: bold;">main</span>() {
    <span style="color: #8787d7;">ch</span> := <span style="color: #268bd2;">make</span>(<span style="color: #268bd2; font-weight: bold;">chan</span> <span style="color: #df005f; font-weight: bold;">int</span>, <span style="color: #d75fd7;">1000</span>)

    <span style="color: #268bd2; font-weight: bold;">go</span> <span style="color: #268bd2; font-weight: bold;">func</span>() {
        <span style="color: #268bd2; font-weight: bold;">for</span> <span style="color: #8787d7;">i</span> := <span style="color: #d75fd7;">0</span>; i &lt; <span style="color: #d75fd7;">10</span>; i++ {
            ch &lt;- i
        }
        <span style="color: #268bd2;">close</span>(ch)
    }()

    <span style="color: #268bd2; font-weight: bold;">go</span> <span style="color: #268bd2; font-weight: bold;">func</span>() {
        <span style="color: #268bd2; font-weight: bold;">for</span> {
            <span style="color: #8787d7;">a</span>, <span style="color: #8787d7;">ok</span> := &lt;-ch
            <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">!</span>ok {
                fmt.<span style="color: #d75fd7; font-weight: bold;">Println</span>(<span style="color: #2aa198;">"close"</span>)
                <span style="color: #268bd2; font-weight: bold;">return</span>
            }
            fmt.<span style="color: #d75fd7; font-weight: bold;">Println</span>(<span style="color: #2aa198;">"a: "</span>, a)
        }
    }()

    <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">close(ch)</span>
    fmt.<span style="color: #d75fd7; font-weight: bold;">Println</span>(<span style="color: #2aa198;">"ok"</span>)
    time.<span style="color: #d75fd7; font-weight: bold;">Sleep</span>(time.Second * <span style="color: #d75fd7;">3</span>)
}
</pre>
</div>
</div>
</div>
<div id="outline-container-orge7931f0" class="outline-2">
<h2 id="orge7931f0">请说明下面代码书写是否正确。</h2>
<div class="outline-text-2" id="text-orge7931f0">
<div class="org-src-container">
<pre class="src src-go"><span style="color: #268bd2; font-weight: bold;">var</span> <span style="color: #8787d7;">value</span> <span style="color: #df005f; font-weight: bold;">int32</span>

<span style="color: #268bd2; font-weight: bold;">func</span> <span style="color: #d75fd7; font-weight: bold;">SetValue</span>(<span style="color: #8787d7;">delta</span> <span style="color: #df005f; font-weight: bold;">int32</span>) {
    <span style="color: #268bd2; font-weight: bold;">for</span> {
        <span style="color: #8787d7;">v</span> := value
        <span style="color: #268bd2; font-weight: bold;">if</span> atomic.<span style="color: #d75fd7; font-weight: bold;">CompareAndSwapInt32</span>(&amp;value, v, (v + delta)) {
            <span style="color: #268bd2; font-weight: bold;">break</span>
        }
    }
}
</pre>
</div>

<p>
<code>atomic.CompareAndSwapInt32</code> 函数不需要循环调用。<br>
</p>
</div>
</div>
<div id="outline-container-org6b5f5c5" class="outline-2">
<h2 id="org6b5f5c5">下面的程序运行后为什么会爆异常。</h2>
<div class="outline-text-2" id="text-org6b5f5c5">
<div class="org-src-container">
<pre class="src src-go"><span style="color: #268bd2; font-weight: bold;">type</span> <span style="color: #df005f; font-weight: bold;">Project</span> <span style="color: #268bd2; font-weight: bold;">struct</span>{}

<span style="color: #268bd2; font-weight: bold;">func</span> (<span style="color: #8787d7;">p</span> *<span style="color: #df005f; font-weight: bold;">Project</span>) <span style="color: #d75fd7; font-weight: bold;">deferError</span>() {
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #8787d7;">err</span> := <span style="color: #268bd2;">recover</span>(); err != <span style="color: #d75fd7;">nil</span> {
        fmt.<span style="color: #d75fd7; font-weight: bold;">Println</span>(<span style="color: #2aa198;">"recover: "</span>, err)
    }
}

<span style="color: #268bd2; font-weight: bold;">func</span> (<span style="color: #8787d7;">p</span> *<span style="color: #df005f; font-weight: bold;">Project</span>) <span style="color: #d75fd7; font-weight: bold;">exec</span>(<span style="color: #8787d7;">msgchan</span> <span style="color: #268bd2; font-weight: bold;">chan</span> <span style="color: #268bd2; font-weight: bold;">interface</span>{}) {
    <span style="color: #268bd2; font-weight: bold;">for</span> <span style="color: #8787d7;">msg</span> := <span style="color: #268bd2; font-weight: bold;">range</span> msgchan {
        <span style="color: #8787d7;">m</span> := msg.(<span style="color: #df005f; font-weight: bold;">int</span>)
        fmt.<span style="color: #d75fd7; font-weight: bold;">Println</span>(<span style="color: #2aa198;">"msg: "</span>, m)
    }
}

<span style="color: #268bd2; font-weight: bold;">func</span> (<span style="color: #8787d7;">p</span> *<span style="color: #df005f; font-weight: bold;">Project</span>) <span style="color: #d75fd7; font-weight: bold;">run</span>(<span style="color: #8787d7;">msgchan</span> <span style="color: #268bd2; font-weight: bold;">chan</span> <span style="color: #268bd2; font-weight: bold;">interface</span>{}) {
    <span style="color: #268bd2; font-weight: bold;">for</span> {
        <span style="color: #268bd2; font-weight: bold;">defer</span> p.<span style="color: #d75fd7; font-weight: bold;">deferError</span>()
        <span style="color: #268bd2; font-weight: bold;">go</span> p.<span style="color: #d75fd7; font-weight: bold;">exec</span>(msgchan)
        time.<span style="color: #d75fd7; font-weight: bold;">Sleep</span>(time.Second * <span style="color: #d75fd7;">2</span>)
    }
}

<span style="color: #268bd2; font-weight: bold;">func</span> (<span style="color: #8787d7;">p</span> *<span style="color: #df005f; font-weight: bold;">Project</span>) <span style="color: #d75fd7; font-weight: bold;">Main</span>() {
    <span style="color: #8787d7;">a</span> := <span style="color: #268bd2;">make</span>(<span style="color: #268bd2; font-weight: bold;">chan</span> <span style="color: #268bd2; font-weight: bold;">interface</span>{}, <span style="color: #d75fd7;">100</span>)
    <span style="color: #268bd2; font-weight: bold;">go</span> p.<span style="color: #d75fd7; font-weight: bold;">run</span>(a)
    <span style="color: #268bd2; font-weight: bold;">go</span> <span style="color: #268bd2; font-weight: bold;">func</span>() {
        <span style="color: #268bd2; font-weight: bold;">for</span> {
            a &lt;- <span style="color: #2aa198;">"1"</span>
            time.<span style="color: #d75fd7; font-weight: bold;">Sleep</span>(time.Second)
        }
    }()
    time.<span style="color: #d75fd7; font-weight: bold;">Sleep</span>(time.Second * <span style="color: #d75fd7;">100000000000000</span>)
}

<span style="color: #268bd2; font-weight: bold;">func</span> <span style="color: #d75fd7; font-weight: bold;">main</span>() {
    <span style="color: #8787d7;">p</span> := <span style="color: #268bd2;">new</span>(<span style="color: #df005f; font-weight: bold;">Project</span>)
    p.<span style="color: #d75fd7; font-weight: bold;">Main</span>()
}
</pre>
</div>

<p>
有一下几个问题：<br>
</p>

<ol class="org-ol">
<li><code>time.Sleep</code> 的参数数值太大，超过了 <code>1 &lt;&lt; 63 - 1</code> 的限制。<br></li>
<li><code>defer p.deferError()</code> 需要在协程开始处调用，否则无法捕获 <code>panic</code> 。<br></li>
</ol>
</div>
</div>
<div id="outline-container-org43bf03b" class="outline-2">
<h2 id="org43bf03b">请说出下面代码哪里写错了</h2>
<div class="outline-text-2" id="text-org43bf03b">
<div class="org-src-container">
<pre class="src src-go"><span style="color: #268bd2; font-weight: bold;">func</span> <span style="color: #d75fd7; font-weight: bold;">main</span>() {
    <span style="color: #8787d7;">abc</span> := <span style="color: #268bd2;">make</span>(<span style="color: #268bd2; font-weight: bold;">chan</span> <span style="color: #df005f; font-weight: bold;">int</span>, <span style="color: #d75fd7;">1000</span>)
    <span style="color: #268bd2; font-weight: bold;">for</span> <span style="color: #8787d7;">i</span> := <span style="color: #d75fd7;">0</span>; i &lt; <span style="color: #d75fd7;">10</span>; i ++ {
        abc &lt;- i
    }
    <span style="color: #268bd2; font-weight: bold;">go</span> <span style="color: #268bd2; font-weight: bold;">func</span>() {
        <span style="color: #268bd2; font-weight: bold;">for</span> <span style="color: #8787d7;">a</span> := <span style="color: #268bd2; font-weight: bold;">range</span> abc  {
            fmt.<span style="color: #d75fd7; font-weight: bold;">Println</span>(<span style="color: #2aa198;">"a: "</span>, a)
        }
    }()
    <span style="color: #268bd2;">close</span>(abc)
    fmt.<span style="color: #d75fd7; font-weight: bold;">Println</span>(<span style="color: #2aa198;">"close"</span>)
    time.<span style="color: #d75fd7; font-weight: bold;">Sleep</span>(time.Second * <span style="color: #d75fd7;">100</span>)
}
</pre>
</div>

<p>
协程可能还未启动，管道就关闭了。<br>
</p>
</div>
</div>
<div id="outline-container-orga77360f" class="outline-2">
<h2 id="orga77360f">请说出下面代码，执行时为什么会报错</h2>
<div class="outline-text-2" id="text-orga77360f">
<div class="org-src-container">
<pre class="src src-go"><span style="color: #268bd2; font-weight: bold;">type</span> <span style="color: #df005f; font-weight: bold;">Student</span> <span style="color: #268bd2; font-weight: bold;">struct</span> {
    name <span style="color: #df005f; font-weight: bold;">string</span>
}

<span style="color: #268bd2; font-weight: bold;">func</span> <span style="color: #d75fd7; font-weight: bold;">main</span>() {
    <span style="color: #8787d7;">m</span> := <span style="color: #268bd2; font-weight: bold;">map</span>[<span style="color: #df005f; font-weight: bold;">string</span>]<span style="color: #df005f; font-weight: bold;">Student</span>{<span style="color: #2aa198;">"people"</span>: {<span style="color: #2aa198;">"peo1"</span>}}
    m[<span style="color: #2aa198;">"people"</span>].name = <span style="color: #2aa198;">"peo2"</span>
}
</pre>
</div>

<p>
<code>map</code> 的 <code>value</code> 本身是不可寻址的，因为 <code>map</code> 中的值会在内存中移动，并且旧的指针地址在 <code>map</code> 改变时会变得无效。故如果需要修改 <code>map</code> 值，可以将 <code>map</code> 中的非指针类型 <code>value</code> ，修改为指针类型，比如使用 <code>map[string]*Student</code> 。<br>
</p>
</div>
</div>
<div id="outline-container-orgcaf5036" class="outline-2">
<h2 id="orgcaf5036">请说出下面的代码存在什么问题？</h2>
<div class="outline-text-2" id="text-orgcaf5036">
<div class="org-src-container">
<pre class="src src-go"><span style="color: #268bd2; font-weight: bold;">type</span> <span style="color: #df005f; font-weight: bold;">query</span> <span style="color: #268bd2; font-weight: bold;">func</span>(<span style="color: #df005f; font-weight: bold;">string</span>) <span style="color: #df005f; font-weight: bold;">string</span>

<span style="color: #268bd2; font-weight: bold;">func</span> <span style="color: #d75fd7; font-weight: bold;">exec</span>(<span style="color: #8787d7;">name</span> <span style="color: #df005f; font-weight: bold;">string</span>, <span style="color: #8787d7;">vs</span> ...<span style="color: #df005f; font-weight: bold;">query</span>) <span style="color: #df005f; font-weight: bold;">string</span> {
    <span style="color: #8787d7;">ch</span> := <span style="color: #268bd2;">make</span>(<span style="color: #268bd2; font-weight: bold;">chan</span> <span style="color: #df005f; font-weight: bold;">string</span>)
    <span style="color: #8787d7;">fn</span> := <span style="color: #268bd2; font-weight: bold;">func</span>(<span style="color: #8787d7;">i</span> <span style="color: #df005f; font-weight: bold;">int</span>) {
        ch &lt;- vs[i](name)
    }
    <span style="color: #268bd2; font-weight: bold;">for</span> <span style="color: #8787d7;">i</span>, <span style="color: #8787d7;">_</span> := <span style="color: #268bd2; font-weight: bold;">range</span> vs {
        <span style="color: #268bd2; font-weight: bold;">go</span> <span style="color: #d75fd7; font-weight: bold;">fn</span>(i)
    }
    <span style="color: #268bd2; font-weight: bold;">return</span> &lt;-ch
}

<span style="color: #268bd2; font-weight: bold;">func</span> <span style="color: #d75fd7; font-weight: bold;">main</span>() {
    <span style="color: #8787d7;">ret</span> := <span style="color: #d75fd7; font-weight: bold;">exec</span>(<span style="color: #2aa198;">"ret-"</span>, <span style="color: #268bd2; font-weight: bold;">func</span>(<span style="color: #8787d7;">n</span> <span style="color: #df005f; font-weight: bold;">string</span>) <span style="color: #df005f; font-weight: bold;">string</span> {
        <span style="color: #268bd2; font-weight: bold;">return</span> n + <span style="color: #2aa198;">"func1"</span>
    }, <span style="color: #268bd2; font-weight: bold;">func</span>(<span style="color: #8787d7;">n</span> <span style="color: #df005f; font-weight: bold;">string</span>) <span style="color: #df005f; font-weight: bold;">string</span> {
        <span style="color: #268bd2; font-weight: bold;">return</span> n + <span style="color: #2aa198;">"func2"</span>
    }, <span style="color: #268bd2; font-weight: bold;">func</span>(<span style="color: #8787d7;">n</span> <span style="color: #df005f; font-weight: bold;">string</span>) <span style="color: #df005f; font-weight: bold;">string</span> {
        <span style="color: #268bd2; font-weight: bold;">return</span> n + <span style="color: #2aa198;">"func3"</span>
    }, <span style="color: #268bd2; font-weight: bold;">func</span>(<span style="color: #8787d7;">n</span> <span style="color: #df005f; font-weight: bold;">string</span>) <span style="color: #df005f; font-weight: bold;">string</span> {
        <span style="color: #268bd2; font-weight: bold;">return</span> n + <span style="color: #2aa198;">"func4"</span>
    })
    fmt.<span style="color: #d75fd7; font-weight: bold;">Println</span>(ret)
}
</pre>
</div>

<p>
依据 4 个 <code>goroutine</code> 的启动后执行效率，很可能打印 <code>ret-func4</code> ，但其他的 <code>func</code> 也可能先执行， <code>exec</code> 只会返回一条信息。<br>
</p>
</div>
</div>
<div id="outline-container-org6ed207f" class="outline-2">
<h2 id="org6ed207f">下面这段代码为什么会卡死？</h2>
<div class="outline-text-2" id="text-org6ed207f">
<div class="org-src-container">
<pre class="src src-go"><span style="color: #268bd2; font-weight: bold;">package</span> main

<span style="color: #268bd2; font-weight: bold;">import</span> (
    <span style="color: #2aa198;">"fmt"</span>
    <span style="color: #2aa198;">"runtime"</span>
)

<span style="color: #268bd2; font-weight: bold;">func</span> <span style="color: #d75fd7; font-weight: bold;">main</span>() {
    <span style="color: #268bd2; font-weight: bold;">var</span> <span style="color: #8787d7;">i</span> <span style="color: #df005f; font-weight: bold;">byte</span>
    <span style="color: #268bd2; font-weight: bold;">go</span> <span style="color: #268bd2; font-weight: bold;">func</span>() {
        <span style="color: #268bd2; font-weight: bold;">for</span> i = <span style="color: #d75fd7;">0</span>; i &lt;= <span style="color: #d75fd7;">255</span>; i++ {
        }
    }()
    fmt.<span style="color: #d75fd7; font-weight: bold;">Println</span>(<span style="color: #2aa198;">"Dropping mic"</span>)
    <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">Yield execution to force executing other goroutines</span>
    runtime.<span style="color: #d75fd7; font-weight: bold;">Gosched</span>()
    runtime.<span style="color: #d75fd7; font-weight: bold;">GC</span>()
    fmt.<span style="color: #d75fd7; font-weight: bold;">Println</span>(<span style="color: #2aa198;">"Done"</span>)
}
</pre>
</div>

<p>
Golang 中，byte 其实被 alias 到 uint8 上了。所以上面的 for 循环会始终成立，因为 i++ 到 i=255 的时候会溢出，i &lt;= 255 一定成立。<br>
</p>

<p>
也即是， for 循环永远无法退出，所以上面的代码其实可以等价于这样：<br>
</p>

<div class="org-src-container">
<pre class="src src-go"><span style="color: #268bd2; font-weight: bold;">go</span> <span style="color: #268bd2; font-weight: bold;">func</span>() {
    <span style="color: #268bd2; font-weight: bold;">for</span> {}
}
</pre>
</div>

<p>
正在被执行的 goroutine 发生以下情况时让出当前 goroutine 的执行权，并调度后面的 goroutine 执行：<br>
</p>

<ul class="org-ul">
<li>IO 操作<br></li>
<li>Channel 阻塞<br></li>
<li>system call<br></li>
<li>运行较长时间<br></li>
</ul>

<p>
如果一个 goroutine 执行时间太长，scheduler 会在其 G 对象上打上一个标志（ preempt），当这个 goroutine 内部发生函数调用的时候，会先主动检查这个标志，如果为 true 则会让出执行权。<br>
</p>

<p>
main 函数里启动的 goroutine 其实是一个没有 IO 阻塞、没有 Channel 阻塞、没有 system call、没有函数调用的死循环。<br>
</p>

<p>
也就是，它无法主动让出自己的执行权，即使已经执行很长时间，scheduler 已经标志了 preempt。<br>
</p>

<p>
而 golang 的 GC 动作是需要所有正在运行 <code>goroutine</code> 都停止后进行的。因此，程序会卡在 <code>runtime.GC()</code> 等待所有协程退出。<br>
</p>
</div>
</div>
<div id="outline-container-orgde6b5e8" class="outline-2">
<h2 id="orgde6b5e8">写出下面代码输出内容。</h2>
<div class="outline-text-2" id="text-orgde6b5e8">
<div class="org-src-container">
<pre class="src src-go"><span style="color: #268bd2; font-weight: bold;">package</span> main

<span style="color: #268bd2; font-weight: bold;">import</span> (
    <span style="color: #2aa198;">"fmt"</span>
)

<span style="color: #268bd2; font-weight: bold;">func</span> <span style="color: #d75fd7; font-weight: bold;">main</span>() {
    <span style="color: #d75fd7; font-weight: bold;">defer_call</span>()
}

<span style="color: #268bd2; font-weight: bold;">func</span> <span style="color: #d75fd7; font-weight: bold;">defer_call</span>() {
    <span style="color: #268bd2; font-weight: bold;">defer</span> <span style="color: #268bd2; font-weight: bold;">func</span>() { fmt.<span style="color: #d75fd7; font-weight: bold;">Println</span>(<span style="color: #2aa198;">"&#25171;&#21360;&#21069;"</span>) }()
    <span style="color: #268bd2; font-weight: bold;">defer</span> <span style="color: #268bd2; font-weight: bold;">func</span>() { fmt.<span style="color: #d75fd7; font-weight: bold;">Println</span>(<span style="color: #2aa198;">"&#25171;&#21360;&#20013;"</span>) }()
    <span style="color: #268bd2; font-weight: bold;">defer</span> <span style="color: #268bd2; font-weight: bold;">func</span>() { fmt.<span style="color: #d75fd7; font-weight: bold;">Println</span>(<span style="color: #2aa198;">"&#25171;&#21360;&#21518;"</span>) }()

    <span style="color: #268bd2;">panic</span>(<span style="color: #2aa198;">"&#35302;&#21457;&#24322;&#24120;"</span>)
}
</pre>
</div>

<p>
<code>defer</code> 关键字的实现跟 go 关键字很类似，不同的是它调用的是 <code>runtime.deferproc</code> 而不是 <code>runtime.newproc</code> 。<br>
</p>

<p>
在 <code>defer</code> 出现的地方，插入了指令 <code>call runtime.deferproc</code> ，然后在函数返回之前的地方，插入指令 <code>call runtime.deferreturn</code> 。<br>
</p>

<p>
goroutine 的控制结构中，有一张表记录 <code>defer</code> ，调用 <code>runtime.deferproc</code> 时会将需要defer的表达式记录在表中，而在调用 <code>runtime.deferreturn</code> 的时候，则会依次从 <code>defer</code> 表中出栈并执行。<br>
</p>

<p>
因此，题目最后输出顺序应该是 <code>defer</code> 定义顺序的倒序。 <code>panic</code> 错误并不能终止 <code>defer</code> 的执行。<br>
</p>
</div>
</div>
<div id="outline-container-orga2683b8" class="outline-2">
<h2 id="orga2683b8">以下代码有什么问题，说明原因</h2>
<div class="outline-text-2" id="text-orga2683b8">
<div class="org-src-container">
<pre class="src src-go"><span style="color: #268bd2; font-weight: bold;">type</span> <span style="color: #df005f; font-weight: bold;">student</span> <span style="color: #268bd2; font-weight: bold;">struct</span> {
    Name <span style="color: #df005f; font-weight: bold;">string</span>
    Age  <span style="color: #df005f; font-weight: bold;">int</span>
}

<span style="color: #268bd2; font-weight: bold;">func</span> <span style="color: #d75fd7; font-weight: bold;">pase_student</span>() {
    <span style="color: #8787d7;">m</span> := <span style="color: #268bd2;">make</span>(<span style="color: #268bd2; font-weight: bold;">map</span>[<span style="color: #df005f; font-weight: bold;">string</span>]*<span style="color: #df005f; font-weight: bold;">student</span>)
    <span style="color: #8787d7;">stus</span> := []<span style="color: #df005f; font-weight: bold;">student</span>{
        {<span style="color: #d75fd7;">Name</span>: <span style="color: #2aa198;">"zhou"</span>, <span style="color: #d75fd7;">Age</span>: <span style="color: #d75fd7;">24</span>},
        {<span style="color: #d75fd7;">Name</span>: <span style="color: #2aa198;">"li"</span>, <span style="color: #d75fd7;">Age</span>: <span style="color: #d75fd7;">23</span>},
        {<span style="color: #d75fd7;">Name</span>: <span style="color: #2aa198;">"wang"</span>, <span style="color: #d75fd7;">Age</span>: <span style="color: #d75fd7;">22</span>},
    }
    <span style="color: #268bd2; font-weight: bold;">for</span> <span style="color: #8787d7;">_</span>, <span style="color: #8787d7;">stu</span> := <span style="color: #268bd2; font-weight: bold;">range</span> stus {
        m[stu.Name] = &amp;stu
    }
}
</pre>
</div>

<p>
golang 的 <code>for ... range</code> 语法中， <code>stu</code> 变量会被复用，每次循环会将集合中的值复制给这个变量，因此，会导致最后 <code>m</code> 中的 <code>map</code> 中储存的都是 <code>stus</code> 最后一个 <code>student</code> 的值。<br>
</p>

<div class="org-src-container">
<pre class="src src-go"><span style="color: #268bd2; font-weight: bold;">package</span> main

<span style="color: #268bd2; font-weight: bold;">import</span> <span style="color: #2aa198;">"fmt"</span>

<span style="color: #268bd2; font-weight: bold;">type</span> <span style="color: #df005f; font-weight: bold;">student</span> <span style="color: #268bd2; font-weight: bold;">struct</span> {
    Name <span style="color: #df005f; font-weight: bold;">string</span>
    Age  <span style="color: #df005f; font-weight: bold;">int</span>
}

<span style="color: #268bd2; font-weight: bold;">func</span> <span style="color: #d75fd7; font-weight: bold;">pase_student</span>() {
    <span style="color: #8787d7;">m</span> := <span style="color: #268bd2;">make</span>(<span style="color: #268bd2; font-weight: bold;">map</span>[<span style="color: #df005f; font-weight: bold;">string</span>]*<span style="color: #df005f; font-weight: bold;">student</span>)
    <span style="color: #8787d7;">stus</span> := []<span style="color: #df005f; font-weight: bold;">student</span>{
        {<span style="color: #d75fd7;">Name</span>: <span style="color: #2aa198;">"zhou"</span>, <span style="color: #d75fd7;">Age</span>: <span style="color: #d75fd7;">24</span>},
        {<span style="color: #d75fd7;">Name</span>: <span style="color: #2aa198;">"li"</span>, <span style="color: #d75fd7;">Age</span>: <span style="color: #d75fd7;">23</span>},
        {<span style="color: #d75fd7;">Name</span>: <span style="color: #2aa198;">"wang"</span>, <span style="color: #d75fd7;">Age</span>: <span style="color: #d75fd7;">22</span>},
    }
    <span style="color: #268bd2; font-weight: bold;">for</span> <span style="color: #8787d7;">_</span>, <span style="color: #8787d7;">stu</span> := <span style="color: #268bd2; font-weight: bold;">range</span> stus {
        m[stu.Name] = &amp;stu
        fmt.<span style="color: #d75fd7; font-weight: bold;">Println</span>(stu)
        fmt.<span style="color: #d75fd7; font-weight: bold;">Printf</span>(<span style="color: #2aa198;">"%p\n"</span>, &amp;stu)
    }
}

<span style="color: #268bd2; font-weight: bold;">func</span> <span style="color: #d75fd7; font-weight: bold;">main</span>() {
    <span style="color: #d75fd7; font-weight: bold;">pase_student</span>()
}
</pre>
</div>

<pre class="example" id="org54b6fde">
{zhou 24}
0xc000086018
{li 23}
0xc000086018
{wang 22}
0xc000086018
</pre>
</div>
</div>
<div id="outline-container-org7a15083" class="outline-2">
<h2 id="org7a15083">下面的代码会输出什么，并说明原因</h2>
<div class="outline-text-2" id="text-org7a15083">
<div class="org-src-container">
<pre class="src src-go"><span style="color: #268bd2; font-weight: bold;">func</span> <span style="color: #d75fd7; font-weight: bold;">main</span>() {
    runtime.<span style="color: #d75fd7; font-weight: bold;">GOMAXPROCS</span>(<span style="color: #d75fd7;">1</span>)
    <span style="color: #8787d7;">wg</span> := <span style="color: #df005f; font-weight: bold;">sync.WaitGroup</span>{}
    wg.<span style="color: #d75fd7; font-weight: bold;">Add</span>(<span style="color: #d75fd7;">20</span>)
    <span style="color: #268bd2; font-weight: bold;">for</span> <span style="color: #8787d7;">i</span> := <span style="color: #d75fd7;">0</span>; i &lt; <span style="color: #d75fd7;">10</span>; i++ {
        <span style="color: #268bd2; font-weight: bold;">go</span> <span style="color: #268bd2; font-weight: bold;">func</span>() {
            fmt.<span style="color: #d75fd7; font-weight: bold;">Println</span>(<span style="color: #2aa198;">"i: "</span>, i)
            wg.<span style="color: #d75fd7; font-weight: bold;">Done</span>()
        }()
    }
    <span style="color: #268bd2; font-weight: bold;">for</span> <span style="color: #8787d7;">i</span> := <span style="color: #d75fd7;">0</span>; i &lt; <span style="color: #d75fd7;">10</span>; i++ {
        <span style="color: #268bd2; font-weight: bold;">go</span> <span style="color: #268bd2; font-weight: bold;">func</span>(<span style="color: #8787d7;">i</span> <span style="color: #df005f; font-weight: bold;">int</span>) {
            fmt.<span style="color: #d75fd7; font-weight: bold;">Println</span>(<span style="color: #2aa198;">"i: "</span>, i)
            wg.<span style="color: #d75fd7; font-weight: bold;">Done</span>()
        }(i)
    }
    wg.<span style="color: #d75fd7; font-weight: bold;">Wait</span>()
}
</pre>
</div>

<p>
这个输出结果决定来自于调度器优先调度哪个 G。从 runtime 的源码可以看到，当创建一个 G 时，会优先放入到下一个调度的 <code>runnext</code> 字段上作为下一次优先调度的 G。因此，最先输出的是最后创建的 G，也就是 9.<br>
</p>

<div class="org-src-container">
<pre class="src src-go"><span style="color: #268bd2; font-weight: bold;">func</span> <span style="color: #d75fd7; font-weight: bold;">newproc</span>(<span style="color: #8787d7;">siz</span> <span style="color: #df005f; font-weight: bold;">int32</span>, <span style="color: #8787d7;">fn</span> *<span style="color: #df005f; font-weight: bold;">funcval</span>) {
    <span style="color: #8787d7;">argp</span> := <span style="color: #d75fd7; font-weight: bold;">add</span>(unsafe.<span style="color: #d75fd7; font-weight: bold;">Pointer</span>(&amp;fn), sys.PtrSize)
    <span style="color: #8787d7;">gp</span> := <span style="color: #d75fd7; font-weight: bold;">getg</span>()
    <span style="color: #8787d7;">pc</span> := <span style="color: #d75fd7; font-weight: bold;">getcallerpc</span>()
    <span style="color: #d75fd7; font-weight: bold;">systemstack</span>(<span style="color: #268bd2; font-weight: bold;">func</span>() {
        <span style="color: #8787d7;">newg</span> := <span style="color: #d75fd7; font-weight: bold;">newproc1</span>(fn, argp, siz, gp, pc)

        <span style="color: #8787d7;">_p_</span> := <span style="color: #d75fd7; font-weight: bold;">getg</span>().m.p.<span style="color: #d75fd7; font-weight: bold;">ptr</span>()
        <span style="color: #008787; background-color: #262626;">//</span><span style="color: #008787; background-color: #262626;">&#26032;&#21019;&#24314;&#30340;G&#20250;&#35843;&#29992;&#36825;&#20010;&#26041;&#27861;&#26469;&#20915;&#23450;&#22914;&#20309;&#35843;&#24230;</span>
        <span style="color: #d75fd7; font-weight: bold;">runqput</span>(_p_, newg, <span style="color: #d75fd7;">true</span>)

        <span style="color: #268bd2; font-weight: bold;">if</span> mainStarted {
            <span style="color: #d75fd7; font-weight: bold;">wakep</span>()
        }
    })
}

<span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">...</span>

<span style="color: #268bd2; font-weight: bold;">if</span> next {
<span style="color: #d75fd7;">retryNext</span>:
    <span style="color: #8787d7;">oldnext</span> := _p_.runnext
    <span style="color: #008787; background-color: #262626;">//</span><span style="color: #008787; background-color: #262626;">&#24403;next&#26159;true&#26102;&#24635;&#20250;&#23558;&#26032;&#36827;&#26469;&#30340;G&#25918;&#20837;&#19979;&#19968;&#27425;&#35843;&#24230;&#23383;&#27573;&#20013;</span>
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">!</span>_p_.runnext.<span style="color: #d75fd7; font-weight: bold;">cas</span>(oldnext, <span style="color: #d75fd7; font-weight: bold;">guintptr</span>(unsafe.<span style="color: #d75fd7; font-weight: bold;">Pointer</span>(gp))) {
        <span style="color: #268bd2; font-weight: bold;">goto</span> <span style="color: #d75fd7;">retryNext</span>
    }
    <span style="color: #268bd2; font-weight: bold;">if</span> oldnext == <span style="color: #d75fd7;">0</span> {
        <span style="color: #268bd2; font-weight: bold;">return</span>
    }
    <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">Kick the old runnext out to the regular run queue.</span>
    gp = oldnext.<span style="color: #d75fd7; font-weight: bold;">ptr</span>()
}
</pre>
</div>
</div>
</div>
<div id="outline-container-orgab02cd1" class="outline-2">
<h2 id="orgab02cd1">下面代码会输出什么？</h2>
<div class="outline-text-2" id="text-orgab02cd1">
<p>
```go<br>
type People struct{}<br>
</p>

<p>
func (p *People) ShowA() {<br>
	fmt.Println("showA")<br>
	p.ShowB()<br>
}<br>
func (p *People) ShowB() {<br>
	fmt.Println("showB")<br>
}<br>
</p>

<p>
type Teacher struct {<br>
	People<br>
}<br>
</p>

<p>
func (t *Teacher) ShowB() {<br>
	fmt.Println("teacher showB")<br>
}<br>
</p>

<p>
func main() {<br>
	t := Teacher{}<br>
	t.ShowA()<br>
}<br>
</p>


<p>
```<br>
</p>


<p>
<b><b>解析：</b></b><br>
</p>

<p>
输出结果为`showA`、`showB`。golang 语言中没有继承概念，只有组合，也没有虚方法，更没有重载。因此，`*Teacher` 的 `ShowB` 不会覆写被组合的 `People` 的方法。<br>
</p>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="date">Date: 2022-02-11 00:02 Fri</p>
<p class="author">Author: L.M.haoran</p>
<p class="date">Created: 2022-02-11 Fri 23:21</p>
<p class="validation"><a href="https://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
