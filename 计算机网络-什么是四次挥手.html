<!DOCTYPE html>
<html lang="zh">
<head>
<!-- 2022-03-03 Thu 17:19 -->
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>什么是四次挥手</title>
<meta name="generator" content="Org mode">
<meta name="author" content="L.M.haoran">
<meta name="description" content="Copyright © 2022, L.M.haoran, all rights reserved."
>

                <link rel="stylesheet" href="static/css/org.css" type="text/css"  />
                <script type="module" src="static/js/main.js" defer></script>
                <link rel="shortcut icon" href="images/favicon.ico" type="image/x-icon" />
</head>
<body>
<div id="content">
<h1 class="title">什么是四次挥手</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org7ee5c07">四次挥手的过程</a></li>
<li><a href="#org0b049bb">为什么不能把服务器发送的 ACK 和 FIN 合并起来，变成三次挥手（CLOSE_WAIT 状态意义是什么）？</a></li>
<li><a href="#org392c7fa">如果第二次挥手时服务器的 ACK 没有送达客户端，会怎样？</a></li>
<li><a href="#org7ba4a81">客户端 TIME_WAIT 状态的意义是什么？</a></li>
</ul>
</div>
</div>
<style>
.underline {
		text-decoration-line: underline;
		text-decoration-style: solid;
		text-decoration-color: red;
		text-decoration-thickness: 2px;
}
</style>

<div id="outline-container-org7ee5c07" class="outline-2">
<h2 id="org7ee5c07">四次挥手的过程</h2>
<div class="outline-text-2" id="text-org7ee5c07">
<img src="./images/四次挥手.png" width="650px" />

<ul class="org-ul">
<li>第一次挥手：Client 将 FIN 置为1，发送一个序列号 <span class="underline">seq = M（这里的 M 不是随机生成的，而是上次接收到来自服务端最后一个字节序列号 +1 的结果）</span> 给 Server；进入 <code>FIN_WAIT_1</code> 状态；<br></li>
<li>第二次挥手：Server 收到 FIN 之后，发送一个 ACK = 1， <span class="underline">acknowledge number = 收到的序列号 + 1 = M + 1</span> ；进入 <code>CLOSE_WAIT</code> 状态。此时客户端已经没有要发送的数据了，但仍可以接受服务器发来的数据。<br></li>
<li>第三次挥手：Server 将 FIN 置 1，发送一个序列号 <span class="underline">seq = N（来源同上面 M）</span> 给 Client；进入 <code>LAST_ACK</code> 状态；<br></li>
<li>第四次挥手：Client 收到服务器的 FIN 后，进入 <code>TIME_WAIT</code> 状态；接着将 ACK 置 1，发送一个 <span class="underline">acknowledge number = 序列号 + 1 = N + 1</span> 给服务器；服务器收到后，确认 acknowledge number 后，变为 <code>CLOSED</code> 状态，不再向客户端发送数据。客户端等待 <b>2 * MSL（报文段最长寿命）</b> 时间后，也进入 <code>CLOSED</code> 状态。完成四次挥手。<br></li>
</ul>
</div>
</div>
<div id="outline-container-org0b049bb" class="outline-2">
<h2 id="org0b049bb">为什么不能把服务器发送的 ACK 和 FIN 合并起来，变成三次挥手（CLOSE_WAIT 状态意义是什么）？</h2>
<div class="outline-text-2" id="text-org0b049bb">
<p>
分组交换中，分组到达目的地不是按序的，服务器收到客户端断开连接的请求时，可能还有一些数据没有发完，这时先回复 ACK，表示接收到了断开连接的请求。等到数据发完之后再发 FIN，断开服务器到客户端的数据传送。<br>
</p>
</div>
</div>
<div id="outline-container-org392c7fa" class="outline-2">
<h2 id="org392c7fa">如果第二次挥手时服务器的 ACK 没有送达客户端，会怎样？</h2>
<div class="outline-text-2" id="text-org392c7fa">
<p>
客户端没有收到 ACK 确认，会重新发送 FIN 请求。<br>
</p>
</div>
</div>
<div id="outline-container-org7ba4a81" class="outline-2">
<h2 id="org7ba4a81">客户端 TIME_WAIT 状态的意义是什么？</h2>
<div class="outline-text-2" id="text-org7ba4a81">
<p>
第四次挥手时，客户端发送给服务器的 ACK 有可能丢失， <code>TIME_WAIT</code> 状态就是用来重发可能丢失的 ACK 报文。如果 Server 没有收到 ACK，就会重发 FIN，如果 Client 在 2 * MSL 的时间内收到了 FIN，就会重新发送 ACK 并再次等待 2MSL，防止 Server 没有收到 ACK 而不断重发 FIN。<br>
</p>

<p>
MSL（Maximum Segment Lifetime），指一个片段在网络中最大的存活时间，2MSL 就是一个发送和一个回复所需的最大时间。如果直到 2MSL，Client 都没有再次收到 FIN，那么 Client 推断 ACK 已经被成功接收，则结束 TCP 连接。<br>
</p>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="date">Date: 2022-03-03 16:03 Thu</p>
<p class="author">Author: L.M.haoran</p>
<p class="date">Created: 2022-03-03 Thu 17:19</p>
<p class="validation"><a href="https://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
