<!DOCTYPE html>
<html lang="zh">
<head>
<!-- 2021-09-30 四 22:42 -->
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>定义语法</title>
<meta name="generator" content="Org mode">
<meta name="author" content="L.M.haoran">
<meta name="description" content="Copyright © 2021, L.M.haoran, all rights reserved."
>

                <link rel="stylesheet" href="static/css/org.css" type="text/css"  />
                <script type="module" src="static/js/main.js" defer></script>
                <link rel="shortcut icon" href="images/favicon.ico" type="image/x-icon" />
</head>
<body>
<div id="content">
<h1 class="title">定义语法</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org46971a4">实例：简单宏</a></li>
</ul>
</div>
</div>
<p>
用户定义语法称作宏（Macro），Lisp/Scheme中的宏比C语言中的宏更加强大，宏可以使你的程序优美而紧凑
</p>

<p>
宏是代码的变换，代码在被求值或编译前进行变换
</p>

<p>
你可以在Scheme中通过用符合R5RS规范的syntax-rules轻易地定义简单宏，相比之下，在Common Lisp中自定义语法就复杂多了。使用syntax-rules可以直接定义宏而不用担心变量的捕获（Variable Capture）
</p>

<div id="outline-container-org46971a4" class="outline-2">
<h2 id="org46971a4">实例：简单宏</h2>
<div class="outline-text-2" id="text-org46971a4">
<p>
一个将变量赋值为’()的宏
</p>
<div class="org-src-container">
<pre class="src src-scheme">(define-syntax nil!
	(syntax-rules ()
		((_ x)
		 (set! x '()))))
</pre>
</div>
<p>
syntax-reuls的第二个参数由是变换前表达式构成的表。_代表宏的名字。简言之，代码片段1表示表达式(nil! x)会变换为(set! x '()).
</p>

<p>
这类过程不能通过函数来实现，这是因为函数的闭包性质限制它不能影响外部变量。让我们来用函数实现代码片段1，并观察效果
</p>
<div class="org-src-container">
<pre class="src src-scheme">(define (f-nil! x)
	(set! x '()))
(define a 1)
																				;Value: a

(f-nil! a)
																				;Value: 1

a
																				;Value: 1           ; the value of a dose not change

(nil! a)
																				;Value: 1

a
																				;Value: ()          ; a becomes '()
</pre>
</div>
<p>
我会演示另外一个例子。我们编写宏when，其语义为：当谓词求值为真时，求值相应语句
</p>

<div class="org-src-container">
<pre class="src src-scheme">(define-syntax when
	(syntax-rules ()
		((_ pred b1 ...)
		 (if pred (begin b1 ...)))))
</pre>
</div>
<p>
代码片段2中的&#x2026;代表了任意多个数的表达式（包括0个表达式）。代码片段2揭示了诸如表达式(when pred b1 &#x2026;)会变换为(if pred (begin b1 &#x2026;))
</p>

<p>
由于这个宏是将表达式变换为if特殊形式，因此它不能使用函数来实现。下面的例子演示了如何使用when
</p>

<div class="org-src-container">
<pre class="src src-scheme">(let ((i 0))
	(when (= i 0)
		(display "i == 0")
		(newline)))
i == 0
;;Unspecified return value
</pre>
</div>
<p>
我会演示两个实宏：while和for。只要谓词部分求值为真，while就会对语句体求值。而数字在指定的范围中，for就会对语句体求值
</p>
<div class="org-src-container">
<pre class="src src-scheme">(define-syntax while
	(syntax-rules ()
		((_ pred b1 ...)
		 (let loop () (when pred b1 ... (loop))))))

(define-syntax for
	(syntax-rules ()
		((_ (i from to) b1 ...)
		 (let loop((i from))
			 (when (&lt; i to)
				 b1 ...
				 (loop (1+ i)))))))
</pre>
</div>

<p>
下面演示了如何实用它们：
</p>
<div class="org-src-container">
<pre class="src src-scheme">define-syntax while
(syntax-rules ()
	((_ pred b1 ...)
	 (let loop () (when pred b1 ... (loop))))))

(define-syntax for
(syntax-rules ()
	((_ (i from to) b1 ...)
	 (let loop((i from))
		 (when (&lt; i to)
			 b1 ...
			 (loop (1+ i)))))))
</pre>
</div>
</div>
</div>
</div>
</body>
</html>
