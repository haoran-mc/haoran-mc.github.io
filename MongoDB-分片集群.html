<!DOCTYPE html>
<html lang="zh">
<head>
<!-- 2022-01-30 Sun 00:12 -->
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>MONGODB-分片集群</title>
<meta name="generator" content="Org mode">
<meta name="author" content="L.M.haoran">
<meta name="description" content="Copyright © 2022, L.M.haoran, all rights reserved."
>

                <link rel="stylesheet" href="static/css/org.css" type="text/css"  />
                <script type="module" src="static/js/main.js" defer></script>
                <link rel="shortcut icon" href="images/favicon.ico" type="image/x-icon" />
</head>
<body>
<div id="content">
<h1 class="title">MONGODB-分片集群</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org18507a0">什么是分片</a></li>
<li><a href="#org6b61b48">架构</a></li>
<li><a href="#org23e124c">搭建实例</a>
<ul>
<li><a href="#orgd157f61">1. 集群规划</a></li>
<li><a href="#org91c8c65">2. 创建数据目录</a></li>
<li><a href="#orgd5b893a">3. 启动4个 shard 服务</a>
<ul>
<li><a href="#org358904f">启动 s0、r0</a></li>
<li><a href="#orgbe68e17">启动 s1、r1</a></li>
<li><a href="#org6453604">启动 s2、r2</a></li>
</ul>
</li>
<li><a href="#org19fd7be">4. 启动3个 config 服务</a></li>
<li><a href="#orga986dc5">5. 初始化 config server 副本集</a></li>
<li><a href="#orgccf47f4">6. 启动 mongos 路由服务</a></li>
<li><a href="#orgfc653a3">7. 登录 mongos 服务</a></li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-org18507a0" class="outline-2">
<h2 id="org18507a0">什么是分片</h2>
<div class="outline-text-2" id="text-org18507a0">
<p>
分片（sharding）是指将数据拆分，将其分散存在不同机器的过程，有时也用分区（partitioning）来表示这个概念。将数据分散在不同的机器上，不需要功能强大的大型计算机就能存储更多的数据，处理更大的负载。<br>
</p>

<p>
分片目的时通过分片能够增加更多机器来应对不断的增加负载和数据，还不影响应用运行。<br>
</p>

<p>
MongoDB 支持自动分片，可以摆脱手动分片的管理困扰，集群自动切分数据做负载均衡。MongoDB分片的基本思想就是将集合拆分成多个块，这些块分散在若干个片里，每个片只负责总数据的一部分，应用程序不必知道哪些片对应哪些数据，甚至不需要知道数据拆分了，所以在分片之前会运行一个路由进程，mongos 进程，这个路由器知道所有的数据存放位置，应用只需要直接与 mongos 交互即可。mongos 自动将请求转到相应的片上获取数据，从应用角度看分不分片没有什么区别。<br>
</p>
</div>
</div>
<div id="outline-container-org6b61b48" class="outline-2">
<h2 id="org6b61b48">架构</h2>
<div class="outline-text-2" id="text-org6b61b48">
<img src="./images/MongoDB-Sharding01.svg"/>

<dl class="org-dl">
<dt>Shard</dt><dd>用于存储实际的数据块，实际生产环境中一个 shard server 角色可由几台机器组一个一个 replica set 承担，防止主机单点故障。<br></dd>
<dt>Config Server</dt><dd>MongoDB 实例，存储了整个 Cluster Metadata。<br></dd>
<dt>Query Routers</dt><dd>前端路由，客户端由此接入，且让整个集群看上去像单一数据库，前端应用可以透明使用。<br></dd>
<dt>Shard Key</dt><dd>片键，设置分片时需要在集合中选一个键，用该键的值作为拆分数据的依据，这个片键称之为（shard key），片键的选取很重要，片键的选取决定了数据散列是否均匀。<br></dd>
</dl>
</div>
</div>
<div id="outline-container-org23e124c" class="outline-2">
<h2 id="org23e124c">搭建实例</h2>
<div class="outline-text-2" id="text-org23e124c">
</div>
<div id="outline-container-orgd157f61" class="outline-3">
<h3 id="orgd157f61">1. 集群规划</h3>
<div class="outline-text-3" id="text-orgd157f61">
<pre class="example" id="orgd6a495e">
- Shard Server 1: 27017
- Shard Repl   1: 27018

- Shard Server 2: 27019
- Shard Repl   2: 27020

- Shard Server 3: 27021
- Shard Repl   3: 27022

- Config Server : 27023
- Config Server : 27024
- Config Server : 27025

- Route Process : 27026
</pre>
</div>
</div>
<div id="outline-container-org91c8c65" class="outline-3">
<h3 id="org91c8c65">2. 创建数据目录</h3>
<div class="outline-text-3" id="text-org91c8c65">
<div class="org-src-container">
<pre class="src src-bash">mkdir -p ~/.mongo/cluster/shard/s0
mkdir -p ~/.mongo/cluster/shard/s0-repl

mkdir -p ~/.mongo/cluster/shard/s1
mkdir -p ~/.mongo/cluster/shard/s1-repl

mkdir -p ~/.mongo/cluster/shard/s2
mkdir -p ~/.mongo/cluster/shard/s2-repl

mkdir -p ~/.mongo/cluster/shard/config1
mkdir -p ~/.mongo/cluster/shard/config2
mkdir -p ~/.mongo/cluster/shard/config3
</pre>
</div>
</div>
</div>
<div id="outline-container-orgd5b893a" class="outline-3">
<h3 id="orgd5b893a">3. 启动4个 shard 服务</h3>
<div class="outline-text-3" id="text-orgd5b893a">
</div>
<div id="outline-container-org358904f" class="outline-4">
<h4 id="org358904f">启动 s0、r0</h4>
<div class="outline-text-4" id="text-org358904f">
<div class="org-src-container">
<pre class="src src-bash">./mongod --port <span style="color: #d75fd7;">27017</span> --dbpath /home/haoran/.mongo/cluster/shard/s0 --bind_ip <span style="color: #d75fd7;">0.0.0.0</span> --shardsvr --replSet r0/localhost:27018

./mongod --port <span style="color: #d75fd7;">27018</span> --dbpath /home/haoran/.mongo/cluster/shard/s0-repl --bind_ip <span style="color: #d75fd7;">0.0.0.0</span> --shardsvr --replSet r0/localhost:27017

<span style="color: #008787; background-color: #262626;"># </span><span style="color: #008787; background-color: #262626;">1. &#30331;&#24405;&#20219;&#24847;&#33410;&#28857;</span>
<span style="color: #008787; background-color: #262626;"># </span><span style="color: #008787; background-color: #262626;">2. use admin</span>
<span style="color: #008787; background-color: #262626;"># </span><span style="color: #008787; background-color: #262626;">3. &#25191;&#34892;</span>

<span style="color: #8787d7;">config</span> = {
    _id: <span style="color: #2aa198;">"r0"</span>, members: [
        { _id: <span style="color: #d75fd7;">0,</span> host: <span style="color: #2aa198;">"localhost:27017"</span> },
        { _id: <span style="color: #d75fd7;">1,</span> host: <span style="color: #2aa198;">"localhost:27018"</span> }
    ]
}

<span style="color: #d75fd7; font-weight: bold;">rs.initiate</span>(config)   // &#21021;&#22987;&#21270;
</pre>
</div>
</div>
</div>
<div id="outline-container-orgbe68e17" class="outline-4">
<h4 id="orgbe68e17">启动 s1、r1</h4>
<div class="outline-text-4" id="text-orgbe68e17">
<div class="org-src-container">
<pre class="src src-bash">./mongod --port <span style="color: #d75fd7;">27019</span> --dbpath /home/haoran/.mongo/cluster/shard/s1 --bind_ip <span style="color: #d75fd7;">0.0.0.0</span> --shardsvr --replSet r1/localhost:27020

./mongod --port <span style="color: #d75fd7;">27020</span> --dbpath /home/haoran/.mongo/cluster/shard/s1-repl --bind_ip <span style="color: #d75fd7;">0.0.0.0</span> --shardsvr --replSet r1/localhost:27019

<span style="color: #008787; background-color: #262626;"># </span><span style="color: #008787; background-color: #262626;">1. &#30331;&#24405;&#20219;&#24847;&#33410;&#28857;</span>
<span style="color: #008787; background-color: #262626;"># </span><span style="color: #008787; background-color: #262626;">2. use admin</span>
<span style="color: #008787; background-color: #262626;"># </span><span style="color: #008787; background-color: #262626;">3. &#25191;&#34892;</span>

<span style="color: #8787d7;">config</span> = {
    _id: <span style="color: #2aa198;">"r1"</span>, members: [
        { _id: <span style="color: #d75fd7;">0,</span> host: <span style="color: #2aa198;">"localhost:27019"</span> },
        { _id: <span style="color: #d75fd7;">1,</span> host: <span style="color: #2aa198;">"localhost:27020"</span> }
    ]
}

<span style="color: #d75fd7; font-weight: bold;">rs.initiate</span>(config)   // &#21021;&#22987;&#21270;
</pre>
</div>
</div>
</div>
<div id="outline-container-org6453604" class="outline-4">
<h4 id="org6453604">启动 s2、r2</h4>
<div class="outline-text-4" id="text-org6453604">
<div class="org-src-container">
<pre class="src src-bash">./mongod --port <span style="color: #d75fd7;">27021</span> --dbpath /home/haoran/.mongo/cluster/shard/s2 --bind_ip <span style="color: #d75fd7;">0.0.0.0</span> --shardsvr --replSet r2/localhost:27022

./mongod --port <span style="color: #d75fd7;">27022</span> --dbpath /home/haoran/.mongo/cluster/shard/s2-repl --bind_ip <span style="color: #d75fd7;">0.0.0.0</span> --shardsvr --replSet r2/localhost:27021

<span style="color: #008787; background-color: #262626;"># </span><span style="color: #008787; background-color: #262626;">1. &#30331;&#24405;&#20219;&#24847;&#33410;&#28857;</span>
<span style="color: #008787; background-color: #262626;"># </span><span style="color: #008787; background-color: #262626;">2. use admin</span>
<span style="color: #008787; background-color: #262626;"># </span><span style="color: #008787; background-color: #262626;">3. &#25191;&#34892;</span>

<span style="color: #8787d7;">config</span> = {
    _id: <span style="color: #2aa198;">"r2"</span>, members: [
        { _id: <span style="color: #d75fd7;">0,</span> host: <span style="color: #2aa198;">"localhost:27021"</span> },
        { _id: <span style="color: #d75fd7;">1,</span> host: <span style="color: #2aa198;">"localhost:27022"</span> }
    ]
}

<span style="color: #d75fd7; font-weight: bold;">rs.initiate</span>(config)   // &#21021;&#22987;&#21270;
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org19fd7be" class="outline-3">
<h3 id="org19fd7be">4. 启动3个 config 服务</h3>
<div class="outline-text-3" id="text-org19fd7be">
<div class="org-src-container">
<pre class="src src-bash">./mongod --port <span style="color: #d75fd7;">27023</span> --depath /home/haoran/.mongo/cluster/shard/config1 --bind_ip <span style="color: #d75fd7;">0.0.0.0</span> --replSet config/[local:27024, localhost:27025] --configsvr

./mongod --port <span style="color: #d75fd7;">27024</span> --depath /home/haoran/.mongo/cluster/shard/config2 --bind_ip <span style="color: #d75fd7;">0.0.0.0</span> --replSet config/[local:27023, localhost:27025] --configsvr

./mongod --port <span style="color: #d75fd7;">27025</span> --depath /home/haoran/.mongo/cluster/shard/config3 --bind_ip <span style="color: #d75fd7;">0.0.0.0</span> --replSet config/[local:27023, localhost:27024] --configsvr
</pre>
</div>
</div>
</div>
<div id="outline-container-orga986dc5" class="outline-3">
<h3 id="orga986dc5">5. 初始化 config server 副本集</h3>
<div class="outline-text-3" id="text-orga986dc5">
<div class="org-src-container">
<pre class="src src-bash"><span style="color: #008787; background-color: #262626;"># </span><span style="color: #008787; background-color: #262626;">&#30331;&#24405;&#20219;&#24847;&#33410;&#28857; config server</span>
<span style="color: #008787; background-color: #262626;"># </span><span style="color: #008787; background-color: #262626;">use admin</span>
<span style="color: #008787; background-color: #262626;"># </span><span style="color: #008787; background-color: #262626;">&#22312; admin &#20013;&#25191;&#34892;</span>

var <span style="color: #8787d7;">config</span> = {
    _id: <span style="color: #2aa198;">"config"</span>,
    configsvr: true,
    members: [
        { _id: <span style="color: #d75fd7;">0,</span> host: <span style="color: #2aa198;">"localhost:27023"</span> },
        { _id: <span style="color: #d75fd7;">1,</span> host: <span style="color: #2aa198;">"localhost:27024"</span> },
        { _id: <span style="color: #d75fd7;">2,</span> host: <span style="color: #2aa198;">"localhost:27025"</span> }
    ]
}

<span style="color: #d75fd7; font-weight: bold;">rs.initiate</span>(config)   // &#21021;&#22987;&#21270;&#21103;&#26412;&#38598;&#37197;&#32622;
</pre>
</div>
</div>
</div>
<div id="outline-container-orgccf47f4" class="outline-3">
<h3 id="orgccf47f4">6. 启动 mongos 路由服务</h3>
<div class="outline-text-3" id="text-orgccf47f4">
<div class="org-src-container">
<pre class="src src-bash">mongos --port <span style="color: #d75fd7;">27026</span> --configdb config/localhost:27023, localhost:27024, localhost:27025 --bind_ip <span style="color: #d75fd7;">0.0.0.0</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-orgfc653a3" class="outline-3">
<h3 id="orgfc653a3">7. 登录 mongos 服务</h3>
<div class="outline-text-3" id="text-orgfc653a3">
<ol class="org-ol">
<li>登录 mongo &#x2013;port 27026<br></li>
<li>use admin<br></li>
<li><p>
添加分片信息<br>
</p>

<div class="org-src-container">
<pre class="src src-bash"><span style="color: #d75fd7; font-weight: bold;">db.runCommand</span>({addshard:<span style="color: #2aa198;">"localhost:27017"</span>, <span style="color: #2aa198;">"allowLocal"</span>: true})
<span style="color: #d75fd7; font-weight: bold;">db.runCommand</span>({addshard:<span style="color: #2aa198;">"localhost:27019"</span>, <span style="color: #2aa198;">"allowLocal"</span>: true})
<span style="color: #d75fd7; font-weight: bold;">db.runCommand</span>({addshard:<span style="color: #2aa198;">"localhost:27021"</span>, <span style="color: #2aa198;">"allowLocal"</span>: true})
</pre>
</div></li>

<li><p>
指定分片的数据库<br>
</p>

<div class="org-src-container">
<pre class="src src-bash"><span style="color: #d75fd7; font-weight: bold;">db.runCommand</span>({enablesharding: <span style="color: #2aa198;">"random_db"</span>})
</pre>
</div></li>

<li><p>
设置库的片键信息<br>
</p>

<div class="org-src-container">
<pre class="src src-bash"><span style="color: #008787; background-color: #262626;"># </span><span style="color: #008787; background-color: #262626;">db.runCommand({shardcollection: "random_db.users", key: {_id: 1}})</span>
<span style="color: #d75fd7; font-weight: bold;">db.runCommand</span>({shardcollection: <span style="color: #2aa198;">"random_db.users"</span>, key: {_id: <span style="color: #2aa198;">"hashed"</span>}})
</pre>
</div></li>
</ol>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="date">Date: 2022-01-29 23:01 Sat</p>
<p class="author">Author: L.M.haoran</p>
<p class="date">Created: 2022-01-30 Sun 00:12</p>
<p class="validation"><a href="https://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
