<!DOCTYPE html>
<html lang="zh">
<head>
<!-- 2021-11-07 Sun 23:09 -->
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>GRPC服务调用</title>
<meta name="generator" content="Org mode">
<meta name="author" content="L.M.haoran">
<meta name="description" content="Copyright © 2021, L.M.haoran, all rights reserved."
>

                <link rel="stylesheet" href="static/css/org.css" type="text/css"  />
                <script type="module" src="static/js/main.js" defer></script>
                <link rel="shortcut icon" href="images/favicon.ico" type="image/x-icon" />
</head>
<body>
<div id="content">
<h1 class="title">GRPC服务调用</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#orga53f1ad">proto 文件服务定义</a></li>
<li><a href="#org7245473">编辑 proto 文件</a>
<ul>
<li><a href="#org046077f">环境准备</a></li>
<li><a href="#org1341824">编译 proto 文件</a>
<ul>
<li><a href="#org7afc801">基本用法</a></li>
<li><a href="#org20a80a2">gRPC 编译支持</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#orgb30fa67">gRPC 实现 RPC 调用编程</a>
<ul>
<li><a href="#orgdc5e862">服务接口实现</a></li>
<li><a href="#org8cb836e">gRPC实现服务端</a></li>
<li><a href="#org9eeb623">gRPC实现客户端</a></li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-orga53f1ad" class="outline-2">
<h2 id="orga53f1ad">proto 文件服务定义</h2>
<div class="outline-text-2" id="text-orga53f1ad">
<p>
我们想要实现的是通过gRPC框架进行远程服务调用，首先第一步应该是要有服务。利用之前所掌握的内容，gRPC框架支持对服务的定义和生成。<br>
</p>

<p>
gRPC框架默认使用protocol buffers作为接口定义语言，用于描述网络传输消息结构。除此之外，还可以使用protobuf定义服务接口<br>
</p>

<div class="org-src-container">
<pre class="src src-go">syntax = <span style="color: #FC9F4E;">"proto3"</span>;
<span style="color: #BD93F9;">package</span> message;

option <span style="color: #AFAFAF;">go_package</span> = <span style="color: #FC9F4E;">"./;message"</span>;

<span style="color: #7c7c7c; font-style: italic;">// </span><span style="color: #7c7c7c; font-style: italic;">&#35746;&#21333;&#35831;&#27714;&#21442;&#25968;</span>
message <span style="color: #AFAFAF;">OrderRequest</span> {
    string <span style="color: #AFAFAF;">OrderId</span> = <span style="color: #009F9F;">1</span>;
    int64 <span style="color: #AFAFAF;">timeStamp</span> = <span style="color: #009F9F;">2</span>;
}

<span style="color: #7c7c7c; font-style: italic;">// </span><span style="color: #7c7c7c; font-style: italic;">&#35746;&#21333;&#20449;&#24687;</span>
message <span style="color: #AFAFAF;">OrderInfo</span> {
    string <span style="color: #AFAFAF;">OrderId</span> = <span style="color: #009F9F;">1</span>;
    string <span style="color: #AFAFAF;">OrderName</span> = <span style="color: #009F9F;">2</span>;
    string <span style="color: #AFAFAF;">OrderStatus</span> = <span style="color: #009F9F;">3</span>;
}

<span style="color: #7c7c7c; font-style: italic;">// </span><span style="color: #7c7c7c; font-style: italic;">&#35746;&#21333;&#26381;&#21153;service&#23450;&#20041;</span>
service <span style="color: #AFAFAF;">OrderService</span> {
    rpc <span style="color: #AFAFAF;">GetOrderInfo</span>(OrderRequest) <span style="color: #AFAFAF;">returns</span> (OrderInfo);
}
</pre>
</div>

<p>
我们通过proto文件定义了数据结构的同时，还定义了要实现的服务接口，GetOrderInfo即是具体服务接口的定义，在GetOrderInfo接口定义中，OrderRequest表示是请求传递的参数，OrderInfo表示处理结果返回数据参数。<br>
</p>
</div>
</div>
<div id="outline-container-org7245473" class="outline-2">
<h2 id="org7245473">编辑 proto 文件</h2>
<div class="outline-text-2" id="text-org7245473">
</div>
<div id="outline-container-org046077f" class="outline-3">
<h3 id="org046077f">环境准备</h3>
<div class="outline-text-3" id="text-org046077f">
<p>
定义的proto文件需要通过编译，生成go语言代码文件，供客户端程序和服务端程序使用。可以安装go语言环境中的关于proto的插件（科学上网）。<br>
</p>

<div class="org-src-container">
<pre class="src src-sh">go get -a google.golang.org/protobuf
</pre>
</div>

<p>
-a 参数标示下载好后直接做 go install<br>
</p>
</div>
</div>
<div id="outline-container-org1341824" class="outline-3">
<h3 id="org1341824">编译 proto 文件</h3>
<div class="outline-text-3" id="text-org1341824">
</div>
<div id="outline-container-org7afc801" class="outline-4">
<h4 id="org7afc801">基本用法</h4>
<div class="outline-text-4" id="text-org7afc801">
<p>
可以通过基本编译命令完成对 .proto 文件的编译，基础编译命令如下：<br>
</p>

<div class="org-src-container">
<pre class="src src-sh">protoc --go_out=. *.proto
</pre>
</div>
</div>
</div>
<div id="outline-container-org20a80a2" class="outline-4">
<h4 id="org20a80a2">gRPC 编译支持</h4>
<div class="outline-text-4" id="text-org20a80a2">
<p>
如果定义的.proto文件中包含了服务接口的定义，而我们想要使用gRPC框架实现RPC调用。开发者可以采用protocol-gen-go库提供的插件编译功能，生成兼容gRPC框架的golang语言代码。只需要在基本编译命令的基础上，指定插件的参数，告知protoc编译器即可。具体的编译生成兼容gRPC框架的服务代码的命令如下：<br>
</p>

<div class="org-src-container">
<pre class="src src-sh">protoc --go_out=<span style="color: #AFAFAF;">plugins</span>=grpc:. *.proto
</pre>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-orgb30fa67" class="outline-2">
<h2 id="orgb30fa67">gRPC 实现 RPC 调用编程</h2>
<div class="outline-text-2" id="text-orgb30fa67">
</div>
<div id="outline-container-orgdc5e862" class="outline-3">
<h3 id="orgdc5e862">服务接口实现</h3>
<div class="outline-text-3" id="text-orgdc5e862">
<p>
在.proto定义好服务接口并生成对应的go语言文件后，需要对服务接口做具体的实现。定义服务接口具体由OrderServiceImpl进行实现，并实现GetOrderInfo详细内容，服务实现逻辑与前文所述内容相同。不同点是服务接口参数的变化。详细代码实现如下：<br>
</p>

<div class="org-src-container">
<pre class="src src-go"><span style="color: #BD93F9;">type</span> <span style="color: #AFAFAF;">OrderServiceImpl</span> <span style="color: #BD93F9;">struct</span> {
}

<span style="color: #7c7c7c; font-style: italic;">//</span><span style="color: #7c7c7c; font-style: italic;">&#20855;&#20307;&#30340;&#26041;&#27861;&#23454;&#29616;</span>
<span style="color: #BD93F9;">func</span> (<span style="color: #AFAFAF;">os</span> *<span style="color: #AFAFAF;">OrderServiceImpl</span>) <span style="color: #AFAFAF;">GetOrderInfo</span>(<span style="color: #AFAFAF;">ctx</span> <span style="color: #AFAFAF;">context.Context</span>, <span style="color: #AFAFAF;">request</span> *<span style="color: #AFAFAF;">message.OrderRequest</span>) (*<span style="color: #AFAFAF;">message.OrderInfo</span>, <span style="color: #AFAFAF;">error</span>) {
    <span style="color: #AFAFAF;">orderMap</span> := <span style="color: #BD93F9;">map</span>[<span style="color: #AFAFAF;">string</span>]<span style="color: #AFAFAF;">message.OrderInfo</span>{
        <span style="color: #FC9F4E;">"201907300001"</span>: <span style="color: #AFAFAF;">message.OrderInfo</span>{<span style="color: #009F9F;">OrderId</span>: <span style="color: #FC9F4E;">"201907300001"</span>, <span style="color: #009F9F;">OrderName</span>: <span style="color: #FC9F4E;">"&#34915;&#26381;"</span>, <span style="color: #009F9F;">OrderStatus</span>: <span style="color: #FC9F4E;">"&#24050;&#20184;&#27454;"</span>},
        <span style="color: #FC9F4E;">"201907310001"</span>: <span style="color: #AFAFAF;">message.OrderInfo</span>{<span style="color: #009F9F;">OrderId</span>: <span style="color: #FC9F4E;">"201907310001"</span>, <span style="color: #009F9F;">OrderName</span>: <span style="color: #FC9F4E;">"&#38646;&#39135;"</span>, <span style="color: #009F9F;">OrderStatus</span>: <span style="color: #FC9F4E;">"&#24050;&#20184;&#27454;"</span>},
        <span style="color: #FC9F4E;">"201907310002"</span>: <span style="color: #AFAFAF;">message.OrderInfo</span>{<span style="color: #009F9F;">OrderId</span>: <span style="color: #FC9F4E;">"201907310002"</span>, <span style="color: #009F9F;">OrderName</span>: <span style="color: #FC9F4E;">"&#39135;&#21697;"</span>, <span style="color: #009F9F;">OrderStatus</span>: <span style="color: #FC9F4E;">"&#26410;&#20184;&#27454;"</span>},
    }

    <span style="color: #BD93F9;">var</span> <span style="color: #AFAFAF;">response</span> *<span style="color: #AFAFAF;">message.OrderInfo</span>
    <span style="color: #AFAFAF;">current</span> := time.<span style="color: #AFAFAF;">Now</span>().<span style="color: #AFAFAF;">Unix</span>()
    <span style="color: #BD93F9;">if</span> (request.TimeStamp &gt; current) {
        *response = <span style="color: #AFAFAF;">message.OrderInfo</span>{<span style="color: #009F9F;">OrderId</span>: <span style="color: #FC9F4E;">"0"</span>, <span style="color: #009F9F;">OrderName</span>: <span style="color: #FC9F4E;">""</span>, <span style="color: #009F9F;">OrderStatus</span>: <span style="color: #FC9F4E;">"&#35746;&#21333;&#20449;&#24687;&#24322;&#24120;"</span>}
    } <span style="color: #BD93F9;">else</span> {
        <span style="color: #AFAFAF;">result</span> := orderMap[request.OrderId]
        <span style="color: #BD93F9;">if</span> result.OrderId != <span style="color: #FC9F4E;">""</span> {
            fmt.<span style="color: #AFAFAF;">Println</span>(result)
            <span style="color: #BD93F9;">return</span> &amp;result, <span style="color: #009F9F;">nil</span>
        } <span style="color: #BD93F9;">else</span> {
            <span style="color: #BD93F9;">return</span> <span style="color: #009F9F;">nil</span>, errors.<span style="color: #AFAFAF;">New</span>(<span style="color: #FC9F4E;">"server error"</span>)
        }
    }
    <span style="color: #BD93F9;">return</span> response, <span style="color: #009F9F;">nil</span>
}
</pre>
</div>
</div>
</div>
<div id="outline-container-org8cb836e" class="outline-3">
<h3 id="org8cb836e">gRPC实现服务端</h3>
<div class="outline-text-3" id="text-org8cb836e">
<p>
使用gRPC框架，首先实现服务端的程序。既然使用gRPC框架来实现，就需要调用gRPC进行服务方法的注册以及监听的处理。服务注册和监听处理实现如下：<br>
</p>

<div class="org-src-container">
<pre class="src src-go"><span style="color: #BD93F9;">func</span> <span style="color: #AFAFAF;">main</span>() {

    <span style="color: #AFAFAF;">server</span> := grpc.<span style="color: #AFAFAF;">NewServer</span>()

    message.<span style="color: #AFAFAF;">RegisterOrderServiceServer</span>(server, <span style="color: #AFAFAF;">new</span>(<span style="color: #AFAFAF;">OrderServiceImpl</span>))

    <span style="color: #AFAFAF;">lis</span>, <span style="color: #AFAFAF;">err</span> := net.<span style="color: #AFAFAF;">Listen</span>(<span style="color: #FC9F4E;">"tcp"</span>, <span style="color: #FC9F4E;">":8090"</span>)
    <span style="color: #BD93F9;">if</span> err != <span style="color: #009F9F;">nil</span> {
        <span style="color: #AFAFAF;">panic</span>(err.<span style="color: #AFAFAF;">Error</span>())
    }
    server.<span style="color: #AFAFAF;">Serve</span>(lis)
}
</pre>
</div>
</div>
</div>
<div id="outline-container-org9eeb623" class="outline-3">
<h3 id="org9eeb623">gRPC实现客户端</h3>
<div class="outline-text-3" id="text-org9eeb623">
<p>
实现完服务端以后，实现客户端程序。和服务端程序关系对应，调用gRPC框架的方法获取相应的客户端程序，并实现服务的调用，具体编程实现如下：<br>
</p>

<div class="org-src-container">
<pre class="src src-go"><span style="color: #BD93F9;">func</span> <span style="color: #AFAFAF;">main</span>() {

    <span style="color: #7c7c7c; font-style: italic;">//</span><span style="color: #7c7c7c; font-style: italic;">1&#12289;Dail&#36830;&#25509;</span>
    <span style="color: #AFAFAF;">conn</span>, <span style="color: #AFAFAF;">err</span> := grpc.<span style="color: #AFAFAF;">Dial</span>(<span style="color: #FC9F4E;">"localhost:8090"</span>, grpc.<span style="color: #AFAFAF;">WithInsecure</span>())
    <span style="color: #BD93F9;">if</span> err != <span style="color: #009F9F;">nil</span> {
        <span style="color: #AFAFAF;">panic</span>(err.<span style="color: #AFAFAF;">Error</span>())
    }
    <span style="color: #BD93F9;">defer</span> conn.<span style="color: #AFAFAF;">Close</span>()

    <span style="color: #AFAFAF;">orderServiceClient</span> := message.<span style="color: #AFAFAF;">NewOrderServiceClient</span>(conn)

    <span style="color: #AFAFAF;">orderRequest</span> := &amp;<span style="color: #AFAFAF;">message.OrderRequest</span>{<span style="color: #009F9F;">OrderId</span>: <span style="color: #FC9F4E;">"201907300001"</span>, <span style="color: #009F9F;">TimeStamp</span>: time.<span style="color: #AFAFAF;">Now</span>().<span style="color: #AFAFAF;">Unix</span>()}
    <span style="color: #AFAFAF;">orderInfo</span>, <span style="color: #AFAFAF;">err</span> := orderServiceClient.<span style="color: #AFAFAF;">GetOrderInfo</span>(context.<span style="color: #AFAFAF;">Background</span>(), orderRequest)
    <span style="color: #BD93F9;">if</span> orderInfo != <span style="color: #009F9F;">nil</span> {
        fmt.<span style="color: #AFAFAF;">Println</span>(orderInfo.<span style="color: #AFAFAF;">GetOrderId</span>())
        fmt.<span style="color: #AFAFAF;">Println</span>(orderInfo.<span style="color: #AFAFAF;">GetOrderName</span>())
        fmt.<span style="color: #AFAFAF;">Println</span>(orderInfo.<span style="color: #AFAFAF;">GetOrderStatus</span>())
    }
}
</pre>
</div>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="date">Date: 2021-11-07 21:11 Sun</p>
<p class="author">Author: L.M.haoran</p>
<p class="date">Created: 2021-11-07 Sun 23:09</p>
<p class="validation"><a href="https://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
