<!DOCTYPE html>
<html lang="zh">
<head>
<!-- 2022-02-10 Thu 02:19 -->
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>延迟调用（defer）</title>
<meta name="generator" content="Org mode">
<meta name="author" content="L.M.haoran">
<meta name="description" content="Copyright © 2022, L.M.haoran, all rights reserved."
>

                <link rel="stylesheet" href="static/css/org.css" type="text/css"  />
                <script type="module" src="static/js/main.js" defer></script>
                <link rel="shortcut icon" href="images/favicon.ico" type="image/x-icon" />
</head>
<body>
<div id="content">
<h1 class="title">延迟调用（defer）</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org5f263d6">延迟调用</a>
<ul>
<li><a href="#org22e8f96">defer 特性</a></li>
<li><a href="#org6b2c966">defer 用途</a></li>
<li><a href="#orga02ca92">defer 与闭包</a></li>
<li><a href="#orgfc84fa7">defer f.Close</a></li>
</ul>
</li>
<li><a href="#org9ae8655">延迟调用错误，调用依旧执行</a></li>
<li><a href="#org170a730">延迟调用复制参数</a></li>
<li><a href="#org11b1341">滥用 defer 导致性能问题</a></li>
<li><a href="#org4b19916">defer 陷阱</a>
<ul>
<li><a href="#orga04ee82">defer 与闭包</a></li>
<li><a href="#org4314cac">defer 与 return</a></li>
<li><a href="#orgcf5d73e">defer 与 nil 函数</a></li>
<li><a href="#org98ab476">在错误的位置使用 defer</a></li>
<li><a href="#org361782c">不检查错误</a></li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-org5f263d6" class="outline-2">
<h2 id="org5f263d6">延迟调用</h2>
<div class="outline-text-2" id="text-org5f263d6">
</div>
<div id="outline-container-org22e8f96" class="outline-3">
<h3 id="org22e8f96">defer 特性</h3>
<div class="outline-text-3" id="text-org22e8f96">
<ol class="org-ol">
<li>关键字 defer 用于注册延迟调用。<br></li>
<li>这些调用直到 return 前才被执。因此，可以用来做资源清理。<br></li>
<li>多个defer语句，按先进后出的方式执行。<br></li>
<li>defer语句中的变量，在defer声明时就决定了。<br></li>
</ol>
</div>
</div>
<div id="outline-container-org6b2c966" class="outline-3">
<h3 id="org6b2c966">defer 用途</h3>
<div class="outline-text-3" id="text-org6b2c966">
<ol class="org-ol">
<li>关闭文件句柄<br></li>
<li>锁资源释放<br></li>
<li>数据库连接释放<br></li>
</ol>

<p>
<b>defer 是先进后出</b> ，后面的语句会依赖前面的资源，因此如果先前面的资源先释放了，后面的语句就没法执行了。<br>
</p>

<div class="org-src-container">
<pre class="src src-go"><span style="color: #268bd2; font-weight: bold;">package</span> main

<span style="color: #268bd2; font-weight: bold;">import</span> <span style="color: #2aa198;">"fmt"</span>

<span style="color: #268bd2; font-weight: bold;">func</span> <span style="color: #d75fd7; font-weight: bold;">main</span>() {
    <span style="color: #268bd2; font-weight: bold;">var</span> <span style="color: #8787d7;">whatever</span> [<span style="color: #d75fd7;">5</span>]<span style="color: #268bd2; font-weight: bold;">struct</span>{}

    <span style="color: #268bd2; font-weight: bold;">for</span> <span style="color: #8787d7;">i</span> := <span style="color: #268bd2; font-weight: bold;">range</span> whatever {
        <span style="color: #268bd2; font-weight: bold;">defer</span> fmt.<span style="color: #d75fd7; font-weight: bold;">Println</span>(i)
    }
}
</pre>
</div>

<p>
输出结果：<br>
</p>

<pre class="example" id="org90be46a">
4
3
2
1
0
</pre>
</div>
</div>
<div id="outline-container-orga02ca92" class="outline-3">
<h3 id="orga02ca92">defer 与闭包</h3>
<div class="outline-text-3" id="text-orga02ca92">
<div class="org-src-container">
<pre class="src src-go"><span style="color: #268bd2; font-weight: bold;">package</span> main

<span style="color: #268bd2; font-weight: bold;">import</span> <span style="color: #2aa198;">"fmt"</span>

<span style="color: #268bd2; font-weight: bold;">func</span> <span style="color: #d75fd7; font-weight: bold;">main</span>() {
    <span style="color: #268bd2; font-weight: bold;">var</span> <span style="color: #8787d7;">whatever</span> [<span style="color: #d75fd7;">5</span>]<span style="color: #268bd2; font-weight: bold;">struct</span>{}
    <span style="color: #268bd2; font-weight: bold;">for</span> <span style="color: #8787d7;">i</span> := <span style="color: #268bd2; font-weight: bold;">range</span> whatever {
        <span style="color: #268bd2; font-weight: bold;">defer</span> <span style="color: #268bd2; font-weight: bold;">func</span>() { fmt.<span style="color: #d75fd7; font-weight: bold;">Println</span>(i) }()
    }
}
</pre>
</div>

<p>
输出结果：<br>
</p>

<pre class="example" id="org62d4916">
4
4
4
4
4
</pre>

<blockquote>
<p>
Each time a "defer" statement executes, the function value and parameters to the call are evaluated as usualand saved anew but the actual function is not invoked.<br>
</p>
</blockquote>

<p>
函数正常执行，由于闭包用到的变量 i 在执行的时候已经变成 4，所以都输出 4。<br>
</p>
</div>
</div>
<div id="outline-container-orgfc84fa7" class="outline-3">
<h3 id="orgfc84fa7">defer f.Close</h3>
<div class="outline-text-3" id="text-orgfc84fa7">
<p>
这个大家用的都很频繁,但是go语言编程举了一个可能一不小心会犯错的例子.<br>
</p>

<div class="org-src-container">
<pre class="src src-go"><span style="color: #268bd2; font-weight: bold;">package</span> main

<span style="color: #268bd2; font-weight: bold;">import</span> <span style="color: #2aa198;">"fmt"</span>

<span style="color: #268bd2; font-weight: bold;">type</span> <span style="color: #df005f; font-weight: bold;">Test</span> <span style="color: #268bd2; font-weight: bold;">struct</span> {
    name <span style="color: #df005f; font-weight: bold;">string</span>
}

<span style="color: #268bd2; font-weight: bold;">func</span> (<span style="color: #8787d7;">t</span> *<span style="color: #df005f; font-weight: bold;">Test</span>) <span style="color: #d75fd7; font-weight: bold;">Close</span>() {
    fmt.<span style="color: #d75fd7; font-weight: bold;">Println</span>(t.name, <span style="color: #2aa198;">" closed"</span>)
}

<span style="color: #268bd2; font-weight: bold;">func</span> <span style="color: #d75fd7; font-weight: bold;">main</span>() {
    <span style="color: #8787d7;">ts</span> := []<span style="color: #df005f; font-weight: bold;">Test</span>{{<span style="color: #2aa198;">"a"</span>}, {<span style="color: #2aa198;">"b"</span>}, {<span style="color: #2aa198;">"c"</span>}}
    <span style="color: #268bd2; font-weight: bold;">for</span> <span style="color: #8787d7;">_</span>, <span style="color: #8787d7;">t</span> := <span style="color: #268bd2; font-weight: bold;">range</span> ts {
        <span style="color: #268bd2; font-weight: bold;">defer</span> t.<span style="color: #d75fd7; font-weight: bold;">Close</span>()
    }
}
</pre>
</div>

<p>
输出结果：<br>
</p>

<div class="org-src-container">
<pre class="src src-go">c  <span style="color: #df005f; font-weight: bold;">closed</span>
c  <span style="color: #df005f; font-weight: bold;">closed</span>
c  <span style="color: #df005f; font-weight: bold;">closed</span>
</pre>
</div>

<p>
这个输出并不会像我们预计的输出c b a，而是输出c c c。<br>
</p>

<p>
我们来换一种方式调用一下：<br>
</p>

<div class="org-src-container">
<pre class="src src-go"><span style="color: #268bd2; font-weight: bold;">package</span> main

<span style="color: #268bd2; font-weight: bold;">import</span> <span style="color: #2aa198;">"fmt"</span>

<span style="color: #268bd2; font-weight: bold;">type</span> <span style="color: #df005f; font-weight: bold;">Test</span> <span style="color: #268bd2; font-weight: bold;">struct</span> {
    name <span style="color: #df005f; font-weight: bold;">string</span>
}

<span style="color: #268bd2; font-weight: bold;">func</span> (<span style="color: #8787d7;">t</span> *<span style="color: #df005f; font-weight: bold;">Test</span>) <span style="color: #d75fd7; font-weight: bold;">Close</span>() {
    fmt.<span style="color: #d75fd7; font-weight: bold;">Println</span>(t.name, <span style="color: #2aa198;">" closed"</span>)
}

<span style="color: #268bd2; font-weight: bold;">func</span> <span style="color: #d75fd7; font-weight: bold;">Close</span>(<span style="color: #8787d7;">t</span> <span style="color: #df005f; font-weight: bold;">Test</span>) {
    t.<span style="color: #d75fd7; font-weight: bold;">Close</span>()
}

<span style="color: #268bd2; font-weight: bold;">func</span> <span style="color: #d75fd7; font-weight: bold;">main</span>() {
    <span style="color: #8787d7;">ts</span> := []<span style="color: #df005f; font-weight: bold;">Test</span>{{<span style="color: #2aa198;">"a"</span>}, {<span style="color: #2aa198;">"b"</span>}, {<span style="color: #2aa198;">"c"</span>}}
    <span style="color: #268bd2; font-weight: bold;">for</span> <span style="color: #8787d7;">_</span>, <span style="color: #8787d7;">t</span> := <span style="color: #268bd2; font-weight: bold;">range</span> ts {
        <span style="color: #268bd2; font-weight: bold;">defer</span> <span style="color: #d75fd7; font-weight: bold;">Close</span>(t)
    }
}
</pre>
</div>

<pre class="example" id="org342928c">
c  closed
b  closed
a  closed
</pre>

<p>
当然，如果你不想多写一个函数，也很简单，可以像下面这样，同样会输出c b a。<br>
</p>

<div class="org-src-container">
<pre class="src src-go"><span style="color: #268bd2; font-weight: bold;">package</span> main

<span style="color: #268bd2; font-weight: bold;">import</span> <span style="color: #2aa198;">"fmt"</span>

<span style="color: #268bd2; font-weight: bold;">type</span> <span style="color: #df005f; font-weight: bold;">Test</span> <span style="color: #268bd2; font-weight: bold;">struct</span> {
    name <span style="color: #df005f; font-weight: bold;">string</span>
}

<span style="color: #268bd2; font-weight: bold;">func</span> (<span style="color: #8787d7;">t</span> *<span style="color: #df005f; font-weight: bold;">Test</span>) <span style="color: #d75fd7; font-weight: bold;">Close</span>() {
    fmt.<span style="color: #d75fd7; font-weight: bold;">Println</span>(t.name, <span style="color: #2aa198;">" closed"</span>)
}

<span style="color: #268bd2; font-weight: bold;">func</span> <span style="color: #d75fd7; font-weight: bold;">main</span>() {
    <span style="color: #8787d7;">ts</span> := []<span style="color: #df005f; font-weight: bold;">Test</span>{{<span style="color: #2aa198;">"a"</span>}, {<span style="color: #2aa198;">"b"</span>}, {<span style="color: #2aa198;">"c"</span>}}
    <span style="color: #268bd2; font-weight: bold;">for</span> <span style="color: #8787d7;">_</span>, <span style="color: #8787d7;">t</span> := <span style="color: #268bd2; font-weight: bold;">range</span> ts {
        <span style="color: #8787d7;">t2</span> := t
        <span style="color: #268bd2; font-weight: bold;">defer</span> t2.<span style="color: #d75fd7; font-weight: bold;">Close</span>()
    }
}
</pre>
</div>

<p>
输出结果：<br>
</p>

<pre class="example" id="org8af370a">
c  closed
b  closed
a  closed
</pre>

<p>
通过以上例子，结合<br>
</p>

<blockquote>
<p>
Each time a "defer" statement executes, the function value and parameters to the call are evaluated as usualand saved anew but the actual function is not invoked.<br>
</p>
</blockquote>

<p>
这句话。可以得出下面的结论：<br>
</p>

<p>
defer 后面的语句在执行的时候，函数调用的参数会被保存起来，但是不执行。也就是复制了一份。但是并没有说 struct 这里的 this 指针如何处理，通过这个例子可以看出 go 语言并没有把这个明确写出来的 this 指针当作参数来看待。<br>
</p>
</div>
</div>
</div>
<div id="outline-container-org9ae8655" class="outline-2">
<h2 id="org9ae8655">延迟调用错误，调用依旧执行</h2>
<div class="outline-text-2" id="text-org9ae8655">
<p>
多个 defer 注册，按 FILO 次序执行 ( 先进后出 )。哪怕函数或某个延迟调用发生错误，这些调用依旧会被执行。<br>
</p>

<div class="org-src-container">
<pre class="src src-go"><span style="color: #268bd2; font-weight: bold;">package</span> main

<span style="color: #268bd2; font-weight: bold;">func</span> <span style="color: #d75fd7; font-weight: bold;">test</span>(<span style="color: #8787d7;">x</span> <span style="color: #df005f; font-weight: bold;">int</span>) {
    <span style="color: #268bd2; font-weight: bold;">defer</span> <span style="color: #268bd2;">println</span>(<span style="color: #2aa198;">"a"</span>)
    <span style="color: #268bd2; font-weight: bold;">defer</span> <span style="color: #268bd2;">println</span>(<span style="color: #2aa198;">"b"</span>)

    <span style="color: #268bd2; font-weight: bold;">defer</span> <span style="color: #268bd2; font-weight: bold;">func</span>() {
        <span style="color: #268bd2;">println</span>(<span style="color: #d75fd7;">100</span> / x) <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">div0 &#24322;&#24120;&#26410;&#34987;&#25429;&#33719;&#65292;&#36880;&#27493;&#24448;&#22806;&#20256;&#36882;&#65292;&#26368;&#32456;&#32456;&#27490;&#36827;&#31243;&#12290;</span>
    }()

    <span style="color: #268bd2; font-weight: bold;">defer</span> <span style="color: #268bd2;">println</span>(<span style="color: #2aa198;">"c"</span>)
}

<span style="color: #268bd2; font-weight: bold;">func</span> <span style="color: #d75fd7; font-weight: bold;">main</span>() {
    <span style="color: #d75fd7; font-weight: bold;">test</span>(<span style="color: #d75fd7;">0</span>)
}
</pre>
</div>

<p>
输出结果:<br>
</p>

<pre class="example" id="orgec91acf">
c
b
a
panic: runtime error: integer divide by zero
</pre>
</div>
</div>
<div id="outline-container-org170a730" class="outline-2">
<h2 id="org170a730">延迟调用复制参数</h2>
<div class="outline-text-2" id="text-org170a730">
<p>
延迟调用参数在注册时求值或复制，可用指针或闭包 "延迟" 读取。<br>
</p>

<div class="org-src-container">
<pre class="src src-go"><span style="color: #268bd2; font-weight: bold;">package</span> main

<span style="color: #268bd2; font-weight: bold;">func</span> <span style="color: #d75fd7; font-weight: bold;">test</span>() {
    <span style="color: #8787d7;">x</span>, <span style="color: #8787d7;">y</span> := <span style="color: #d75fd7;">10</span>, <span style="color: #d75fd7;">20</span>

    <span style="color: #268bd2; font-weight: bold;">defer</span> <span style="color: #268bd2; font-weight: bold;">func</span>(<span style="color: #8787d7;">i</span> <span style="color: #df005f; font-weight: bold;">int</span>) {
        <span style="color: #268bd2;">println</span>(<span style="color: #2aa198;">"defer:"</span>, i, y) <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">y &#38381;&#21253;&#24341;&#29992;</span>
    }(x) <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">x &#34987;&#22797;&#21046;</span>

    x += <span style="color: #d75fd7;">10</span>
    y += <span style="color: #d75fd7;">100</span>
    <span style="color: #268bd2;">println</span>(<span style="color: #2aa198;">"x ="</span>, x, <span style="color: #2aa198;">"y ="</span>, y)
}

<span style="color: #268bd2; font-weight: bold;">func</span> <span style="color: #d75fd7; font-weight: bold;">main</span>() {
    <span style="color: #d75fd7; font-weight: bold;">test</span>()
}
</pre>
</div>

<p>
输出结果:<br>
</p>

<pre class="example" id="org66edabf">
x = 20 y = 120
defer: 10 120
</pre>
</div>
</div>
<div id="outline-container-org11b1341" class="outline-2">
<h2 id="org11b1341">滥用 defer 导致性能问题</h2>
<div class="outline-text-2" id="text-org11b1341">
<p>
滥用 defer 可能会导致性能问题，尤其是在一个 "大循环" 里。<br>
</p>

<div class="org-src-container">
<pre class="src src-go"><span style="color: #268bd2; font-weight: bold;">package</span> main

<span style="color: #268bd2; font-weight: bold;">import</span> (
    <span style="color: #2aa198;">"fmt"</span>
    <span style="color: #2aa198;">"sync"</span>
    <span style="color: #2aa198;">"time"</span>
)

<span style="color: #268bd2; font-weight: bold;">var</span> <span style="color: #8787d7;">lock</span> <span style="color: #df005f; font-weight: bold;">sync.Mutex</span>

<span style="color: #268bd2; font-weight: bold;">func</span> <span style="color: #d75fd7; font-weight: bold;">test</span>() {
    lock.<span style="color: #d75fd7; font-weight: bold;">Lock</span>()
    lock.<span style="color: #d75fd7; font-weight: bold;">Unlock</span>()
}

<span style="color: #268bd2; font-weight: bold;">func</span> <span style="color: #d75fd7; font-weight: bold;">testdefer</span>() {
    lock.<span style="color: #d75fd7; font-weight: bold;">Lock</span>()
    <span style="color: #268bd2; font-weight: bold;">defer</span> lock.<span style="color: #d75fd7; font-weight: bold;">Unlock</span>()
}

<span style="color: #268bd2; font-weight: bold;">func</span> <span style="color: #d75fd7; font-weight: bold;">main</span>() {
    <span style="color: #268bd2; font-weight: bold;">func</span>() {
        <span style="color: #8787d7;">t1</span> := time.<span style="color: #d75fd7; font-weight: bold;">Now</span>()

        <span style="color: #268bd2; font-weight: bold;">for</span> <span style="color: #8787d7;">i</span> := <span style="color: #d75fd7;">0</span>; i &lt; <span style="color: #d75fd7;">10000</span>; i++ {
            <span style="color: #d75fd7; font-weight: bold;">test</span>()
        }
        <span style="color: #8787d7;">elapsed</span> := time.<span style="color: #d75fd7; font-weight: bold;">Since</span>(t1)
        fmt.<span style="color: #d75fd7; font-weight: bold;">Println</span>(<span style="color: #2aa198;">"test elapsed: "</span>, elapsed)
    }()
    <span style="color: #268bd2; font-weight: bold;">func</span>() {
        <span style="color: #8787d7;">t1</span> := time.<span style="color: #d75fd7; font-weight: bold;">Now</span>()

        <span style="color: #268bd2; font-weight: bold;">for</span> <span style="color: #8787d7;">i</span> := <span style="color: #d75fd7;">0</span>; i &lt; <span style="color: #d75fd7;">10000</span>; i++ {
            <span style="color: #d75fd7; font-weight: bold;">testdefer</span>()
        }
        <span style="color: #8787d7;">elapsed</span> := time.<span style="color: #d75fd7; font-weight: bold;">Since</span>(t1)
        fmt.<span style="color: #d75fd7; font-weight: bold;">Println</span>(<span style="color: #2aa198;">"testdefer elapsed: "</span>, elapsed)
    }()

}
</pre>
</div>

<p>
输出结果:<br>
</p>

<pre class="example" id="org78206da">
test elapsed:  223.162µs
testdefer elapsed:  781.304µs
</pre>
</div>
</div>
<div id="outline-container-org4b19916" class="outline-2">
<h2 id="org4b19916">defer 陷阱</h2>
<div class="outline-text-2" id="text-org4b19916">
</div>
<div id="outline-container-orga04ee82" class="outline-3">
<h3 id="orga04ee82">defer 与闭包</h3>
<div class="outline-text-3" id="text-orga04ee82">
<div class="org-src-container">
<pre class="src src-go"><span style="color: #268bd2; font-weight: bold;">package</span> main

<span style="color: #268bd2; font-weight: bold;">import</span> (
    <span style="color: #2aa198;">"errors"</span>
    <span style="color: #2aa198;">"fmt"</span>
)

<span style="color: #268bd2; font-weight: bold;">func</span> <span style="color: #d75fd7; font-weight: bold;">foo</span>(<span style="color: #8787d7;">a</span>, <span style="color: #8787d7;">b</span> <span style="color: #df005f; font-weight: bold;">int</span>) (<span style="color: #8787d7;">i</span> <span style="color: #df005f; font-weight: bold;">int</span>, <span style="color: #8787d7;">err</span> <span style="color: #df005f; font-weight: bold;">error</span>) {
    <span style="color: #268bd2; font-weight: bold;">defer</span> fmt.<span style="color: #d75fd7; font-weight: bold;">Printf</span>(<span style="color: #2aa198;">"first defer err %v\n"</span>, err)
    <span style="color: #268bd2; font-weight: bold;">defer</span> <span style="color: #268bd2; font-weight: bold;">func</span>(<span style="color: #8787d7;">err</span> <span style="color: #df005f; font-weight: bold;">error</span>) { fmt.<span style="color: #d75fd7; font-weight: bold;">Printf</span>(<span style="color: #2aa198;">"second defer err %v\n"</span>, err) }(err)
    <span style="color: #268bd2; font-weight: bold;">defer</span> <span style="color: #268bd2; font-weight: bold;">func</span>() { fmt.<span style="color: #d75fd7; font-weight: bold;">Printf</span>(<span style="color: #2aa198;">"third defer err %v\n"</span>, err) }()
    <span style="color: #268bd2; font-weight: bold;">if</span> b == <span style="color: #d75fd7;">0</span> {
        err = errors.<span style="color: #d75fd7; font-weight: bold;">New</span>(<span style="color: #2aa198;">"divided by zero!"</span>)
        <span style="color: #268bd2; font-weight: bold;">return</span>
    }

    i = a / b
    <span style="color: #268bd2; font-weight: bold;">return</span>
}

<span style="color: #268bd2; font-weight: bold;">func</span> <span style="color: #d75fd7; font-weight: bold;">main</span>() {
    <span style="color: #d75fd7; font-weight: bold;">foo</span>(<span style="color: #d75fd7;">2</span>, <span style="color: #d75fd7;">0</span>)
}
</pre>
</div>

<p>
输出结果：<br>
</p>

<pre class="example" id="orgbb815ed">
third defer err divided by zero!
second defer err &lt;nil&gt;
first defer err &lt;nil&gt;
</pre>

<p>
解释：如果 defer 后面跟的不是一个 closure 最后执行的时候我们得到的并不是最新的值。<br>
</p>
</div>
</div>
<div id="outline-container-org4314cac" class="outline-3">
<h3 id="org4314cac">defer 与 return</h3>
<div class="outline-text-3" id="text-org4314cac">
<div class="org-src-container">
<pre class="src src-go"><span style="color: #268bd2; font-weight: bold;">package</span> main

<span style="color: #268bd2; font-weight: bold;">import</span> <span style="color: #2aa198;">"fmt"</span>

<span style="color: #268bd2; font-weight: bold;">func</span> <span style="color: #d75fd7; font-weight: bold;">foo</span>() (<span style="color: #8787d7;">i</span> <span style="color: #df005f; font-weight: bold;">int</span>) {

    i = <span style="color: #d75fd7;">0</span>
    <span style="color: #268bd2; font-weight: bold;">defer</span> <span style="color: #268bd2; font-weight: bold;">func</span>() {
        fmt.<span style="color: #d75fd7; font-weight: bold;">Println</span>(i)
    }()

    <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #d75fd7;">2</span>
}

<span style="color: #268bd2; font-weight: bold;">func</span> <span style="color: #d75fd7; font-weight: bold;">main</span>() {
    <span style="color: #d75fd7; font-weight: bold;">foo</span>()
}
</pre>
</div>

<p>
输出结果：<br>
</p>

<pre class="example" id="orgd43f18a">
2
</pre>

<p>
解释：在有具名返回值的函数中（这里具名返回值为 i），执行 return 2 的时候实际上已经将 i 的值重新赋值为 2。所以defer closure 输出结果为 2 而不是 1。<br>
</p>
</div>
</div>
<div id="outline-container-orgcf5d73e" class="outline-3">
<h3 id="orgcf5d73e">defer 与 nil 函数</h3>
<div class="outline-text-3" id="text-orgcf5d73e">
<div class="org-src-container">
<pre class="src src-go"><span style="color: #268bd2; font-weight: bold;">package</span> main

<span style="color: #268bd2; font-weight: bold;">import</span> (
    <span style="color: #2aa198;">"fmt"</span>
)

<span style="color: #268bd2; font-weight: bold;">func</span> <span style="color: #d75fd7; font-weight: bold;">test</span>() {
    <span style="color: #268bd2; font-weight: bold;">var</span> <span style="color: #8787d7;">run</span> <span style="color: #268bd2; font-weight: bold;">func</span>() = <span style="color: #d75fd7;">nil</span>
    <span style="color: #268bd2; font-weight: bold;">defer</span> <span style="color: #d75fd7; font-weight: bold;">run</span>()
    fmt.<span style="color: #d75fd7; font-weight: bold;">Println</span>(<span style="color: #2aa198;">"runs"</span>)
}

<span style="color: #268bd2; font-weight: bold;">func</span> <span style="color: #d75fd7; font-weight: bold;">main</span>() {
    <span style="color: #268bd2; font-weight: bold;">defer</span> <span style="color: #268bd2; font-weight: bold;">func</span>() {
        <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #8787d7;">err</span> := <span style="color: #268bd2;">recover</span>(); err != <span style="color: #d75fd7;">nil</span> {
            fmt.<span style="color: #d75fd7; font-weight: bold;">Println</span>(err)
        }
    }()
    <span style="color: #d75fd7; font-weight: bold;">test</span>()
}
</pre>
</div>

<p>
输出结果：<br>
</p>

<pre class="example" id="org5c3b7f0">
runs
runtime error: invalid memory address or nil pointer dereference
</pre>

<p>
解释：名为 test 的函数一直运行至结束，然后 defer 函数会被执行且会因为值为 nil 而产生 panic 异常。然而值得注意的是，run() 的声明是没有问题，因为在test函数运行完成后它才会被调用。<br>
</p>
</div>
</div>
<div id="outline-container-org98ab476" class="outline-3">
<h3 id="org98ab476">在错误的位置使用 defer</h3>
<div class="outline-text-3" id="text-org98ab476">
<p>
当 http.Get 失败时会抛出异常。<br>
</p>

<div class="org-src-container">
<pre class="src src-go"><span style="color: #268bd2; font-weight: bold;">package</span> main

<span style="color: #268bd2; font-weight: bold;">import</span> <span style="color: #2aa198;">"net/http"</span>

<span style="color: #268bd2; font-weight: bold;">func</span> <span style="color: #d75fd7; font-weight: bold;">do</span>() <span style="color: #df005f; font-weight: bold;">error</span> {
    <span style="color: #8787d7;">res</span>, <span style="color: #8787d7;">err</span> := http.<span style="color: #d75fd7; font-weight: bold;">Get</span>(<span style="color: #2aa198;">"https://www.wrongUrl.com"</span>)
    <span style="color: #268bd2; font-weight: bold;">defer</span> res.Body.<span style="color: #d75fd7; font-weight: bold;">Close</span>()
    <span style="color: #268bd2; font-weight: bold;">if</span> err != <span style="color: #d75fd7;">nil</span> {
        <span style="color: #268bd2; font-weight: bold;">return</span> err
    }

    <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">..code...</span>

    <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #d75fd7;">nil</span>
}

<span style="color: #268bd2; font-weight: bold;">func</span> <span style="color: #d75fd7; font-weight: bold;">main</span>() {
    <span style="color: #d75fd7; font-weight: bold;">do</span>()
}
</pre>
</div>

<p>
输出结果：<br>
</p>

<pre class="example" id="org2399bc6">
panic: runtime error: invalid memory address or nil pointer dereference
</pre>

<p>
因为在这里我们并没有检查我们的请求是否成功执行，当它失败的时候，我们访问了 Body 中的空变量 res ，因此会抛出异常<br>
</p>

<p>
<b>解决方案：</b><br>
</p>

<p>
总是在一次成功的资源分配下面使用 defer ，对于这种情况来说意味着：当且仅当 http.Get 成功执行时才使用 defer<br>
</p>

<div class="org-src-container">
<pre class="src src-go"><span style="color: #268bd2; font-weight: bold;">package</span> main

<span style="color: #268bd2; font-weight: bold;">import</span> <span style="color: #2aa198;">"net/http"</span>

<span style="color: #268bd2; font-weight: bold;">func</span> <span style="color: #d75fd7; font-weight: bold;">do</span>() <span style="color: #df005f; font-weight: bold;">error</span> {
    <span style="color: #8787d7;">res</span>, <span style="color: #8787d7;">err</span> := http.<span style="color: #d75fd7; font-weight: bold;">Get</span>(<span style="color: #2aa198;">"http://xxxxxxxxxx"</span>)
    <span style="color: #268bd2; font-weight: bold;">if</span> res != <span style="color: #d75fd7;">nil</span> {
        <span style="color: #268bd2; font-weight: bold;">defer</span> res.Body.<span style="color: #d75fd7; font-weight: bold;">Close</span>()
    }

    <span style="color: #268bd2; font-weight: bold;">if</span> err != <span style="color: #d75fd7;">nil</span> {
        <span style="color: #268bd2; font-weight: bold;">return</span> err
    }

    <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">..code...</span>

    <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #d75fd7;">nil</span>
}

<span style="color: #268bd2; font-weight: bold;">func</span> <span style="color: #d75fd7; font-weight: bold;">main</span>() {
    <span style="color: #d75fd7; font-weight: bold;">do</span>()
}
</pre>
</div>

<p>
在上述的代码中，当有错误的时候，err 会被返回，否则当整个函数返回的时候，会关闭 res.Body 。<br>
</p>

<p>
解释：在这里，你同样需要检查 res 的值是否为 nil ，这是 http.Get 中的一个警告。通常情况下，出错的时候，返回的内容应为空并且错误会被返回，可当你获得的是一个重定向 error 时， res 的值并不会为 nil ，但其又会将错误返回。上面的代码保证了无论如何 Body 都会被关闭，如果你没有打算使用其中的数据，那么你还需要丢弃已经接收的数据。<br>
</p>
</div>
</div>
<div id="outline-container-org361782c" class="outline-3">
<h3 id="org361782c">不检查错误</h3>
<div class="outline-text-3" id="text-org361782c">
<p>
在这里，f.Close() 可能会返回一个错误，可这个错误会被我们忽略掉<br>
</p>

<div class="org-src-container">
<pre class="src src-go"><span style="color: #268bd2; font-weight: bold;">package</span> main

<span style="color: #268bd2; font-weight: bold;">import</span> <span style="color: #2aa198;">"os"</span>

<span style="color: #268bd2; font-weight: bold;">func</span> <span style="color: #d75fd7; font-weight: bold;">do</span>() <span style="color: #df005f; font-weight: bold;">error</span> {
    <span style="color: #8787d7;">f</span>, <span style="color: #8787d7;">err</span> := os.<span style="color: #d75fd7; font-weight: bold;">Open</span>(<span style="color: #2aa198;">"book.txt"</span>)
    <span style="color: #268bd2; font-weight: bold;">if</span> err != <span style="color: #d75fd7;">nil</span> {
        <span style="color: #268bd2; font-weight: bold;">return</span> err
    }

    <span style="color: #268bd2; font-weight: bold;">if</span> f != <span style="color: #d75fd7;">nil</span> {
        <span style="color: #268bd2; font-weight: bold;">defer</span> f.<span style="color: #d75fd7; font-weight: bold;">Close</span>()
    }

    <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">..code...</span>

    <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #d75fd7;">nil</span>
}

<span style="color: #268bd2; font-weight: bold;">func</span> <span style="color: #d75fd7; font-weight: bold;">main</span>() {
    <span style="color: #d75fd7; font-weight: bold;">do</span>()
}
</pre>
</div>

<p>
改进一下<br>
</p>

<div class="org-src-container">
<pre class="src src-go"><span style="color: #268bd2; font-weight: bold;">package</span> main

<span style="color: #268bd2; font-weight: bold;">import</span> <span style="color: #2aa198;">"os"</span>

<span style="color: #268bd2; font-weight: bold;">func</span> <span style="color: #d75fd7; font-weight: bold;">do</span>() <span style="color: #df005f; font-weight: bold;">error</span> {
    <span style="color: #8787d7;">f</span>, <span style="color: #8787d7;">err</span> := os.<span style="color: #d75fd7; font-weight: bold;">Open</span>(<span style="color: #2aa198;">"book.txt"</span>)
    <span style="color: #268bd2; font-weight: bold;">if</span> err != <span style="color: #d75fd7;">nil</span> {
        <span style="color: #268bd2; font-weight: bold;">return</span> err
    }

    <span style="color: #268bd2; font-weight: bold;">if</span> f != <span style="color: #d75fd7;">nil</span> {
        <span style="color: #268bd2; font-weight: bold;">defer</span> <span style="color: #268bd2; font-weight: bold;">func</span>() {
            <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #8787d7;">err</span> := f.<span style="color: #d75fd7; font-weight: bold;">Close</span>(); err != <span style="color: #d75fd7;">nil</span> {
                <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">log etc</span>
            }
        }()
    }

    <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">..code...</span>

    <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #d75fd7;">nil</span>
}

<span style="color: #268bd2; font-weight: bold;">func</span> <span style="color: #d75fd7; font-weight: bold;">main</span>() {
    <span style="color: #d75fd7; font-weight: bold;">do</span>()
}
</pre>
</div>

<p>
再改进一下<br>
</p>

<p>
通过命名的返回变量来返回 defer 内的错误。<br>
</p>

<div class="org-src-container">
<pre class="src src-go"><span style="color: #268bd2; font-weight: bold;">package</span> main

<span style="color: #268bd2; font-weight: bold;">import</span> <span style="color: #2aa198;">"os"</span>

<span style="color: #268bd2; font-weight: bold;">func</span> <span style="color: #d75fd7; font-weight: bold;">do</span>() (<span style="color: #8787d7;">err</span> <span style="color: #df005f; font-weight: bold;">error</span>) {
    <span style="color: #8787d7;">f</span>, <span style="color: #8787d7;">err</span> := os.<span style="color: #d75fd7; font-weight: bold;">Open</span>(<span style="color: #2aa198;">"book.txt"</span>)
    <span style="color: #268bd2; font-weight: bold;">if</span> err != <span style="color: #d75fd7;">nil</span> {
        <span style="color: #268bd2; font-weight: bold;">return</span> err
    }

    <span style="color: #268bd2; font-weight: bold;">if</span> f != <span style="color: #d75fd7;">nil</span> {
        <span style="color: #268bd2; font-weight: bold;">defer</span> <span style="color: #268bd2; font-weight: bold;">func</span>() {
            <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #8787d7;">ferr</span> := f.<span style="color: #d75fd7; font-weight: bold;">Close</span>(); ferr != <span style="color: #d75fd7;">nil</span> {
                err = ferr
            }
        }()
    }

    <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">..code...</span>

    <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #d75fd7;">nil</span>
}

<span style="color: #268bd2; font-weight: bold;">func</span> <span style="color: #d75fd7; font-weight: bold;">main</span>() {
    <span style="color: #d75fd7; font-weight: bold;">do</span>()
}
</pre>
</div>

<p>
释放相同的资源<br>
</p>

<p>
如果你尝试使用相同的变量释放不同的资源，那么这个操作可能无法正常执行。<br>
</p>

<div class="org-src-container">
<pre class="src src-go"><span style="color: #268bd2; font-weight: bold;">package</span> main

<span style="color: #268bd2; font-weight: bold;">import</span> (
    <span style="color: #2aa198;">"fmt"</span>
    <span style="color: #2aa198;">"os"</span>
)

<span style="color: #268bd2; font-weight: bold;">func</span> <span style="color: #d75fd7; font-weight: bold;">do</span>() <span style="color: #df005f; font-weight: bold;">error</span> {
    <span style="color: #8787d7;">f</span>, <span style="color: #8787d7;">err</span> := os.<span style="color: #d75fd7; font-weight: bold;">Open</span>(<span style="color: #2aa198;">"book.txt"</span>)
    <span style="color: #268bd2; font-weight: bold;">if</span> err != <span style="color: #d75fd7;">nil</span> {
        <span style="color: #268bd2; font-weight: bold;">return</span> err
    }
    <span style="color: #268bd2; font-weight: bold;">if</span> f != <span style="color: #d75fd7;">nil</span> {
        <span style="color: #268bd2; font-weight: bold;">defer</span> <span style="color: #268bd2; font-weight: bold;">func</span>() {
            <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #8787d7;">err</span> := f.<span style="color: #d75fd7; font-weight: bold;">Close</span>(); err != <span style="color: #d75fd7;">nil</span> {
                fmt.<span style="color: #d75fd7; font-weight: bold;">Printf</span>(<span style="color: #2aa198;">"defer close book.txt err %v\n"</span>, err)
            }
        }()
    }

    <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">..code...</span>

    f, err = os.<span style="color: #d75fd7; font-weight: bold;">Open</span>(<span style="color: #2aa198;">"another-book.txt"</span>)
    <span style="color: #268bd2; font-weight: bold;">if</span> err != <span style="color: #d75fd7;">nil</span> {
        <span style="color: #268bd2; font-weight: bold;">return</span> err
    }
    <span style="color: #268bd2; font-weight: bold;">if</span> f != <span style="color: #d75fd7;">nil</span> {
        <span style="color: #268bd2; font-weight: bold;">defer</span> <span style="color: #268bd2; font-weight: bold;">func</span>() {
            <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #8787d7;">err</span> := f.<span style="color: #d75fd7; font-weight: bold;">Close</span>(); err != <span style="color: #d75fd7;">nil</span> {
                fmt.<span style="color: #d75fd7; font-weight: bold;">Printf</span>(<span style="color: #2aa198;">"defer close another-book.txt err %v\n"</span>, err)
            }
        }()
    }

    <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #d75fd7;">nil</span>
}

<span style="color: #268bd2; font-weight: bold;">func</span> <span style="color: #d75fd7; font-weight: bold;">main</span>() {
    <span style="color: #d75fd7; font-weight: bold;">do</span>()
}
</pre>
</div>

<p>
输出结果： defer close book.txt err close ./another-book.txt: file already closed<br>
</p>

<p>
当延迟函数执行时，只有最后一个变量会被用到，因此，f 变量 会成为最后那个资源 (another-book.txt)。而且两个 defer 都会将这个资源作为最后的资源来关闭<br>
</p>

<p>
解决方案：<br>
</p>

<div class="org-src-container">
<pre class="src src-go"><span style="color: #268bd2; font-weight: bold;">package</span> main

<span style="color: #268bd2; font-weight: bold;">import</span> (
    <span style="color: #2aa198;">"fmt"</span>
    <span style="color: #2aa198;">"io"</span>
    <span style="color: #2aa198;">"os"</span>
)

<span style="color: #268bd2; font-weight: bold;">func</span> <span style="color: #d75fd7; font-weight: bold;">do</span>() <span style="color: #df005f; font-weight: bold;">error</span> {
    <span style="color: #8787d7;">f</span>, <span style="color: #8787d7;">err</span> := os.<span style="color: #d75fd7; font-weight: bold;">Open</span>(<span style="color: #2aa198;">"book.txt"</span>)
    <span style="color: #268bd2; font-weight: bold;">if</span> err != <span style="color: #d75fd7;">nil</span> {
        <span style="color: #268bd2; font-weight: bold;">return</span> err
    }
    <span style="color: #268bd2; font-weight: bold;">if</span> f != <span style="color: #d75fd7;">nil</span> {
        <span style="color: #268bd2; font-weight: bold;">defer</span> <span style="color: #268bd2; font-weight: bold;">func</span>(<span style="color: #8787d7;">f</span> <span style="color: #df005f; font-weight: bold;">io.Closer</span>) {
            <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #8787d7;">err</span> := f.<span style="color: #d75fd7; font-weight: bold;">Close</span>(); err != <span style="color: #d75fd7;">nil</span> {
                fmt.<span style="color: #d75fd7; font-weight: bold;">Printf</span>(<span style="color: #2aa198;">"defer close book.txt err %v\n"</span>, err)
            }
        }(f)
    }

    <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">..code...</span>

    f, err = os.<span style="color: #d75fd7; font-weight: bold;">Open</span>(<span style="color: #2aa198;">"another-book.txt"</span>)
    <span style="color: #268bd2; font-weight: bold;">if</span> err != <span style="color: #d75fd7;">nil</span> {
        <span style="color: #268bd2; font-weight: bold;">return</span> err
    }
    <span style="color: #268bd2; font-weight: bold;">if</span> f != <span style="color: #d75fd7;">nil</span> {
        <span style="color: #268bd2; font-weight: bold;">defer</span> <span style="color: #268bd2; font-weight: bold;">func</span>(<span style="color: #8787d7;">f</span> <span style="color: #df005f; font-weight: bold;">io.Closer</span>) {
            <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #8787d7;">err</span> := f.<span style="color: #d75fd7; font-weight: bold;">Close</span>(); err != <span style="color: #d75fd7;">nil</span> {
                fmt.<span style="color: #d75fd7; font-weight: bold;">Printf</span>(<span style="color: #2aa198;">"defer close another-book.txt err %v\n"</span>, err)
            }
        }(f)
    }

    <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #d75fd7;">nil</span>
}

<span style="color: #268bd2; font-weight: bold;">func</span> <span style="color: #d75fd7; font-weight: bold;">main</span>() {
    <span style="color: #d75fd7; font-weight: bold;">do</span>()
}
</pre>
</div>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="date">Date: 2022-02-10 00:02 Thu</p>
<p class="author">Author: L.M.haoran</p>
<p class="date">Created: 2022-02-10 Thu 02:19</p>
<p class="validation"><a href="https://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
