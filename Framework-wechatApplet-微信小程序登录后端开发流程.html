<!DOCTYPE html>
<html lang="zh">
<head>
<!-- 2022-02-08 Tue 16:24 -->
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>微信小程序登录后端开发流程</title>
<meta name="generator" content="Org mode">
<meta name="author" content="L.M.haoran">
<meta name="description" content="Copyright © 2021, L.M.haoran, all rights reserved."
>

                <link rel="stylesheet" href="static/css/org.css" type="text/css"  />
                <script type="module" src="static/js/main.js" defer></script>
                <link rel="shortcut icon" href="images/favicon.ico" type="image/x-icon" />
</head>
<body>
<div id="content">
<h1 class="title">微信小程序登录后端开发流程</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org305ca61">获取 code</a></li>
<li><a href="#orgb007ff0">换取 OpenID 和 session_key</a>
<ul>
<li><a href="#orgfed3975">接口数据</a>
<ul>
<li><a href="#org946d9e8">请求参数</a></li>
<li><a href="#org79e90e2">返回值</a></li>
<li><a href="#orge454e31">errcode的合法值</a></li>
</ul>
</li>
<li><a href="#orgae97a75">代码实现</a></li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-org305ca61" class="outline-2">
<h2 id="org305ca61">获取 code</h2>
<div class="outline-text-2" id="text-org305ca61">
<p>
<code>code</code> 是从前端获取传到后端，所以只要在 http 中拿到这个参数<br>
</p>
</div>
</div>
<div id="outline-container-orgb007ff0" class="outline-2">
<h2 id="orgb007ff0">换取 OpenID 和 session_key</h2>
<div class="outline-text-2" id="text-orgb007ff0">
<p>
利用 <code>code</code> 获取 <code>OpenID</code> 和 <code>session_key</code> ，使用微信官方文档中给的接口：<br>
</p>

<pre class="example" id="orge28e1d6">
GET https://api.weixin.qq.com/sns/jscode2session?appid=APPID&amp;secret=SECRET&amp;js_code=JSCODE&amp;grant_type=authorization_code
</pre>
</div>
<div id="outline-container-orgfed3975" class="outline-3">
<h3 id="orgfed3975">接口数据</h3>
<div class="outline-text-3" id="text-orgfed3975">
</div>
<div id="outline-container-org946d9e8" class="outline-4">
<h4 id="org946d9e8">请求参数</h4>
<div class="outline-text-4" id="text-org946d9e8">
<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">

<col  class="org-left">

<col  class="org-left">

<col  class="org-left">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">属性</th>
<th scope="col" class="org-left">类型</th>
<th scope="col" class="org-left">默认值</th>
<th scope="col" class="org-left">必填</th>
<th scope="col" class="org-left">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">appid</td>
<td class="org-left">string</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">是</td>
<td class="org-left">小程序的 appId</td>
</tr>

<tr>
<td class="org-left">secret</td>
<td class="org-left">string</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">是</td>
<td class="org-left">小程序的 appSecret</td>
</tr>

<tr>
<td class="org-left">js_code</td>
<td class="org-left">string</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">是</td>
<td class="org-left">登录时获取的 code</td>
</tr>

<tr>
<td class="org-left">grant_type</td>
<td class="org-left">string</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">是</td>
<td class="org-left">授权类型，此处只需要填写 authorization_code</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="outline-container-org79e90e2" class="outline-4">
<h4 id="org79e90e2">返回值</h4>
<div class="outline-text-4" id="text-org79e90e2">
<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">

<col  class="org-left">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">属性</th>
<th scope="col" class="org-left">类型</th>
<th scope="col" class="org-left">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">openid</td>
<td class="org-left">string</td>
<td class="org-left">用户唯一标识</td>
</tr>

<tr>
<td class="org-left">seesion_key</td>
<td class="org-left">string</td>
<td class="org-left">会话密钥</td>
</tr>

<tr>
<td class="org-left">unionid</td>
<td class="org-left">string</td>
<td class="org-left">用户在开放平台的唯一标识符，若当前小程序已绑定到微信开放平台帐号下会返回，详见<a href="https://developers.weixin.qq.com/miniprogram/dev/framework/open-ability/union-id.html">UnionID机制说明</a></td>
</tr>

<tr>
<td class="org-left">errcode</td>
<td class="org-left">number</td>
<td class="org-left">错误码</td>
</tr>

<tr>
<td class="org-left">errmsg</td>
<td class="org-left">string</td>
<td class="org-left">错误信息</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="outline-container-orge454e31" class="outline-4">
<h4 id="orge454e31">errcode的合法值</h4>
<div class="outline-text-4" id="text-orge454e31">
<table>


<colgroup>
<col  class="org-right">

<col  class="org-left">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-right">值</th>
<th scope="col" class="org-left">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-right">-1</td>
<td class="org-left">系统繁忙，此时请开发者稍候再试</td>
</tr>

<tr>
<td class="org-right">0</td>
<td class="org-left">请求成功</td>
</tr>

<tr>
<td class="org-right">40029</td>
<td class="org-left">code 无效</td>
</tr>

<tr>
<td class="org-right">45011</td>
<td class="org-left">频率限制，每个用户每分钟100次</td>
</tr>

<tr>
<td class="org-right">40226</td>
<td class="org-left">高风险等级用户，小程序登录拦截 。风险等级详见用户安全解方案</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div id="outline-container-orgae97a75" class="outline-3">
<h3 id="orgae97a75">代码实现</h3>
<div class="outline-text-3" id="text-orgae97a75">
<p>
定义返回值数据结构：<br>
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #268bd2; font-weight: bold;">type</span> <span style="color: #df005f; font-weight: bold;">WXLoginResp</span> <span style="color: #268bd2; font-weight: bold;">struct</span> {
    OpenId <span style="color: #df005f; font-weight: bold;">string</span>           <span style="color: #2aa198;">`json:"openid"`</span>
    SessionKey <span style="color: #df005f; font-weight: bold;">string</span>   <span style="color: #2aa198;">`json:"session_key"`</span>
    UnionId <span style="color: #df005f; font-weight: bold;">string</span>          <span style="color: #2aa198;">`json:"unionid"`</span>
    ErrCode <span style="color: #df005f; font-weight: bold;">int</span>             <span style="color: #2aa198;">`json:"errcode"`</span>
    ErrMsg <span style="color: #df005f; font-weight: bold;">string</span>           <span style="color: #2aa198;">`json:"errmsg"`</span>
}
</pre>
</div>

<p>
定义通过 <code>code</code> 获取 <code>OpenID</code> 和 <code>session_key</code> 的函数：<br>
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">&#20256;&#20837;&#20174;&#21069;&#31471;&#33719;&#21462;&#30340; code&#65292;&#36820;&#22238;&#35843;&#29992;&#24494;&#20449;&#25509;&#21475;&#24471;&#21040;&#30340;&#23545;&#35937;&#25351;&#38024;&#21644;&#24322;&#24120;</span>
<span style="color: #268bd2; font-weight: bold;">func</span> <span style="color: #d75fd7; font-weight: bold;">wxLogin</span>(<span style="color: #8787d7;">code</span> <span style="color: #df005f; font-weight: bold;">string</span>) (*<span style="color: #df005f; font-weight: bold;">WXLoginResp</span>, <span style="color: #df005f; font-weight: bold;">error</span>) {
    <span style="color: #8787d7;">code2sessionURL</span> := <span style="color: #2aa198;">"https://api.weixin.qq.com/sns/jscode2session?appid=%s&amp;secret=%s&amp;js_code=%s&amp;grant_type=authorization_code"</span>

    <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">&#21512;&#25104;url, &#36825;&#37324;&#30340; appID &#21644; appSecret &#26159;&#22312;&#24494;&#20449;&#20844;&#20247;&#24179;&#21488;&#19978;&#33719;&#21462;&#30340;</span>
    <span style="color: #8787d7;">appID</span> := <span style="color: #2aa198;">""</span>
    <span style="color: #8787d7;">appSecret</span> := <span style="color: #2aa198;">""</span>
    <span style="color: #8787d7;">url</span> := fmt.<span style="color: #d75fd7; font-weight: bold;">Sprintf</span>(code2sessionURL, appID, appSecret, code)  

    <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">get&#35831;&#27714;</span>
    <span style="color: #8787d7;">resp</span>, <span style="color: #8787d7;">err</span> := http.DefaultClient.<span style="color: #d75fd7; font-weight: bold;">Get</span>(url)

    <span style="color: #268bd2; font-weight: bold;">if</span> err != <span style="color: #d75fd7;">nil</span> {
        <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #d75fd7;">nil</span>, err
    }
    <span style="color: #268bd2; font-weight: bold;">defer</span> resp.Body.<span style="color: #d75fd7; font-weight: bold;">Close</span>()

    <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">&#35299;&#26512;http&#35831;&#27714;&#20013; body &#25968;&#25454;&#21040;&#25105;&#20204;&#23450;&#20041;&#30340;&#32467;&#26500;&#20307;&#20013;</span>
    <span style="color: #8787d7;">wxResp</span> := <span style="color: #df005f; font-weight: bold;">WXLoginResp</span>{}
    <span style="color: #8787d7;">decoder</span> := json.<span style="color: #d75fd7; font-weight: bold;">NewDecoder</span>(resp.Body)
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #8787d7;">err</span> := decoder.<span style="color: #d75fd7; font-weight: bold;">Decode</span>(&amp;wxResp); err != <span style="color: #d75fd7;">nil</span> {
        <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #d75fd7;">nil</span>, err
    }

    <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">&#21028;&#26029;&#24494;&#20449;&#25509;&#21475;&#36820;&#22238;&#30340;&#26159;&#21542;&#26159;&#19968;&#20010;&#24322;&#24120;&#24773;&#20917;</span>
    <span style="color: #268bd2; font-weight: bold;">if</span> wxResp.ErrCode != <span style="color: #d75fd7;">0</span> {
        <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #d75fd7;">nil</span>, errors.<span style="color: #d75fd7; font-weight: bold;">New</span>(fmt.<span style="color: #d75fd7; font-weight: bold;">Sprintf</span>(<span style="color: #2aa198;">"ErrCode:%s  ErrMsg:%s"</span>, wxResp.ErrCode, wxResp.ErrMsg))
    }

    <span style="color: #268bd2; font-weight: bold;">return</span> &amp;wxResp, <span style="color: #d75fd7;">nil</span>
}
</pre>
</div>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="date">Date: 2021-09-07 12:09 二</p>
<p class="author">Author: L.M.haoran</p>
<p class="date">Created: 2022-02-08 Tue 16:24</p>
<p class="validation"><a href="https://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
