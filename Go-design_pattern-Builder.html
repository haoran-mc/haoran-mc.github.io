<!DOCTYPE html>
<html lang="zh">
<head>
<!-- 2022-07-09 Sat 16:09 -->
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>建造者模式</title>
<meta name="generator" content="Org mode">
<meta name="author" content="L.M.haoran">
<meta name="description" content="Copyright © 2022, L.M.haoran, all rights reserved."
>

                <link rel="stylesheet" href="static/css/org.css" type="text/css"  />
                <script type="module" src="static/js/main.js" defer></script>
                <link rel="shortcut icon" href="images/favicon.ico" type="image/x-icon" />
</head>
<body>
<div id="content">
<h1 class="title">建造者模式</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#orga94d45e">模式动机</a></li>
<li><a href="#org6e9f7ed">go 实现</a>
<ul>
<li><a href="#org3feb70a">构造者实现</a></li>
<li><a href="#org5d0a7e9">自参考函数</a></li>
</ul>
</li>
<li><a href="#orgaddb710">模式分析</a></li>
<li><a href="#orgdb98df9">建造者模式的优缺点</a></li>
<li><a href="#orgafa1a61">适用环境</a></li>
</ul>
</div>
</div>

<div id="outline-container-orga94d45e" class="outline-2">
<h2 id="orga94d45e">模式动机</h2>
<div class="outline-text-2" id="text-orga94d45e">
<p>
无论是在现实世界中还是在软件系统中，都存在一些复杂的对象，它们拥有多个组成部分，如汽车，它包括车轮、方向盘、发送机等各种部件。而对于大多数用户而言，无须知道这些部件的装配细节，也几乎不会使用单独某个部件，而是使用一辆完整的汽车，可以通过建造者模式对其进行设计与描述，建造者模式可以将部件和其组装过程分开，一步一步创建一个复杂的对象。用户只需要指定复杂对象的类型就可以得到该对象，而无须知道其内部的具体构造细节。<br>
</p>

<p>
在软件开发中，也存在大量类似汽车一样的复杂对象，它们拥有一系列成员属性，这些成员属性中有些是引用类型的成员对象。而且在这些复杂对象中，还可能存在一些限制条件，如某些属性没有赋值则复杂对象不能作为一个完整的产品使用；有些属性的赋值必须按照某个顺序，一个属性没有赋值之前，另一个属性可能无法赋值等。<br>
</p>

<p>
复杂对象相当于一辆有待建造的汽车，而对象的属性相当于汽车的部件，建造产品的过程就相当于组合部件的过程。由于组合部件的过程很复杂，因此，这些部件的组合过程往往被“外部化”到一个称作建造者的对象里，建造者返还给客户端的是一个已经建造完毕的完整产品对象，而用户无须关心该对象所包含的属性以及它们的组装方式，这就是建造者模式的模式动机。<br>
</p>
</div>
</div>
<div id="outline-container-org6e9f7ed" class="outline-2">
<h2 id="org6e9f7ed">go 实现</h2>
<div class="outline-text-2" id="text-org6e9f7ed">
<p>
我们需要定义一个资源池配置类 ResourcePoolConfig。这里的资源池，你可以简单理解为线程池、连接池、对象池等。在这个资源池配置类中，有以下几个成员变量，也就是可配置项。现在，请你编写代码实现这个 ResourcePoolConfig 类。<br>
</p>

<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">

<col  class="org-left">

<col  class="org-right">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">成员变量</th>
<th scope="col" class="org-left">解释</th>
<th scope="col" class="org-left">是否必填？</th>
<th scope="col" class="org-right">默认值</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">name</td>
<td class="org-left">资源名称</td>
<td class="org-left">是</td>
<td class="org-right">没有</td>
</tr>

<tr>
<td class="org-left">maxTotal</td>
<td class="org-left">最大总资源数量</td>
<td class="org-left">否</td>
<td class="org-right">8</td>
</tr>

<tr>
<td class="org-left">maxIdle</td>
<td class="org-left">最大空闲资源数量</td>
<td class="org-left">否</td>
<td class="org-right">8</td>
</tr>

<tr>
<td class="org-left">minIdle</td>
<td class="org-left">最小空闲资源数量</td>
<td class="org-left">否</td>
<td class="org-right">0</td>
</tr>
</tbody>
</table>
</div>
<div id="outline-container-org3feb70a" class="outline-3">
<h3 id="org3feb70a">构造者实现</h3>
<div class="outline-text-3" id="text-org3feb70a">
<div class="org-src-container">
<pre class="src src-go"><span style="color: #268bd2; font-weight: bold;">const</span> (
    <span style="color: #d75fd7;">defaultMaxTotal</span> = 10
    <span style="color: #d75fd7;">defaultMaxIdle</span>  = 9
    <span style="color: #d75fd7;">defaultMinIdle</span>  = 1
)

<span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">ResourcePoolConfig &#36164;&#28304;&#27744;&#37197;&#32622;</span>
<span style="color: #268bd2; font-weight: bold;">type</span> <span style="color: #df005f; font-weight: bold;">ResourcePoolConfig</span> <span style="color: #268bd2; font-weight: bold;">struct</span> {
    name     <span style="color: #df005f; font-weight: bold;">string</span>
    maxTotal <span style="color: #df005f; font-weight: bold;">int</span>
    maxIdle  <span style="color: #df005f; font-weight: bold;">int</span>
    minIdle  <span style="color: #df005f; font-weight: bold;">int</span>
}

<span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">ResourcePoolConfigBuilder &#29992;&#20110;&#26500;&#24314;&#36164;&#28304;&#27744;&#37197;&#32622;&#31867;</span>
<span style="color: #268bd2; font-weight: bold;">type</span> <span style="color: #df005f; font-weight: bold;">ResourcePoolConfigBuilder</span> <span style="color: #268bd2; font-weight: bold;">struct</span> {
    name     <span style="color: #df005f; font-weight: bold;">string</span>
    maxTotal <span style="color: #df005f; font-weight: bold;">int</span>
    maxIdle  <span style="color: #df005f; font-weight: bold;">int</span>
    minIdle  <span style="color: #df005f; font-weight: bold;">int</span>
}

<span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">SetName &#35774;&#32622;&#36164;&#28304;&#27744;&#37197;&#32622;&#31867;&#30340;&#32452;&#25104;&#37096;&#20998;&#65292;&#36825;&#37324;&#35774;&#32622;&#21517;&#31216;&#65288;name&#65289;</span>
<span style="color: #268bd2; font-weight: bold;">func</span> (<span style="color: #8787d7;">b</span> *<span style="color: #df005f; font-weight: bold;">ResourcePoolConfigBuilder</span>) <span style="color: #d75fd7; font-weight: bold;">SetName</span>(<span style="color: #8787d7;">name</span> <span style="color: #df005f; font-weight: bold;">string</span>) <span style="color: #df005f; font-weight: bold;">error</span> {
    <span style="color: #268bd2; font-weight: bold;">if</span> name == <span style="color: #2aa198;">""</span> {
        <span style="color: #268bd2; font-weight: bold;">return</span> fmt.<span style="color: #d75fd7; font-weight: bold;">Errorf</span>(<span style="color: #2aa198;">"name can not be empty"</span>)
    }
    b.name = name
    <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #d75fd7;">nil</span>
}

<span style="color: #268bd2; font-weight: bold;">func</span> (<span style="color: #8787d7;">b</span> *<span style="color: #df005f; font-weight: bold;">ResourcePoolConfigBuilder</span>) <span style="color: #d75fd7; font-weight: bold;">SetMinIdle</span>(<span style="color: #8787d7;">minIdle</span> <span style="color: #df005f; font-weight: bold;">int</span>) <span style="color: #df005f; font-weight: bold;">error</span> {
    <span style="color: #268bd2; font-weight: bold;">if</span> minIdle &lt; 0 {
        <span style="color: #268bd2; font-weight: bold;">return</span> fmt.<span style="color: #d75fd7; font-weight: bold;">Errorf</span>(<span style="color: #2aa198;">"max tatal cannot &lt; 0, input: %d"</span>, minIdle)
    }
    b.minIdle = minIdle
    <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #d75fd7;">nil</span>
}

<span style="color: #268bd2; font-weight: bold;">func</span> (<span style="color: #8787d7;">b</span> *<span style="color: #df005f; font-weight: bold;">ResourcePoolConfigBuilder</span>) <span style="color: #d75fd7; font-weight: bold;">SetMaxIdle</span>(<span style="color: #8787d7;">maxIdle</span> <span style="color: #df005f; font-weight: bold;">int</span>) <span style="color: #df005f; font-weight: bold;">error</span> {
    <span style="color: #268bd2; font-weight: bold;">if</span> maxIdle &lt; 0 {
        <span style="color: #268bd2; font-weight: bold;">return</span> fmt.<span style="color: #d75fd7; font-weight: bold;">Errorf</span>(<span style="color: #2aa198;">"max tatal cannot &lt; 0, input: %d"</span>, maxIdle)
    }
    b.maxIdle = maxIdle
    <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #d75fd7;">nil</span>
}

<span style="color: #268bd2; font-weight: bold;">func</span> (<span style="color: #8787d7;">b</span> *<span style="color: #df005f; font-weight: bold;">ResourcePoolConfigBuilder</span>) <span style="color: #d75fd7; font-weight: bold;">SetMaxTotal</span>(<span style="color: #8787d7;">maxTotal</span> <span style="color: #df005f; font-weight: bold;">int</span>) <span style="color: #df005f; font-weight: bold;">error</span> {
    <span style="color: #268bd2; font-weight: bold;">if</span> maxTotal &lt;= 0 {
        <span style="color: #268bd2; font-weight: bold;">return</span> fmt.<span style="color: #d75fd7; font-weight: bold;">Errorf</span>(<span style="color: #2aa198;">"max tatal cannot &lt;= 0, input: %d"</span>, maxTotal)
    }
    b.maxTotal = maxTotal
    <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #d75fd7;">nil</span>
}

<span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">Build &#20351;&#29992;&#26500;&#24314;&#31867;&#26500;&#24314;</span>
<span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">&#32452;&#35013;&#36825;&#20123;&#37096;&#20214;&#21487;&#33021;&#20250;&#24456;&#40635;&#28902;&#65292;&#25152;&#20197;&#20351;&#29992;&#24314;&#36896;&#32773;&#22312;&#36825;&#37324;&#32479;&#19968;&#32452;&#35013;&#65292;&#21487;&#33021;&#36935;&#21040;&#30340;&#40635;&#28902;&#65306;</span>
<span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">&#37096;&#20214;&#23384;&#22312;&#38480;&#21046;&#26465;&#20214;&#12289;&#37096;&#20214;&#30340;&#36171;&#20540;&#24517;&#39035;&#25353;&#29031;&#26576;&#20010;&#39034;&#24207;&#12289;&#19968;&#20010;&#23646;&#24615;&#27809;&#26377;&#36171;&#20540;&#20043;&#21069;&#65292;&#21478;&#19968;&#20010;&#23646;&#24615;&#21487;&#33021;&#26080;&#27861;&#36171;&#20540;&#31561;</span>
<span style="color: #268bd2; font-weight: bold;">func</span> (<span style="color: #8787d7;">b</span> *<span style="color: #df005f; font-weight: bold;">ResourcePoolConfigBuilder</span>) <span style="color: #d75fd7; font-weight: bold;">Build</span>() (*<span style="color: #df005f; font-weight: bold;">ResourcePoolConfig</span>, <span style="color: #df005f; font-weight: bold;">error</span>) {
    <span style="color: #268bd2; font-weight: bold;">if</span> b.name == <span style="color: #2aa198;">""</span> {
        <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #d75fd7;">nil</span>, fmt.<span style="color: #d75fd7; font-weight: bold;">Errorf</span>(<span style="color: #2aa198;">"name can not be empty"</span>)
    }

    <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">&#35774;&#32622;&#40664;&#35748;&#20540;</span>
    <span style="color: #268bd2; font-weight: bold;">if</span> b.minIdle == 0 {
        b.minIdle = defaultMinIdle
    }

    <span style="color: #268bd2; font-weight: bold;">if</span> b.maxIdle == 0 {
        b.maxIdle = defaultMaxIdle
    }

    <span style="color: #268bd2; font-weight: bold;">if</span> b.maxTotal == 0 {
        b.maxTotal = defaultMaxTotal
    }

    <span style="color: #268bd2; font-weight: bold;">if</span> b.maxTotal &lt; b.maxIdle {
        <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #d75fd7;">nil</span>, fmt.<span style="color: #d75fd7; font-weight: bold;">Errorf</span>(<span style="color: #2aa198;">"max total(%d) cannot &lt; max idle(%d)"</span>, b.maxTotal, b.maxIdle)
    }

    <span style="color: #268bd2; font-weight: bold;">if</span> b.minIdle &gt; b.maxIdle {
        <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #d75fd7;">nil</span>, fmt.<span style="color: #d75fd7; font-weight: bold;">Errorf</span>(<span style="color: #2aa198;">"max idle(%d) cannot &lt; min idle(%d)"</span>, b.maxIdle, b.minIdle)
    }

    <span style="color: #268bd2; font-weight: bold;">return</span> &amp;<span style="color: #df005f; font-weight: bold;">ResourcePoolConfig</span>{
        <span style="color: #d75fd7;">name</span>:     b.name,
        <span style="color: #d75fd7;">maxTotal</span>: b.maxTotal,
        <span style="color: #d75fd7;">maxIdle</span>:  b.maxIdle,
        <span style="color: #d75fd7;">minIdle</span>:  b.minIdle,
    }, <span style="color: #d75fd7;">nil</span>
} 
</pre>
</div>

<p>
如何使用这个代码（忽略了错误处理）：<br>
</p>

<div class="org-src-container">
<pre class="src src-go"><span style="color: #8787d7;">builder</span> := &amp;<span style="color: #df005f; font-weight: bold;">ResourcePoolConfigBuilder</span>{}
_ = builder.<span style="color: #d75fd7; font-weight: bold;">SetName</span>(<span style="color: #2aa198;">"Thread pool resources"</span>)
_ = builder.<span style="color: #d75fd7; font-weight: bold;">SetMaxTotal</span>(12)
_ = builder.<span style="color: #d75fd7; font-weight: bold;">SetMaxIdle</span>(8)
_ = builder.<span style="color: #d75fd7; font-weight: bold;">SetMinIdle</span>(2)
<span style="color: #8787d7;">resourcePool</span>, <span style="color: #8787d7;">_</span> := builder.<span style="color: #d75fd7; font-weight: bold;">Build</span>()
fmt.<span style="color: #d75fd7; font-weight: bold;">Println</span>(resourcePool) 
</pre>
</div>
</div>
</div>
<div id="outline-container-org5d0a7e9" class="outline-3">
<h3 id="org5d0a7e9">自参考函数</h3>
<div class="outline-text-3" id="text-org5d0a7e9">
<p>
其实在 Golang 中对于创建类参数比较多的对象的时候，我们常见的做法是必填参数直接传递，可选参数通过传递可变的方法进行创建。<br>
</p>

<div class="org-src-container">
<pre class="src src-go"><span style="color: #268bd2; font-weight: bold;">type</span> <span style="color: #df005f; font-weight: bold;">ResourcePoolConfigOption</span> <span style="color: #268bd2; font-weight: bold;">struct</span> {
    maxTotal <span style="color: #df005f; font-weight: bold;">int</span>
    maxIdle  <span style="color: #df005f; font-weight: bold;">int</span>
    minIdle  <span style="color: #df005f; font-weight: bold;">int</span>
}

<span style="color: #268bd2; font-weight: bold;">type</span> <span style="color: #df005f; font-weight: bold;">ResourcePoolConfigOptFunc</span> <span style="color: #268bd2; font-weight: bold;">func</span>(<span style="color: #8787d7;">option</span> *<span style="color: #df005f; font-weight: bold;">ResourcePoolConfigOption</span>)

<span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">NewResourcePoolConfig &#20256;&#20837;&#19968;&#20010;&#20989;&#25968;&#65292;&#20351;&#29992;&#20989;&#25968;&#36827;&#34892;&#21021;&#22987;&#21270;</span>
<span style="color: #268bd2; font-weight: bold;">func</span> <span style="color: #d75fd7; font-weight: bold;">NewResourcePoolConfig</span>(<span style="color: #8787d7;">name</span> <span style="color: #df005f; font-weight: bold;">string</span>, <span style="color: #8787d7;">opts</span> ...<span style="color: #df005f; font-weight: bold;">ResourcePoolConfigOptFunc</span>) (*<span style="color: #df005f; font-weight: bold;">ResourcePoolConfig</span>, <span style="color: #df005f; font-weight: bold;">error</span>) {
    <span style="color: #268bd2; font-weight: bold;">if</span> name == <span style="color: #2aa198;">""</span> {
        <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #d75fd7;">nil</span>, fmt.<span style="color: #d75fd7; font-weight: bold;">Errorf</span>(<span style="color: #2aa198;">"name can not be empty"</span>)
    }

    <span style="color: #8787d7;">option</span> := &amp;<span style="color: #df005f; font-weight: bold;">ResourcePoolConfigOption</span>{
        <span style="color: #d75fd7;">maxTotal</span>: defaultMaxTotal,
        <span style="color: #d75fd7;">maxIdle</span>:  defaultMaxIdle,
        <span style="color: #d75fd7;">minIdle</span>:  defaultMinIdle,
    }

    <span style="color: #268bd2; font-weight: bold;">for</span> <span style="color: #8787d7;">_</span>, <span style="color: #8787d7;">opt</span> := <span style="color: #268bd2; font-weight: bold;">range</span> opts {
        <span style="color: #d75fd7; font-weight: bold;">opt</span>(option)
    }

    <span style="color: #268bd2; font-weight: bold;">if</span> option.maxTotal &lt; 0 || option.maxIdle &lt; 0 || option.minIdle &lt; 0 {
        <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #d75fd7;">nil</span>, fmt.<span style="color: #d75fd7; font-weight: bold;">Errorf</span>(<span style="color: #2aa198;">"args err, option: %v"</span>, option)
    }

    <span style="color: #268bd2; font-weight: bold;">if</span> option.maxTotal &lt; option.maxIdle || option.minIdle &gt; option.maxIdle {
        <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #d75fd7;">nil</span>, fmt.<span style="color: #d75fd7; font-weight: bold;">Errorf</span>(<span style="color: #2aa198;">"args err, option: %v"</span>, option)
    }

    <span style="color: #268bd2; font-weight: bold;">return</span> &amp;<span style="color: #df005f; font-weight: bold;">ResourcePoolConfig</span>{
        <span style="color: #d75fd7;">name</span>:     name,
        <span style="color: #d75fd7;">maxTotal</span>: option.maxTotal,
        <span style="color: #d75fd7;">maxIdle</span>:  option.maxIdle,
        <span style="color: #d75fd7;">minIdle</span>:  option.minIdle,
    }, <span style="color: #d75fd7;">nil</span>
} 
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-orgaddb710" class="outline-2">
<h2 id="orgaddb710">模式分析</h2>
<div class="outline-text-2" id="text-orgaddb710">
<p>
抽象建造者类中定义了产品的创建方法和返回方法;<br>
</p>

<p>
在客户端代码中，无须关心产品对象的具体组装过程，只需确定具体建造者的类型即可，建造者模式将复杂对象的构建与对象的表现分离开来，这样使得同样的构建过程可以创建出不同的表现。<br>
</p>
</div>
</div>
<div id="outline-container-orgdb98df9" class="outline-2">
<h2 id="orgdb98df9">建造者模式的优缺点</h2>
<div class="outline-text-2" id="text-orgdb98df9">
<ul class="org-ul">
<li>在建造者模式中， <b>客户端不必知道产品内部组成的细节，将产品本身与产品的创建过程解耦，使得相同的创建过程可以创建不同的产品对象</b> 。<br></li>
<li>每一个具体建造者都相对独立，而与其他的具体建造者无关，因此可以很方便地替换具体建造者或增加新的具体建造者， <b>用户使用不同的具体建造者即可得到不同的产品对象</b> 。<br></li>
<li><b>可以更加精细地控制产品的创建过程</b> 。将复杂产品的创建步骤分解在不同的方法中，使得创建过程更加清晰，也更方便使用程序来控制创建过程。<br></li>
<li>增加新的具体建造者无须修改原有类库的代码，指挥者类针对抽象建造者类编程，系统扩展方便，符合“开闭原则”。<br></li>
<li>建造者模式所创建的产品一般具有较多的共同点，其组成部分相似，如果产品之间的差异性很大，则不适合使用建造者模式，因此其使用范围受到一定的限制。<br></li>
<li>如果产品的内部变化复杂，可能会导致需要定义很多具体建造者类来实现这种变化，导致系统变得很庞大。<br></li>
</ul>
</div>
</div>
<div id="outline-container-orgafa1a61" class="outline-2">
<h2 id="orgafa1a61">适用环境</h2>
<div class="outline-text-2" id="text-orgafa1a61">
<ul class="org-ul">
<li>需要生成的产品对象有复杂的内部结构，这些产品对象通常包含多个成员属性。<br></li>
<li>需要生成的产品对象的属性相互依赖，需要指定其生成顺序。<br></li>
<li>对象的创建过程独立于创建该对象的类。在建造者模式中引入了指挥者类，将创建过程封装在指挥者类中，而不在建造者类中。<br></li>
<li>隔离复杂对象的创建和使用，并使得相同的创建过程可以创建不同的产品。<br></li>
</ul>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Author: L.M.haoran</p>
<p class="date">Created: 2022-07-09 Sat 16:09</p>
<p class="validation"><a href="http://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
