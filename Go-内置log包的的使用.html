<!DOCTYPE html>
<html lang="zh">
<head>
<!-- 2023-01-16 -->
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>内置log包的的使用</title>
<meta name="author" content="L.M.haoran" />
<meta name="description" content="Copyright © 2022, L.M.haoran, all rights reserved." />
<meta name="generator" content="Org Mode" />
<link rel="shortcut icon" href="images/favicon.ico" type="image/x-icon" />
           <link rel="stylesheet" href="static/css/org.css" type="text/css"  />
           <script type="module" src="static/js/main.js" defer></script>
</head>
<body>
<div id="content" class="content">
<h1 class="title">内置log包的的使用</h1>
<div id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#orga308523">如何简单使用 Log 包</a></li>
<li><a href="#orgb86ac9e">配置 Log</a>
<ul>
<li><a href="#org5c8349f">打印带有前缀的日志</a>
<ul>
<li><a href="#org4f8b56d">log.New 方法</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#org82a82b5">设置输出到文件</a></li>
</ul>
</div>
</div>

<div id="outline-container-orga308523" class="outline-2">
<h2 id="orga308523">如何简单使用 Log 包</h2>
<div class="outline-text-2" id="text-orga308523">
<div class="org-src-container">
<pre class="src src-go"><span style="color: #FF6188;">package</span> main

<span style="color: #FF6188;">import</span> <span style="color: #FFD866;">"log"</span>

<span style="color: #FF6188;">func</span> <span style="color: #A9DC76;">main</span>() {
    log.<span style="color: #A9DC76;">Println</span>(<span style="color: #FFD866;">"&#25171;&#21360;&#26085;&#24535;"</span>)
    <span style="color: #FCFCFA;">test</span> := <span style="color: #FFD866;">"Hello World!"</span>
    log.<span style="color: #A9DC76;">Printf</span>(<span style="color: #FFD866;">"%s &#25171;&#21360;&#26085;&#24535; ... \n"</span>, test)

    log.<span style="color: #A9DC76;">Fatalln</span>(<span style="color: #FFD866;">"&#25171;&#21360;&#26085;&#24535;&#65292;&#35302;&#21457; Fatal"</span>)

    log.<span style="color: #A9DC76;">Panicln</span>(<span style="color: #FFD866;">"&#25171;&#21360;&#26085;&#24535;&#65292;&#35302;&#21457; Panic"</span>)
}
</pre>
</div>

<p>
运行结果如下：<br>
</p>

<pre class="example" id="orgd1faac9">
2021/11/29 10:46:06 打印日志
2021/11/29 10:46:06 Hello World! 打印日志 ...
2021/11/29 10:46:06 打印日志，触发 Fatal
exit status 1
</pre>
</div>
</div>
<div id="outline-container-orgb86ac9e" class="outline-2">
<h2 id="orgb86ac9e">配置 Log</h2>
<div class="outline-text-2" id="text-orgb86ac9e">
</div>
<div id="outline-container-org5c8349f" class="outline-3">
<h3 id="org5c8349f">打印带有前缀的日志</h3>
<div class="outline-text-3" id="text-org5c8349f">
<div class="org-src-container">
<pre class="src src-go"><span style="color: #FF6188;">package</span> main

<span style="color: #FF6188;">import</span> (
    <span style="color: #FFD866;">"log"</span>
    <span style="color: #FFD866;">"os"</span>
)

<span style="color: #FF6188;">func</span> <span style="color: #A9DC76;">main</span>() {
    <span style="color: #FCFCFA;">logger</span> := log.<span style="color: #A9DC76;">New</span>(os.Stdout, <span style="color: #FFD866;">"&lt;++&gt;"</span>, log.Lshortfile|log.Ldate|log.Ltime)
    logger.<span style="color: #A9DC76;">Println</span>(<span style="color: #FFD866;">"&#25171;&#21360;&#24102;&#26377;&#21069;&#32512;&#30340;&#26085;&#24535; ... "</span>)
}
</pre>
</div>

<p>
运行结果如下：<br>
</p>

<pre class="example" id="org190bce6">
&lt;++&gt;2021/11/29 10:57:59 02-configLog.go:10: 打印带有前缀的日志 ...
</pre>
</div>
<div id="outline-container-org4f8b56d" class="outline-4">
<h4 id="org4f8b56d">log.New 方法</h4>
<div class="outline-text-4" id="text-org4f8b56d">
<p>
log.New 方法在 <verbatim>src/log/log.go</verbatim> 中。<br>
</p>

<div class="org-src-container">
<pre class="src src-go"><span style="color: #727072;">// </span><span style="color: #727072;">New creates a new Logger. The out variable sets the</span>
<span style="color: #727072;">// </span><span style="color: #727072;">destination to which log data will be written.</span>
<span style="color: #727072;">// </span><span style="color: #727072;">The prefix appears at the beginning of each generated log line, or</span>
<span style="color: #727072;">// </span><span style="color: #727072;">after the log header if the Lmsgprefix flag is provided.</span>
<span style="color: #727072;">// </span><span style="color: #727072;">The flag argument defines the logging properties.</span>
<span style="color: #FF6188;">func</span> <span style="color: #A9DC76;">New</span>(<span style="color: #FCFCFA;">out</span> <span style="color: #78DCE8;">io.Writer</span>, <span style="color: #FCFCFA;">prefix</span> <span style="color: #78DCE8;">string</span>, <span style="color: #FCFCFA;">flag</span> <span style="color: #78DCE8;">int</span>) *<span style="color: #78DCE8;">Logger</span> {
    <span style="color: #FF6188;">return</span> &amp;<span style="color: #78DCE8;">Logger</span>{<span style="color: #AB9DF2;">out</span>: out, <span style="color: #AB9DF2;">prefix</span>: prefix, <span style="color: #AB9DF2;">flag</span>: flag}
}
</pre>
</div>

<p>
里面调用了一个数据结构 <code>Logger</code> ：<br>
</p>

<div class="org-src-container">
<pre class="src src-go"><span style="color: #727072;">// </span><span style="color: #727072;">A Logger represents an active logging object that generates lines of</span>
<span style="color: #727072;">// </span><span style="color: #727072;">output to an io.Writer. Each logging operation makes a single call to</span>
<span style="color: #727072;">// </span><span style="color: #727072;">the Writer's Write method. A Logger can be used simultaneously from</span>
<span style="color: #727072;">// </span><span style="color: #727072;">multiple goroutines; it guarantees to serialize access to the Writer.</span>
<span style="color: #FF6188;">type</span> <span style="color: #78DCE8;">Logger</span> <span style="color: #FF6188;">struct</span> {
    mu     <span style="color: #78DCE8;">sync.Mutex</span> <span style="color: #727072;">// </span><span style="color: #727072;">ensures atomic writes; protects the following fields</span>
    prefix <span style="color: #78DCE8;">string</span>     <span style="color: #727072;">// </span><span style="color: #727072;">prefix on each line to identify the logger (but see Lmsgprefix)</span>
    flag   <span style="color: #78DCE8;">int</span>        <span style="color: #727072;">// </span><span style="color: #727072;">properties</span>
    out    <span style="color: #78DCE8;">io.Writer</span>  <span style="color: #727072;">// </span><span style="color: #727072;">destination for output</span>
    buf    []<span style="color: #78DCE8;">byte</span>     <span style="color: #727072;">// </span><span style="color: #727072;">for accumulating text to write</span>
}
</pre>
</div>

<p>
各个成员的含义：<br>
</p>

<dl class="org-dl">
<dt>mu sync.Mutex</dt><dd>锁，确保原子操作<br></dd>
<dt>prefix string</dt><dd>每一行日志的前缀<br></dd>
<dt>out io.Writer</dt><dd>输出位置，可以是文件，可以是标准输出<br></dd>
<dt>buf []byte</dt><dd>缓冲区的 buffer<br></dd>
<dt>flag int</dt><dd><p>
具体参数，有如下几种选择<br>
</p>

<div class="org-src-container">
<pre class="src src-go"><span style="color: #727072;">// </span><span style="color: #727072;">These flags define which text to prefix to each log entry generated by the Logger.</span>
<span style="color: #727072;">// </span><span style="color: #727072;">Bits are or'ed together to control what's printed.</span>
<span style="color: #727072;">// </span><span style="color: #727072;">With the exception of the Lmsgprefix flag, there is no</span>
<span style="color: #727072;">// </span><span style="color: #727072;">control over the order they appear (the order listed here)</span>
<span style="color: #727072;">// </span><span style="color: #727072;">or the format they present (as described in the comments).</span>
<span style="color: #727072;">// </span><span style="color: #727072;">The prefix is followed by a colon only when Llongfile or Lshortfile</span>
<span style="color: #727072;">// </span><span style="color: #727072;">is specified.</span>
<span style="color: #727072;">// </span><span style="color: #727072;">For example, flags Ldate | Ltime (or LstdFlags) produce,</span>
<span style="color: #727072;">//  </span><span style="color: #727072;">2009/01/23 01:23:23 message</span>
<span style="color: #727072;">// </span><span style="color: #727072;">while flags Ldate | Ltime | Lmicroseconds | Llongfile produce,</span>
<span style="color: #727072;">//  </span><span style="color: #727072;">2009/01/23 01:23:23.123123 /a/b/c/d.go:23: message</span>
<span style="color: #FF6188;">const</span> (
    <span style="color: #AB9DF2;">Ldate</span>         = 1 &lt;&lt; <span style="color: #AB9DF2;">iota</span>     <span style="color: #727072;">// </span><span style="color: #727072;">the date in the local time zone: 2009/01/23</span>
    <span style="color: #AB9DF2;">Ltime</span>                         <span style="color: #727072;">// </span><span style="color: #727072;">the time in the local time zone: 01:23:23</span>
    <span style="color: #AB9DF2;">Lmicroseconds</span>                 <span style="color: #727072;">// </span><span style="color: #727072;">microsecond resolution: 01:23:23.123123.  assumes Ltime.</span>
    <span style="color: #AB9DF2;">Llongfile</span>                     <span style="color: #727072;">// </span><span style="color: #727072;">full file name and line number: /a/b/c/d.go:23</span>
    <span style="color: #AB9DF2;">Lshortfile</span>                    <span style="color: #727072;">// </span><span style="color: #727072;">final file name element and line number: d.go:23. overrides Llongfile</span>
    <span style="color: #AB9DF2;">LUTC</span>                          <span style="color: #727072;">// </span><span style="color: #727072;">if Ldate or Ltime is set, use UTC rather than the local time zone</span>
    <span style="color: #AB9DF2;">Lmsgprefix</span>                    <span style="color: #727072;">// </span><span style="color: #727072;">move the "prefix" from the beginning of the line to before the message</span>
    <span style="color: #AB9DF2;">LstdFlags</span>     = Ldate | Ltime <span style="color: #727072;">// </span><span style="color: #727072;">initial values for the standard logger</span>
)
</pre>
</div>

<p>
源码的注释还是很清楚的，在上面的案例中，我们使用 <code>logger = log.New(os.Stdout, "&lt;++&gt;", log.Lshortfile|log.Ldate|log.Ltime)</code> 这句代码配置了一个新的 <code>logger</code> ，根据最后的配置，输出了日期、时间、具体内容。<br>
</p></dd>
</dl>
</div>
</div>
</div>
</div>
<div id="outline-container-org82a82b5" class="outline-2">
<h2 id="org82a82b5">设置输出到文件</h2>
<div class="outline-text-2" id="text-org82a82b5">
<div class="org-src-container">
<pre class="src src-go"><span style="color: #FF6188;">package</span> main

<span style="color: #FF6188;">import</span> (
    <span style="color: #FFD866;">"fmt"</span>
    <span style="color: #FFD866;">"log"</span>
    <span style="color: #FFD866;">"os"</span>
)

<span style="color: #FF6188;">func</span> <span style="color: #A9DC76;">main</span>() {
    <span style="color: #FCFCFA;">logFile</span>, <span style="color: #FCFCFA;">err</span> := os.<span style="color: #A9DC76;">OpenFile</span>(<span style="color: #FFD866;">"./log"</span>, os.O_CREATE|os.O_WRONLY|os.O_APPEND, 0644)
    <span style="color: #FF6188;">if</span> err != <span style="color: #AB9DF2;">nil</span> {
        fmt.<span style="color: #A9DC76;">Println</span>(<span style="color: #FFD866;">"os.OpenFile error :"</span>, err)
        <span style="color: #FF6188;">return</span>
    }
    <span style="color: #727072;">// </span><span style="color: #727072;">&#35774;&#32622;&#36755;&#20986;&#20301;&#32622;&#65292;&#37324;&#38754;&#26377;&#38145;&#36827;&#34892;&#25511;&#21046;</span>
    log.<span style="color: #A9DC76;">SetOutput</span>(logFile)

    <span style="color: #727072;">// </span><span style="color: #727072;">&#35774;&#32622;&#26085;&#24535;&#23646;&#24615;</span>
    log.<span style="color: #A9DC76;">SetFlags</span>(log.Llongfile|log.Ltime|log.Ldate)
    <span style="color: #727072;">// </span><span style="color: #727072;">&#25171;&#21360;&#26085;&#24535;</span>
    log.<span style="color: #A9DC76;">Println</span>(<span style="color: #FFD866;">"&#25171;&#21360;&#26032;&#26085;&#24535; ... "</span>)
    <span style="color: #727072;">// </span><span style="color: #727072;">&#25163;&#21160;&#35774;&#32622;&#21069;&#32512;</span>
    log.<span style="color: #A9DC76;">SetPrefix</span>(<span style="color: #FFD866;">"[&#37325;&#28857;]"</span>)
    log.<span style="color: #A9DC76;">Println</span>(<span style="color: #FFD866;">"&#25171;&#21360;&#37325;&#35201;&#26085;&#24535; ... "</span>)
}
</pre>
</div>

<pre class="example" id="orgf896e74">
2021/11/29 11:31:32 /home/haoran/haoran/Code/Language/15-Go/07-Log/03-outputToFile.go:21: 打印新日志 ...
[重点]2021/11/29 11:31:32 /home/haoran/haoran/Code/Language/15-Go/07-Log/03-outputToFile.go:24: 打印重要日志 ...
</pre>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Author: L.M.haoran</p>
<p class="date">Created: 2023-01-16</p>
<p class="validation"><a href="https://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
