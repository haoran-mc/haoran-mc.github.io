<!DOCTYPE html>
<html lang="zh">
<head>
<!-- 2021-11-04 Thu 21:00 -->
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>RPC与PROTOBUF结合使用</title>
<meta name="generator" content="Org mode">
<meta name="author" content="L.M.haoran">
<meta name="description" content="Copyright © 2021, L.M.haoran, all rights reserved."
>

                <link rel="stylesheet" href="static/css/org.css" type="text/css"  />
                <script type="module" src="static/js/main.js" defer></script>
                <link rel="shortcut icon" href="images/favicon.ico" type="image/x-icon" />
</head>
<body>
<div id="content">
<h1 class="title">RPC与PROTOBUF结合使用</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org9fb198d">引言</a></li>
<li><a href="#org31bfbcc">传输数据格式定义</a>
<ul>
<li><a href="#orgd4663fa">数据定义</a></li>
</ul>
</li>
<li><a href="#orgf21f202">服务定义</a></li>
<li><a href="#org3f54c73">RPC调用服务端实现</a></li>
<li><a href="#org9ffab7d">RPC调用客户端实现</a></li>
</ul>
</div>
</div>

<div id="outline-container-org9fb198d" class="outline-2">
<h2 id="org9fb198d">引言</h2>
<div class="outline-text-2" id="text-org9fb198d">
<p>
需求：假设在一个系统中，有订单模块（Order），其他模块想要实现RPC的远程工程调用，根据订单ID和时间戳可以获取订单信息。如果获取成功就返回相应的订单信息；如果查询不到返回失败信息。现在，我们来进行需求的编程实现。<br>
</p>
</div>
</div>
<div id="outline-container-org31bfbcc" class="outline-2">
<h2 id="org31bfbcc">传输数据格式定义</h2>
<div class="outline-text-2" id="text-org31bfbcc">
<ul class="org-ul">
<li><a href="Protobuf.html">Protobuf 回顾</a><br></li>
</ul>
</div>
<div id="outline-container-orgd4663fa" class="outline-3">
<h3 id="orgd4663fa">数据定义</h3>
<div class="outline-text-3" id="text-orgd4663fa">
<p>
根据需求，定义 message.proto 文件，详细定义如下：<br>
</p>
<div class="org-src-container">
<pre class="src src-go">syntax = <span style="color: #FC9F4E;">"proto3"</span>;

<span style="color: #BD93F9;">package</span> message;

option <span style="color: #AFAFAF;">go_package</span> = <span style="color: #FC9F4E;">"./;message"</span>;

<span style="color: #7c7c7c; font-style: italic;">// </span><span style="color: #7c7c7c; font-style: italic;">&#35746;&#21333;&#35831;&#27714;&#21442;&#25968;</span>
message <span style="color: #AFAFAF;">OrderRequest</span> {
    string <span style="color: #AFAFAF;">orderId</span> = <span style="color: #009F9F;">1</span>;
    int64 <span style="color: #AFAFAF;">timeStamp</span> = <span style="color: #009F9F;">2</span>;
}

<span style="color: #7c7c7c; font-style: italic;">// </span><span style="color: #7c7c7c; font-style: italic;">&#35746;&#21333;&#20449;&#24687;</span>
message <span style="color: #AFAFAF;">OrderInfo</span> {
    string <span style="color: #AFAFAF;">OrderId</span> = <span style="color: #009F9F;">1</span>;
    string <span style="color: #AFAFAF;">OrderName</span> = <span style="color: #009F9F;">2</span>;
    string <span style="color: #AFAFAF;">OrderStatus</span> = <span style="color: #009F9F;">3</span>;
}
</pre>
</div>

<p>
在上述文件中，定义了客户端发起RPC调用时的请求数据结构OrderRequest和服务端查询后返回的数据结构RederInfo。数据定义采用proto3语法实现，整个数据定义被定义在message包中。<br>
</p>
</div>
</div>
</div>
<div id="outline-container-orgf21f202" class="outline-2">
<h2 id="orgf21f202">服务定义</h2>
<div class="outline-text-2" id="text-orgf21f202">
<p>
使用 protobuf 定义的数据类型来传参、定义订单信息，根据传入的请求信息与订单信息比较，返回结果。<br>
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #BD93F9;">func</span> (<span style="color: #AFAFAF;">os</span> *<span style="color: #AFAFAF;">OrderService</span>) <span style="color: #AFAFAF;">GetOrderInfo</span>(<span style="color: #AFAFAF;">request</span> <span style="color: #AFAFAF;">message.OrderRequest</span>, <span style="color: #AFAFAF;">response</span> *<span style="color: #AFAFAF;">message.OrderInfo</span>) <span style="color: #AFAFAF;">error</span> {
    <span style="color: #AFAFAF;">orderMap</span> := <span style="color: #BD93F9;">map</span>[<span style="color: #AFAFAF;">string</span>]<span style="color: #AFAFAF;">message.OrderInfo</span> {
        <span style="color: #FC9F4E;">"202111040001"</span>: {<span style="color: #009F9F;">OrderId</span>: <span style="color: #FC9F4E;">"202111040001"</span>, <span style="color: #009F9F;">OrderName</span>: <span style="color: #FC9F4E;">"&#34915;&#26381;"</span>, <span style="color: #009F9F;">OrderStatus</span>: <span style="color: #FC9F4E;">"&#24050;&#20184;&#27454;"</span>},
            <span style="color: #FC9F4E;">"202111040002"</span>: {<span style="color: #009F9F;">OrderId</span>: <span style="color: #FC9F4E;">"202111040001"</span>, <span style="color: #009F9F;">OrderName</span>: <span style="color: #FC9F4E;">"&#38646;&#39135;"</span>, <span style="color: #009F9F;">OrderStatus</span>: <span style="color: #FC9F4E;">"&#24050;&#20184;&#27454;"</span>},
            <span style="color: #FC9F4E;">"202111040003"</span>: {<span style="color: #009F9F;">OrderId</span>: <span style="color: #FC9F4E;">"202111040001"</span>, <span style="color: #009F9F;">OrderName</span>: <span style="color: #FC9F4E;">"&#39135;&#21697;"</span>, <span style="color: #009F9F;">OrderStatus</span>: <span style="color: #FC9F4E;">"&#26410;&#20184;&#27454;"</span>},
        }

    <span style="color: #AFAFAF;">current</span> := time.<span style="color: #AFAFAF;">Now</span>().<span style="color: #AFAFAF;">Unix</span>()
    <span style="color: #BD93F9;">if</span> request.TimeStamp &gt; current {
        *response = <span style="color: #AFAFAF;">message.OrderInfo</span>{<span style="color: #009F9F;">OrderId</span>: <span style="color: #FC9F4E;">"0"</span>, <span style="color: #009F9F;">OrderName</span>: <span style="color: #FC9F4E;">""</span>, <span style="color: #009F9F;">OrderStatus</span>: <span style="color: #FC9F4E;">"&#35746;&#21333;&#20449;&#24687;&#24322;&#24120;"</span>}
    } <span style="color: #BD93F9;">else</span> {
        <span style="color: #AFAFAF;">result</span> := orderMap[request.OrderId]
        <span style="color: #BD93F9;">if</span> result.OrderId != <span style="color: #FC9F4E;">""</span> {
            *response = orderMap[request.OrderId]
        } <span style="color: #BD93F9;">else</span> {
            <span style="color: #BD93F9;">return</span> errors.<span style="color: #AFAFAF;">New</span>(<span style="color: #FC9F4E;">"server error"</span>)
        }
    }
    <span style="color: #BD93F9;">return</span> <span style="color: #009F9F;">nil</span>
}
</pre>
</div>
</div>
</div>
<div id="outline-container-org3f54c73" class="outline-2">
<h2 id="org3f54c73">RPC调用服务端实现</h2>
<div class="outline-text-2" id="text-org3f54c73">
<div class="org-src-container">
<pre class="src src-go"><span style="color: #AFAFAF;">orderService</span> := <span style="color: #AFAFAF;">new</span>(<span style="color: #AFAFAF;">OrderService</span>)

rpc.<span style="color: #AFAFAF;">Register</span>(orderService)   <span style="color: #7c7c7c; font-style: italic;">// </span><span style="color: #7c7c7c; font-style: italic;">&#27880;&#20876;</span>

rpc.<span style="color: #AFAFAF;">HandleHTTP</span>()   <span style="color: #7c7c7c; font-style: italic;">// </span><span style="color: #7c7c7c; font-style: italic;">&#30417;&#21548;</span>

<span style="color: #AFAFAF;">listen</span>, <span style="color: #AFAFAF;">err</span> := net.<span style="color: #AFAFAF;">Listen</span>(<span style="color: #FC9F4E;">"tcp"</span>, <span style="color: #FC9F4E;">":8081"</span>)
<span style="color: #BD93F9;">if</span> err != <span style="color: #009F9F;">nil</span> {
    <span style="color: #AFAFAF;">panic</span>(err.<span style="color: #AFAFAF;">Error</span>())
}
http.<span style="color: #AFAFAF;">Serve</span>(listen, <span style="color: #009F9F;">nil</span>)
</pre>
</div>

<p>
这里使用的是同步的方式。<br>
</p>
</div>
</div>
<div id="outline-container-org9ffab7d" class="outline-2">
<h2 id="org9ffab7d">RPC调用客户端实现</h2>
<div class="outline-text-2" id="text-org9ffab7d">
<div class="org-src-container">
<pre class="src src-go"><span style="color: #AFAFAF;">client</span>, <span style="color: #AFAFAF;">err</span> := rpc.<span style="color: #AFAFAF;">DialHTTP</span>(<span style="color: #FC9F4E;">"tcp"</span>, <span style="color: #FC9F4E;">":8081"</span>)
<span style="color: #BD93F9;">if</span> err != <span style="color: #009F9F;">nil</span> {
    <span style="color: #AFAFAF;">panic</span>(err.<span style="color: #AFAFAF;">Error</span>())
}

<span style="color: #AFAFAF;">timeStamp</span> := time.<span style="color: #AFAFAF;">Now</span>().<span style="color: #AFAFAF;">Unix</span>()
<span style="color: #AFAFAF;">request</span> := <span style="color: #AFAFAF;">message.OrderRequest</span>{<span style="color: #009F9F;">OrderId</span>: <span style="color: #FC9F4E;">"202111040001"</span>, <span style="color: #009F9F;">TimeStamp</span>: timeStamp}

<span style="color: #BD93F9;">var</span> <span style="color: #AFAFAF;">response</span> *<span style="color: #AFAFAF;">message.OrderInfo</span>
err = client.<span style="color: #AFAFAF;">Call</span>(<span style="color: #FC9F4E;">"OrderService.GetOrderInfo"</span>, request, &amp;response)
<span style="color: #BD93F9;">if</span> err != <span style="color: #009F9F;">nil</span> {
    <span style="color: #AFAFAF;">panic</span>(err.<span style="color: #AFAFAF;">Error</span>())
}
fmt.<span style="color: #AFAFAF;">Println</span>(*response)   <span style="color: #7c7c7c; font-style: italic;">// </span><span style="color: #7c7c7c; font-style: italic;">{{{} [] [] &lt;nil&gt;} 0 [] 202111040001 &#34915;&#26381; &#24050;&#20184;&#27454;}</span>
</pre>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="date">Date: 2021-10-30 22:10 Sat</p>
<p class="author">Author: L.M.haoran</p>
<p class="date">Created: 2021-11-04 Thu 21:00</p>
<p class="validation"><a href="https://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
