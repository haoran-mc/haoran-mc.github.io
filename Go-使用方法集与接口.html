<!DOCTYPE html>
<html lang="zh">
<head>
<!-- 2022-02-05 Sat 01:58 -->
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>使用方法集与接口</title>
<meta name="generator" content="Org mode">
<meta name="author" content="L.M.haoran">
<meta name="description" content="Copyright © 2022, L.M.haoran, all rights reserved."
>

                <link rel="stylesheet" href="static/css/org.css" type="text/css"  />
                <script type="module" src="static/js/main.js" defer></script>
                <link rel="shortcut icon" href="images/favicon.ico" type="image/x-icon" />
</head>
<body>
<div id="content">
<h1 class="title">使用方法集与接口</h1>
<p>
在 <a href="Go-方法.html">方法</a> 及例子 methodset1.go 中我们看到，作用于变量上的方法实际上是不区分变量到底是指针还是值的。当碰到接口类型值时，这会变得有点复杂，原因是接口变量中存储的具体值是不可寻址的，幸运的是，如果使用不当编译器会给出错误。考虑下面的程序：<br>
</p>

<p>
示例 11.5 methodset2.go：<br>
</p>

<div class="org-src-container">
<pre class="src src-go"><span style="color: #268bd2; font-weight: bold;">package</span> main

<span style="color: #268bd2; font-weight: bold;">import</span> (
        <span style="color: #2aa198;">"fmt"</span>
)

<span style="color: #268bd2; font-weight: bold;">type</span> <span style="color: #df005f; font-weight: bold;">List</span> []<span style="color: #df005f; font-weight: bold;">int</span>

<span style="color: #268bd2; font-weight: bold;">func</span> (<span style="color: #8787d7;">l</span> <span style="color: #df005f; font-weight: bold;">List</span>) <span style="color: #d75fd7; font-weight: bold;">Len</span>() <span style="color: #df005f; font-weight: bold;">int</span> {
        <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #268bd2;">len</span>(l)
}

<span style="color: #268bd2; font-weight: bold;">func</span> (<span style="color: #8787d7;">l</span> *<span style="color: #df005f; font-weight: bold;">List</span>) <span style="color: #d75fd7; font-weight: bold;">Append</span>(<span style="color: #8787d7;">val</span> <span style="color: #df005f; font-weight: bold;">int</span>) {
        *l = <span style="color: #268bd2;">append</span>(*l, val)
}

<span style="color: #268bd2; font-weight: bold;">type</span> <span style="color: #df005f; font-weight: bold;">Appender</span> <span style="color: #268bd2; font-weight: bold;">interface</span> {
        <span style="color: #d75fd7; font-weight: bold;">Append</span>(<span style="color: #df005f; font-weight: bold;">int</span>)
}

<span style="color: #268bd2; font-weight: bold;">func</span> <span style="color: #d75fd7; font-weight: bold;">CountInto</span>(<span style="color: #8787d7;">a</span> <span style="color: #df005f; font-weight: bold;">Appender</span>, <span style="color: #8787d7;">start</span>, <span style="color: #8787d7;">end</span> <span style="color: #df005f; font-weight: bold;">int</span>) {
        <span style="color: #268bd2; font-weight: bold;">for</span> <span style="color: #8787d7;">i</span> := start; i &lt;= end; i++ {
                a.<span style="color: #d75fd7; font-weight: bold;">Append</span>(i)
        }
}

<span style="color: #268bd2; font-weight: bold;">type</span> <span style="color: #df005f; font-weight: bold;">Lener</span> <span style="color: #268bd2; font-weight: bold;">interface</span> {
        <span style="color: #d75fd7; font-weight: bold;">Len</span>() <span style="color: #df005f; font-weight: bold;">int</span>
}

<span style="color: #268bd2; font-weight: bold;">func</span> <span style="color: #d75fd7; font-weight: bold;">LongEnough</span>(<span style="color: #8787d7;">l</span> <span style="color: #df005f; font-weight: bold;">Lener</span>) <span style="color: #df005f; font-weight: bold;">bool</span> {
        <span style="color: #268bd2; font-weight: bold;">return</span> l.<span style="color: #d75fd7; font-weight: bold;">Len</span>()*<span style="color: #d75fd7;">10</span> &gt; <span style="color: #d75fd7;">42</span>
}

<span style="color: #268bd2; font-weight: bold;">func</span> <span style="color: #d75fd7; font-weight: bold;">main</span>() {
        <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">A bare value</span>
        <span style="color: #268bd2; font-weight: bold;">var</span> <span style="color: #8787d7;">lst</span> <span style="color: #df005f; font-weight: bold;">List</span>
        <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">compiler error:</span>
        <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">cannot use lst (type List) as type Appender in argument to CountInto:</span>
        <span style="color: #008787; background-color: #262626;">//       </span><span style="color: #008787; background-color: #262626;">List does not implement Appender (Append method has pointer receiver)</span>
        <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">CountInto(lst, 1, 10)</span>
        <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7; font-weight: bold;">LongEnough</span>(lst) { <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">VALID:Identical receiver type</span>
                fmt.<span style="color: #d75fd7; font-weight: bold;">Printf</span>(<span style="color: #2aa198;">"- lst is long enough\n"</span>)
        }

        <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">A pointer value</span>
        <span style="color: #8787d7;">plst</span> := <span style="color: #268bd2;">new</span>(<span style="color: #df005f; font-weight: bold;">List</span>)
        <span style="color: #d75fd7; font-weight: bold;">CountInto</span>(plst, <span style="color: #d75fd7;">1</span>, <span style="color: #d75fd7;">10</span>) <span style="color: #008787; background-color: #262626;">//</span><span style="color: #008787; background-color: #262626;">VALID:Identical receiver type</span>
        <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7; font-weight: bold;">LongEnough</span>(plst) {
                <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">VALID: a *List can be dereferenced for the receiver</span>
                fmt.<span style="color: #d75fd7; font-weight: bold;">Printf</span>(<span style="color: #2aa198;">"- plst is long enough\n"</span>)
        }
}
</pre>
</div>

<p>
<b>讨论</b><br>
</p>

<p>
在 lst 上调用 CountInto 时会导致一个编译器错误，因为 CountInto 需要一个 Appender，而它的方法 Append 只定义在指针上。 在 lst 上调用 LongEnough 是可以的因为 ‘Len’ 定义在值上。<br>
</p>

<p>
在 plst 上调用 CountInto 是可以的，因为 CountInto 需要一个 Appender，并且它的方法 Append 定义在指针上。 在 plst 上调用 LongEnough 也是可以的，因为指针会被自动解引用。<br>
</p>

<p>
<b>总结</b><br>
</p>

<p>
在接口上调用方法时，必须有和方法定义时相同的接收者类型或者是可以从具体类型 P 直接可以辨识的：<br>
</p>

<ul class="org-ul">
<li>指针方法可以通过指针调用<br></li>
<li>值方法可以通过值调用<br></li>
<li>接收者是值的方法可以通过指针调用，因为指针会首先被解引用<br></li>
<li>接收者是指针的方法不可以通过值调用，因为存储在接口中的值没有地址<br></li>
<li>将一个值赋值给一个接口时，编译器会确保所有可能的接口方法都可以在此值上被调用，因此不正确的赋值在编译期就会失败。<br></li>
</ul>

<p>
<b>译注</b><br>
</p>

<p>
Go 语言规范定义了接口方法集的调用规则：<br>
</p>

<ul class="org-ul">
<li>类型 *T 的可调用方法集包含接受者为 *T 或 T 的所有方法集<br></li>
<li>类型 T 的可调用方法集包含接受者为 T 的所有方法<br></li>
<li>类型 T 的可调用方法集不包含接受者为 *T 的方法<br></li>
</ul>
</div>
<div id="postamble" class="status">
<p class="date">Date: 2022-02-05 01:02 Sat</p>
<p class="author">Author: L.M.haoran</p>
<p class="date">Created: 2022-02-05 Sat 01:58</p>
<p class="validation"><a href="https://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
